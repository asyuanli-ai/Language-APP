<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LingoFlow Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- PWA è¨­å®š -->
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF', gray: '#8E8E93', red: '#FF3B30', green: '#34C759' }
                    },
                    boxShadow: { 'ios': '0 2px 10px rgba(0,0,0,0.05)' }
                }
            }
        }
    </script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .active-scale:active { transform: scale(0.97); transition: 0.1s; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); }
        .popover { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        /* Android Chrome çš„ PWA å„ªåŒ– */
        body { overscroll-behavior-y: none; }
    </style>
</head>
<body class="bg-ios-bg text-slate-900 h-[100dvh] w-screen overflow-hidden flex flex-col font-sans">

    <!-- App å®¹å™¨ -->
    <div id="app" class="flex-1 relative overflow-hidden flex flex-col">
        
        <!-- é é¢ 1: ç·´ç¿’é¦–é  (Home) -->
        <div id="view-home" class="page-view flex-1 overflow-y-auto p-5 pb-24">
            <header class="mb-6 mt-4 flex justify-between items-center">
                <div>
                    <p class="text-ios-gray text-xs font-bold uppercase tracking-wider mb-1">AI Language Coach</p>
                    <h1 class="text-3xl font-bold text-slate-900">ä»Šæ—¥ç·´ç¿’</h1>
                </div>
                <!-- èªè¨€åˆ‡æ›å°æŒ‰éˆ• -->
                <button onclick="switchView('settings')" class="bg-white px-3 py-1.5 rounded-full text-xs font-bold shadow-sm text-ios-blue flex items-center gap-1">
                    <span id="current-lang-display">ğŸ‡¯ğŸ‡µ æ—¥èª</span> <i class="fa-solid fa-chevron-down"></i>
                </button>
            </header>

            <!-- è‡ªç”±å°è©±å¡ç‰‡ -->
            <div onclick="startChat('free')" class="bg-gradient-to-r from-blue-500 to-indigo-600 p-5 rounded-2xl shadow-lg text-white mb-6 active-scale cursor-pointer relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-xl mb-1">è‡ªç”±å°è©± (Free Talk)</h3>
                            <p class="text-blue-100 text-sm opacity-90">ä¸é™ä¸»é¡Œï¼Œåƒæœ‹å‹ä¸€æ¨£éš¨æ„èŠå¤©</p>
                        </div>
                        <i class="fa-solid fa-comments text-3xl opacity-80"></i>
                    </div>
                </div>
                <div class="absolute -right-4 -bottom-4 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
            </div>

            <!-- æƒ…å¢ƒåˆ—è¡¨ -->
            <h2 class="font-bold text-lg mb-3 ml-1 text-slate-700">æƒ…å¢ƒæ¨¡æ“¬</h2>
            <div class="space-y-3" id="scenario-list"></div>
        </div>

        <!-- é é¢ 2: èª²ç¨‹æ¨¡å¼ (Learn) -->
        <div id="view-learn" class="page-view hidden flex-1 overflow-y-auto p-5 pb-24">
            <header class="mb-6 mt-4">
                <p class="text-ios-gray text-xs font-bold uppercase tracking-wider mb-1">Curriculum</p>
                <h1 class="text-3xl font-bold">ä¸»é¡Œèª²ç¨‹</h1>
            </header>

            <div class="bg-ios-card p-4 rounded-xl shadow-sm mb-4 border border-slate-100">
                <p class="text-sm text-slate-600 mb-2">ç•¶å‰ç­‰ç´šï¼š<span id="learn-level-display" class="font-bold text-ios-blue">åˆç´š</span></p>
                <p class="text-xs text-ios-gray">é»æ“Šä¸‹æ–¹ä¸»é¡Œï¼ŒAI è€å¸«å°‡ç‚ºæ‚¨è¬›è§£ä¸¦å‡ºé¡Œç·´ç¿’ã€‚</p>
            </div>

            <div id="lesson-list" class="grid grid-cols-1 gap-3">
                <!-- èª²ç¨‹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é é¢ 3: å–®å­—æœ¬ (Vocab) -->
        <div id="view-vocab" class="page-view hidden flex-1 overflow-y-auto p-5 pb-24">
            <header class="mb-4 mt-4 flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold">å–®å­—ç­†è¨˜</h1>
                    <p class="text-ios-gray text-sm mt-1" id="vocab-subtitle">é¡¯ç¤ºç•¶å‰èªè¨€çš„å–®å­—</p>
                </div>
                <button onclick="startQuiz()" class="bg-ios-blue text-white px-4 py-2 rounded-full text-sm font-bold shadow-md active-scale">
                    <i class="fa-solid fa-graduation-cap mr-1"></i> æ¸¬é©—
                </button>
            </header>
            
            <!-- ç¯©é¸å™¨ -->
            <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                <button class="bg-slate-800 text-white px-3 py-1 rounded-full text-xs font-bold">å…¨éƒ¨</button>
                <button class="bg-white text-slate-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm">åè©</button>
                <button class="bg-white text-slate-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm">å‹•è©</button>
            </div>

            <div id="vocab-list" class="space-y-3 pb-10"></div>
        </div>

        <!-- é é¢ 4: èŠå¤©å®¤èˆ‡èª²ç¨‹å…§å®¹ (å…±ç”¨è¦–çª—) -->
        <div id="view-chat" class="page-view hidden flex-1 flex flex-col h-full absolute inset-0 bg-ios-bg z-50">
            <!-- å°èˆªåˆ— -->
            <div class="glass-nav pt-safe-top px-4 py-3 flex items-center justify-between shadow-sm z-30 h-16 shrink-0">
                <button onclick="backToMain()" class="text-ios-blue flex items-center gap-1 text-lg active-scale w-16">
                    <i class="fa-solid fa-chevron-left"></i> <span class="text-base font-medium">è¿”å›</span>
                </button>
                <div class="text-center flex-1">
                    <h2 id="chat-title" class="font-bold text-base truncate px-2">å°è©±</h2>
                    <p id="chat-subtitle" class="text-[10px] text-ios-gray">AI Coach</p>
                </div>
                <div class="w-16 flex justify-end">
                     <button onclick="toggleVocabDrawer()" class="text-ios-blue text-lg active-scale">
                        <i class="fa-solid fa-book-open"></i>
                    </button>
                </div>
            </div>

            <!-- ä»»å‹™æç¤ºæ¬„ (åƒ…åœ¨èŠå¤©é¡¯ç¤º) -->
            <div id="mission-banner" class="hidden bg-indigo-50 border-b border-indigo-100 p-2 px-4 flex justify-between items-center shrink-0">
                <span class="text-xs text-indigo-800 font-bold"><i class="fa-solid fa-bullseye mr-1"></i> æœ¬æ¬¡ç›®æ¨™è©å½™ï¼š</span>
                <span id="mission-words" class="text-xs text-indigo-600 font-mono"></span>
            </div>

            <!-- å…§å®¹æ²å‹•å€ -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-4">
                <!-- è¨Šæ¯æœƒæ’å…¥é€™è£¡ -->
            </div>

            <!-- åº•éƒ¨è¼¸å…¥å€ -->
            <div class="bg-white border-t border-slate-200 p-3 pb-safe-bottom w-full shrink-0 relative z-30" id="chat-input-area">
                
                <!-- ç³¾æ­£å»ºè­°æµ®çª— -->
                <div id="correction-area" class="hidden absolute bottom-full left-0 w-full bg-yellow-50 border-t border-yellow-200 p-3 shadow-sm rounded-t-xl mb-[1px] mx-2 w-[calc(100%-1rem)]">
                    <div class="flex justify-between items-start mb-1">
                         <span class="text-xs font-bold text-yellow-800"><i class="fa-solid fa-wand-magic-sparkles"></i> å»ºè­°ä¿®æ­£</span>
                         <button onclick="document.getElementById('correction-area').classList.add('hidden')" class="text-yellow-600"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="correction-text" class="text-sm"></div>
                </div>

                <div class="flex items-end gap-2">
                    <button id="mic-btn" onclick="toggleSpeech()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-lg active-scale transition-colors shrink-0">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <div class="flex-1 bg-slate-100 rounded-2xl px-4 py-2 min-h-[40px] flex items-center">
                        <textarea id="msg-input" rows="1" class="w-full bg-transparent border-none outline-none resize-none max-h-24 text-base pt-1 placeholder-slate-400" placeholder="è¼¸å…¥è¨Šæ¯..."></textarea>
                    </div>
                    <button onclick="sendUserMessage()" id="send-btn" class="w-10 h-10 rounded-full bg-ios-blue text-white flex items-center justify-center text-lg shadow-md active-scale shrink-0">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¿»è­¯æŒ‰éˆ• -->
        <button id="translate-btn" class="hidden fixed z-[100] bg-slate-800 text-white text-sm py-2 px-4 rounded-full shadow-xl popover flex items-center gap-2" onclick="handleTranslate()">
            <span>ç¿»è­¯</span> <i class="fa-solid fa-plus text-xs"></i>
        </button>

        <!-- è¨­å®šé é¢ (Settings) -->
        <!-- é é¢ 4: è¨­å®š (Settings View) - å·²æ›´æ–°å‚™ä»½åŠŸèƒ½ -->
<div id="view-settings" class="page-view hidden flex-1 overflow-y-auto p-5">
     <header class="mb-6 mt-4">
        <button onclick="switchView('home')" class="text-ios-blue mb-4 flex items-center gap-1"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
        <h1 class="text-3xl font-bold">è¨­å®š</h1>
    </header>
    
    <!-- ä¸€èˆ¬è¨­å®š -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
        <div class="p-4 border-b border-slate-100">
            <label class="block text-sm font-medium text-slate-500 mb-1">Gemini API Key</label>
            <input type="password" id="api-key-input" class="w-full text-base p-2 bg-slate-100 rounded-lg outline-none" placeholder="è²¼ä¸Š API Key">
            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-ios-blue mt-1 block">å–å¾—å…è²» API Key</a>
        </div>
        <div class="p-4 flex justify-between items-center border-b border-slate-100">
            <span class="text-base font-medium">å­¸ç¿’èªè¨€</span>
            <select id="target-lang" class="bg-transparent text-ios-blue font-bold outline-none text-right" onchange="updateLangDisplay()">
                <option value="Japanese">æ—¥æœ¬èª (Japanese)</option>
                <option value="English">English</option>
                <option value="Korean">í•œêµ­ì–´ (Korean)</option>
                <option value="French">FranÃ§ais (French)</option>
                <option value="Spanish">EspaÃ±ol (Spanish)</option>
            </select>
        </div>
        <div class="p-4 flex justify-between items-center">
            <span class="text-base font-medium">ç•¶å‰ç­‰ç´š</span>
            <select id="user-level" class="bg-transparent text-ios-blue font-bold outline-none text-right">
                <option value="Beginner">åˆç´š (Beginner)</option>
                <option value="Intermediate">ä¸­ç´š (Intermediate)</option>
                <option value="Advanced">é«˜ç´š (Advanced)</option>
            </select>
        </div>
    </div>
    <button onclick="saveSettings()" class="w-full bg-ios-blue text-white font-bold py-3 rounded-xl shadow-md active-scale mb-8">å„²å­˜è¨­å®š</button>

    <!-- æ–°å¢ï¼šè³‡æ–™å‚™ä»½èˆ‡é‚„åŸ -->
    <h2 class="text-lg font-bold mb-3 text-slate-700">è³‡æ–™ç®¡ç†</h2>
    <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6 p-4 space-y-3">
        <p class="text-xs text-slate-500 mb-2">æ›æ‰‹æ©Ÿå‰è«‹å…ˆå‚™ä»½ï¼Œåœ¨æ–°æ‰‹æ©Ÿä½¿ç”¨ã€Œé‚„åŸã€å³å¯è½‰ç§»è³‡æ–™ã€‚</p>
        
        <!-- åŒ¯å‡ºæŒ‰éˆ• -->
        <button onclick="exportData()" class="w-full border border-ios-blue text-ios-blue font-bold py-2.5 rounded-lg active-scale flex items-center justify-center gap-2">
            <i class="fa-solid fa-cloud-arrow-down"></i> å‚™ä»½è³‡æ–™ (ä¸‹è¼‰æª”æ¡ˆ)
        </button>

        <!-- åŒ¯å…¥æŒ‰éˆ•èˆ‡éš±è—çš„ input -->
        <button onclick="document.getElementById('file-input').click()" class="w-full border border-slate-300 text-slate-600 font-bold py-2.5 rounded-lg active-scale flex items-center justify-center gap-2">
            <i class="fa-solid fa-cloud-arrow-up"></i> é‚„åŸè³‡æ–™ (ä¸Šå‚³æª”æ¡ˆ)
        </button>
        <input type="file" id="file-input" class="hidden" accept=".json" onchange="importData(this)">
    </div>
    
    <div class="text-center text-xs text-slate-400 pb-10">
        LingoFlow Pro v1.2
    </div>
</div>

    <!-- åº•éƒ¨ Tab Bar -->
    <nav class="glass-nav h-[85px] flex justify-around items-start pt-3 absolute bottom-0 w-full z-40 pb-safe-bottom" id="tab-bar">
        <button onclick="switchView('home')" class="nav-btn active flex flex-col items-center gap-1 w-16 text-ios-blue transition-colors" data-target="home">
            <i class="fa-solid fa-house text-xl"></i>
            <span class="text-[10px] font-medium">ç·´ç¿’</span>
        </button>
        <button onclick="switchView('learn')" class="nav-btn flex flex-col items-center gap-1 w-16 text-ios-gray transition-colors" data-target="learn">
            <i class="fa-solid fa-book-open-reader text-xl"></i>
            <span class="text-[10px] font-medium">èª²ç¨‹</span>
        </button>
        <button onclick="switchView('vocab')" class="nav-btn flex flex-col items-center gap-1 w-16 text-ios-gray transition-colors" data-target="vocab">
            <i class="fa-solid fa-bookmark text-xl"></i>
            <span class="text-[10px] font-medium">å–®å­—</span>
        </button>
        <button onclick="switchView('settings')" class="nav-btn flex flex-col items-center gap-1 w-16 text-ios-gray transition-colors" data-target="settings">
            <i class="fa-solid fa-gear text-xl"></i>
            <span class="text-[10px] font-medium">è¨­å®š</span>
        </button>
    </nav>

    <script>
        // =========================================
        // 1. æ ¸å¿ƒè³‡æ–™èˆ‡è¨­å®š
        // =========================================
        const scenarios = [
            { id: 'cafe', title: 'å’–å•¡å»³é»é¤', icon: 'fa-mug-hot', color: 'bg-orange-100 text-orange-600', role: 'åº—å“¡' },
            { id: 'convenience', title: 'ä¾¿åˆ©å•†åº—', icon: 'fa-store', color: 'bg-green-100 text-green-600', role: 'åº—å“¡' },
            { id: 'airport', title: 'æ©Ÿå ´å…¥å¢ƒ', icon: 'fa-plane-arrival', color: 'bg-blue-100 text-blue-600', role: 'ç§»æ°‘å®˜' },
            { id: 'hotel', title: 'é£¯åº—å…¥ä½', icon: 'fa-hotel', color: 'bg-indigo-100 text-indigo-600', role: 'æ«ƒæª¯äººå“¡' },
            { id: 'date', title: 'æµªæ¼«ç´„æœƒ', icon: 'fa-heart', color: 'bg-pink-100 text-pink-600', role: 'ç´„æœƒå°è±¡' },
            { id: 'business', title: 'å•†å‹™æœƒè­°', icon: 'fa-briefcase', color: 'bg-slate-200 text-slate-700', role: 'å®¢æˆ¶' },
            { id: 'doctor', title: 'çœ‹é†«ç”Ÿ', icon: 'fa-user-doctor', color: 'bg-red-100 text-red-600', role: 'é†«ç”Ÿ' }
        ];

        const lessons = {
            'Japanese': ['è‡ªæˆ‘ä»‹ç´¹ (Self Intro)', 'åŸºç¤åŠ©è© (Particles)', 'å‹•è©è®ŠåŒ– (Te-form)', 'è³¼ç‰©ç”¨èª', 'æ•¬èªå…¥é–€'],
            'English': ['Present Simple', 'Past Tense', 'Ordering Food', 'Travel Phrases', 'Business Email'],
            'Korean': ['åŸºæœ¬å¥å‹', 'æ•¸å­—èˆ‡è¨ˆæ•¸', 'é»é¤', 'å•è·¯', 'åŠèªèˆ‡æ•¬èª'],
            'French': ['åŸºç¤ç™¼éŸ³', 'å‹•è© Ãªtre/avoir', 'å•å€™èª', 'é¤å»³ç”¨èª', 'å•è·¯']
        };

        const state = {
            apiKey: localStorage.getItem('gemini_api_key') || '',
            lang: localStorage.getItem('target_lang') || 'Japanese',
            level: localStorage.getItem('user_level') || 'Beginner',
            vocab: JSON.parse(localStorage.getItem('vocab_v2')) || [], // v2 æ”¯æ´èªè¨€åˆ†é¡
            chatHistory: [],
            currentMode: null, // 'chat', 'lesson'
            selection: null
        };

        // =========================================
        // 2. åˆå§‹åŒ–èˆ‡å°èˆª
        // =========================================
        document.addEventListener('DOMContentLoaded', () => {
            renderScenarios();
            updateLangDisplay();
            
            // æª¢æŸ¥ API Key
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('target-lang').value = state.lang;
            document.getElementById('user-level').value = state.level;
            
            if(!state.apiKey) switchView('settings');
            
            // ç›£è½ Tab åˆ‡æ›ä»¥åˆ·æ–°æ•¸æ“š
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if(btn.dataset.target === 'learn') renderLessons();
                    if(btn.dataset.target === 'vocab') renderVocab();
                });
            });
        });

        function switchView(viewId) {
            document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            const tabBar = document.getElementById('tab-bar');
            if (viewId === 'chat') tabBar.classList.add('hidden');
            else tabBar.classList.remove('hidden');

            // æ›´æ–° Tab ç‹€æ…‹
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewId) {
                    btn.classList.add('text-ios-blue');
                    btn.classList.remove('text-ios-gray');
                } else {
                    btn.classList.remove('text-ios-blue');
                    btn.classList.add('text-ios-gray');
                }
            });
        }

        function backToMain() {
            switchView('home');
            state.chatHistory = []; // é›¢é–‹èŠå¤©æ™‚æ¸…ç©º
        }

        function updateLangDisplay() {
            const map = { 'Japanese': 'ğŸ‡¯ğŸ‡µ æ—¥èª', 'English': 'ğŸ‡ºğŸ‡¸ è‹±èª', 'Korean': 'ğŸ‡°ğŸ‡· éŸ“èª', 'French': 'ğŸ‡«ğŸ‡· æ³•èª', 'Spanish': 'ğŸ‡ªğŸ‡¸ è¥¿èª' };
            document.getElementById('current-lang-display').innerText = map[state.lang] || state.lang;
            document.getElementById('learn-level-display').innerText = state.level;
        }

        function renderScenarios() {
            const list = document.getElementById('scenario-list');
            list.innerHTML = scenarios.map(s => `
                <div onclick="startChat('${s.id}')" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 active-scale cursor-pointer">
                    <div class="w-10 h-10 rounded-full ${s.color} flex items-center justify-center text-lg shrink-0">
                        <i class="fa-solid ${s.icon}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-base truncate">${s.title}</h3>
                        <p class="text-xs text-slate-500">è§’è‰²: ${s.role}</p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-300 text-sm"></i>
                </div>
            `).join('');
        }

        function renderLessons() {
            const list = document.getElementById('lesson-list');
            const topics = lessons[state.lang] || ['Basic Conversation', 'Grammar', 'Vocabulary'];
            
            list.innerHTML = topics.map(topic => `
                <div onclick="startLesson('${topic}')" class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 active-scale cursor-pointer relative overflow-hidden group">
                     <div class="flex justify-between items-center z-10 relative">
                        <div>
                            <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded mb-1 inline-block">Lesson</span>
                            <h3 class="font-bold text-lg text-slate-800">${topic}</h3>
                        </div>
                        <i class="fa-solid fa-play text-ios-blue bg-blue-50 w-8 h-8 flex items-center justify-center rounded-full"></i>
                     </div>
                </div>
            `).join('');
        }

        // =========================================
        // 3. èŠå¤© & æ•™å­¸æ ¸å¿ƒ (Gemini)
        // =========================================
        
        // éš¨æ©Ÿç”Ÿæˆç›®æ¨™å–®å­— (æ¨¡æ“¬)
        function getMissionWords() {
            // åœ¨çœŸå¯¦ç’°å¢ƒé€™æ‡‰è©²ç”± AI ç”Ÿæˆï¼Œé€™è£¡ç°¡å–®æ¨¡æ“¬
            const pool = {
                'Japanese': ['ç¾å‘³ã—ã„', 'æ™‚é–“', 'å ´æ‰€', 'ç´„æŸ', 'å¤§ä¸ˆå¤«'],
                'English': ['Opinion', 'Suggest', 'However', 'Basically', 'Appreciate']
            };
            const words = pool[state.lang] || ['Word A', 'Word B', 'Word C'];
            // éš¨æ©Ÿå– 3 å€‹
            return words.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        async function startChat(scenarioId) {
            if(!state.apiKey) return switchView('settings');

            state.currentMode = 'chat';
            state.chatHistory = [];
            switchView('chat');
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('correction-area').classList.add('hidden');
            document.getElementById('chat-input-area').classList.remove('hidden');

            const isFreeTalk = scenarioId === 'free';
            const scenario = scenarios.find(s => s.id === scenarioId);
            
            // UI è¨­å®š
            document.getElementById('chat-title').innerText = isFreeTalk ? 'è‡ªç”±å°è©±' : scenario.title;
            document.getElementById('chat-subtitle').innerText = isFreeTalk ? 'Free Talk' : `Role: ${scenario.role}`;
            
            // è¨­å®šç›®æ¨™å–®å­—
            const missions = getMissionWords();
            const missionEl = document.getElementById('mission-banner');
            const missionText = document.getElementById('mission-words');
            
            if(!isFreeTalk) {
                missionEl.classList.remove('hidden');
                missionText.innerText = missions.join(', ');
            } else {
                missionEl.classList.add('hidden');
            }

            // ç³»çµ±æç¤ºè©
            let systemPrompt = `
                Act as a language teacher/partner. 
                Language: ${state.targetLang}. User Level: ${state.level}.
                ${isFreeTalk ? 'Role: Friend. Chat casually.' : `Roleplay Scenario: ${scenario.title}. You are: ${scenario.role}.`}
                
                Instruction:
                1. Keep replies concise (1-3 sentences) suitable for a phone screen.
                2. If the user makes a mistake, append a JSON correction at the very end.
                3. ${!isFreeTalk ? `Try to naturally guide the user to use these words: ${missions.join(', ')}` : ''}
                
                Response Format:
                [Dialogue Text]
                |||
                { "original": "user input", "correction": "corrected version", "reason": "brief explanation" } (Only if error exists, else null)
            `;

            addMessage('ai', 'Thinking...');
            callGemini(systemPrompt, true);
        }

        async function startLesson(topic) {
            if(!state.apiKey) return switchView('settings');
            
            state.currentMode = 'lesson';
            state.chatHistory = [];
            switchView('chat');
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('mission-banner').classList.add('hidden');
            
            document.getElementById('chat-title').innerText = topic;
            document.getElementById('chat-subtitle').innerText = 'AI Tutor';

            const systemPrompt = `
                You are a professional language tutor teaching ${state.lang}.
                Topic: ${topic}. Target Level: ${state.level}.
                
                Please teach this concept clearly. 
                Structure:
                1. Explanation (Concise)
                2. Examples (with translations)
                3. A practice question for the user to try.
                
                Use Markdown for formatting.
            `;

            addMessage('ai', 'Preparing lesson...');
            callGemini(systemPrompt, true);
        }

        async function sendUserMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            addMessage('user', text);
            input.value = '';
            input.style.height = 'auto'; // Reset height
            document.getElementById('correction-area').classList.add('hidden');

            await callGemini(text);
        }

        async function callGemini(userText, isInit = false) {
            const loadingId = 'loading-' + Date.now();
            
            // å¦‚æœä¸æ˜¯åˆå§‹è¨Šæ¯ï¼Œé¡¯ç¤º user loading ç‹€æ…‹
            if(!isInit) {
                // addLoading(loadingId); 
                // é€™è£¡ç°¡åŒ–ï¼Œç›´æ¥æ”¹æœ€å¾Œä¸€å€‹ AI è¨Šæ¯ç‹€æ…‹ï¼Œæˆ–é¡¯ç¤ºä¸Šæ–¹ Loading
            }

            try {
                let contents = state.chatHistory.map(m => ({
                    role: m.role === 'user' ? 'user' : 'model',
                    parts: [{ text: m.text }]
                }));

                if(isInit) {
                    contents = [{ role: "user", parts: [{ text: userText + " (Start Now)" }] }];
                } else {
                    contents.push({ role: "user", parts: [{ text: userText }] });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: contents,
                        generationConfig: { maxOutputTokens: 600 }
                    })
                });

                const data = await response.json();
                
                if(data.error) throw new Error(data.error.message);
                
                const rawText = data.candidates[0].content.parts[0].text;
                const parts = rawText.split('|||');
                const dialogue = parts[0].trim();
                
                // è™•ç† UI
                if(isInit) {
                    document.getElementById('chat-container').innerHTML = ''; // æ¸…é™¤ "Thinking..."
                }

                addMessage('ai', dialogue);
                
                // å„²å­˜æ­·å² (åªå­˜å°è©±ï¼Œä¸å­˜ JSON)
                state.chatHistory.push({ role: 'user', text: userText }); // é€™è£¡è¦å°å¿ƒ isInit çš„ç‹€æ³ï¼Œç°¡åŒ–è™•ç†
                state.chatHistory.push({ role: 'model', text: dialogue });

                // è™•ç†ç³¾éŒ¯ (åƒ… Chat æ¨¡å¼)
                if(state.currentMode === 'chat' && parts.length > 1) {
                    try {
                        const json = JSON.parse(parts[1].trim());
                        if(json && json.correction) {
                            showCorrection(json);
                        }
                    } catch(e) {}
                }

            } catch (error) {
                addMessage('system', 'Error: ' + error.message);
            }
        }

        function showCorrection(data) {
            const area = document.getElementById('correction-area');
            const text = document.getElementById('correction-text');
            area.classList.remove('hidden');
            text.innerHTML = `
                <div class="flex flex-col">
                    <span class="line-through text-red-400 text-xs">${data.original}</span>
                    <span class="text-green-600 font-bold">${data.correction}</span>
                    <span class="text-xs text-slate-500 mt-1">${data.reason}</span>
                </div>
            `;
        }

        function addMessage(role, text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            const htmlText = marked.parse(text);

            if(role === 'user') {
                div.className = "flex justify-end animate-fade-in";
                div.innerHTML = `<div class="bg-ios-blue text-white px-4 py-2 rounded-2xl rounded-tr-sm max-w-[85%] text-base shadow-sm break-words">${text}</div>`;
            } else if(role === 'ai') {
                div.className = "flex justify-start animate-fade-in mb-4";
                div.innerHTML = `
                    <div class="flex items-end gap-2 max-w-[95%]">
                        <div class="w-6 h-6 rounded-full bg-gradient-to-tr from-purple-500 to-blue-500 shrink-0 flex items-center justify-center text-[10px] text-white font-bold mb-1">AI</div>
                        <div class="bg-white px-4 py-2 rounded-2xl rounded-tl-sm shadow-sm text-slate-800 text-base prose prose-sm max-w-none selectable-text">
                            ${htmlText}
                        </div>
                    </div>
                `;
            } else {
                div.className = "text-center text-xs text-red-400 my-2";
                div.innerText = text;
            }

            container.appendChild(div);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        // =========================================
        // 4. å–®å­—èˆ‡ç¿»è­¯ç³»çµ± (æ”¯æ´å¤šèªè¨€åˆ†é¡)
        // =========================================
        
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection();
            const btn = document.getElementById('translate-btn');
            const text = selection.toString().trim();

            if (!text || text.length > 30 || state.currentMode !== 'chat' && state.currentMode !== 'lesson') {
                btn.classList.add('hidden');
                return;
            }

            // å–å¾—æœ€å¾Œä¸€å€‹ Range (ç°¡å–®è™•ç†)
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            btn.style.top = `${rect.bottom + 10}px`;
            btn.style.left = `50%`; // æ‰‹æ©Ÿç‰ˆç›´æ¥ç½®ä¸­æ¯”è¼ƒå¥½æŒ‰
            btn.style.transform = `translateX(-50%)`;
            
            state.selection = text;
            btn.classList.remove('hidden');
        });

        async function handleTranslate() {
            const word = state.selection;
            const btn = document.getElementById('translate-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                // å‘¼å« API ç¿»è­¯
                const prompt = `Translate "${word}" to Traditional Chinese. Source Lang: ${state.lang}. 
                Output format JSON: {"meaning": "xxxx", "pos": "noun/verb"} only.`;
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const data = await response.json();
                let meaning = "ç¿»è­¯å¤±æ•—";
                let pos = "æœªçŸ¥";

                try {
                     const text = data.candidates[0].content.parts[0].text;
                     // å˜—è©¦æ¸…ç† JSON æ¨™è¨˜
                     const jsonText = text.replace(/```json|```/g, '').trim();
                     const res = JSON.parse(jsonText);
                     meaning = res.meaning;
                     pos = res.pos;
                } catch(e) {
                     meaning = data.candidates[0].content.parts[0].text;
                }

                // åŠ å…¥å–®å­—æœ¬ (åŒ…å«èªè¨€æ¨™è¨˜)
                const newItem = {
                    id: Date.now(),
                    word,
                    meaning,
                    pos,
                    lang: state.lang, // é—œéµï¼šå„²å­˜ç•¶å‰èªè¨€
                    date: new Date().toLocaleDateString()
                };

                state.vocab.unshift(newItem);
                localStorage.setItem('vocab_v2', JSON.stringify(state.vocab));
                
                btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²æ”¶è—';
                setTimeout(() => {
                    btn.classList.add('hidden');
                    btn.innerHTML = 'ç¿»è­¯';
                    window.getSelection().removeAllRanges();
                }, 1000);

            } catch(e) {
                alert('ç¿»è­¯éŒ¯èª¤');
                btn.classList.add('hidden');
            }
        }

        function renderVocab() {
            const list = document.getElementById('vocab-list');
            const subtitle = document.getElementById('vocab-subtitle');
            
            // ç¯©é¸ç•¶å‰èªè¨€
            const filtered = state.vocab.filter(v => v.lang === state.lang);
            
            subtitle.innerText = `${state.lang} æ”¶è—ï¼š${filtered.length} å€‹`;

            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 mt-10">å°šç„¡ ${state.lang} å–®å­—</div>`;
                return;
            }

            list.innerHTML = filtered.map(v => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center group">
                    <div>
                        <div class="flex items-baseline gap-2">
                            <h4 class="font-bold text-lg text-slate-800">${v.word}</h4>
                            <span class="text-[10px] bg-slate-100 px-1 rounded text-slate-500">${v.pos || ''}</span>
                        </div>
                        <p class="text-slate-600 text-sm">${v.meaning}</p>
                    </div>
                    <button onclick="deleteVocab(${v.id})" class="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-500">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function deleteVocab(id) {
            state.vocab = state.vocab.filter(v => v.id !== id);
            localStorage.setItem('vocab_v2', JSON.stringify(state.vocab));
            renderVocab();
        }

        // =========================================
        // 5. è¨­å®šèˆ‡å·¥å…·
        // =========================================
        function saveSettings() {
            const key = document.getElementById('api-key-input').value;
            const lang = document.getElementById('target-lang').value;
            const level = document.getElementById('user-level').value;

            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('target_lang', lang);
            localStorage.setItem('user_level', level);
            
            state.apiKey = key;
            state.lang = lang;
            state.level = level;

            updateLangDisplay();
            switchView('home');
        }

        // è¼¸å…¥æ¡†è‡ªå‹•é«˜åº¦
        document.getElementById('msg-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
        
        // èªéŸ³è¼¸å…¥ (ç°¡æ˜“ç‰ˆ)
        function toggleSpeech() {
            if (!('webkitSpeechRecognition' in window)) return alert('ä¸æ”¯æ´èªéŸ³è¼¸å…¥');
            
            const recognition = new webkitSpeechRecognition();
            // è¨­å®šèªè¨€ä»£ç¢¼
            const langMap = {'Japanese': 'ja-JP', 'English': 'en-US', 'Korean': 'ko-KR', 'French': 'fr-FR', 'Spanish': 'es-ES'};
            recognition.lang = langMap[state.lang];
            
            recognition.onstart = () => document.getElementById('mic-btn').classList.add('text-red-500', 'animate-pulse');
            recognition.onend = () => document.getElementById('mic-btn').classList.remove('text-red-500', 'animate-pulse');
            recognition.onresult = (e) => {
                document.getElementById('msg-input').value += e.results[0][0].transcript;
            };
            recognition.start();
        }
// =========================================
        // 6. è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ (æ–°å¢åŠŸèƒ½)
        // =========================================
        
        function exportData() {
            // 1. æº–å‚™è¦å‚™ä»½çš„è³‡æ–™
            const backupData = {
                version: '1.0',
                date: new Date().toLocaleString(),
                vocab: state.vocab, // å–®å­—æœ¬
                settings: {
                    apiKey: state.apiKey,
                    lang: state.lang,
                    level: state.level
                }
            };

            // 2. è½‰æ›æˆ JSON å­—ä¸²
            const dataStr = JSON.stringify(backupData, null, 2);
            
            // 3. å»ºç«‹ä¸‹è¼‰é€£çµ
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // æª”ååŒ…å«æ—¥æœŸï¼Œæ–¹ä¾¿è¾¨è­˜
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            a.href = url;
            a.download = `LingoFlow_Backup_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            
            // æ¸…ç†
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 0);
        }

        function importData(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    // ç°¡å–®çš„è³‡æ–™é©—è­‰
                    if (!json.vocab && !json.settings) {
                        throw new Error("æ ¼å¼éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è³‡æ–™");
                    }

                    // ç¢ºèªæç¤º
                    if (!confirm(`åµæ¸¬åˆ°å‚™ä»½æª” (æ—¥æœŸ: ${json.date || 'æœªçŸ¥'})\nå°‡æœƒè¦†è“‹ç›®å‰çš„è¨­å®šèˆ‡å–®å­—ï¼Œç¢ºå®šå—ï¼Ÿ`)) {
                        inputElement.value = ''; // æ¸…ç©ºé¸æ“‡
                        return;
                    }

                    // 1. é‚„åŸè¨­å®š
                    if (json.settings) {
                        if(json.settings.apiKey) localStorage.setItem('gemini_api_key', json.settings.apiKey);
                        if(json.settings.lang) localStorage.setItem('target_lang', json.settings.lang);
                        if(json.settings.level) localStorage.setItem('user_level', json.settings.level);
                    }

                    // 2. é‚„åŸå–®å­—æœ¬ (åˆä½µæ¨¡å¼ï¼šé¿å…é‡è¤‡ ID)
                    if (json.vocab && Array.isArray(json.vocab)) {
                        // é€™è£¡æ¡ç”¨ã€Œè¦†è“‹ã€ç­–ç•¥æ¯”è¼ƒå®‰å…¨ï¼Œç¢ºä¿è·Ÿå‚™ä»½æª”ä¸€è‡´
                        // å¦‚æœæƒ³è¦ã€Œåˆä½µã€ï¼Œé‚è¼¯æœƒæ¯”è¼ƒè¤‡é›œ
                        localStorage.setItem('vocab_v2', JSON.stringify(json.vocab));
                    }

                    alert("âœ… è³‡æ–™é‚„åŸæˆåŠŸï¼App å°‡è‡ªå‹•é‡æ–°æ•´ç†ã€‚");
                    location.reload(); // é‡æ–°æ•´ç†ç¶²é ä»¥å¥—ç”¨æ–°è¨­å®š

                } catch (err) {
                    alert("âŒ é‚„åŸå¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º\n" + err.message);
                }
            };

            reader.readAsText(file);
        }
    </script>
</body>
</html>