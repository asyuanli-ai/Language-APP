<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Learning</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="My Learning">
    <meta name="theme-color" content="#F2F2F7">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        ios: {
                            bg: '#F2F2F7',
                            card: '#FFFFFF',
                            blue: '#007AFF',
                            gray: '#8E8E93',
                            separator: '#C6C6C8',
                            green: '#34C759',
                            yellow: '#FFCC00',
                            red: '#FF3B30'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* iOS Tweaks */
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            background-color: #F2F2F7;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            height: 100vh;
            overflow: hidden;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Smooth Transition */
        .view-section {
            display: none;
            height: 100%;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }
        .view-section.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Selection Popup */
        #selection-popup {
            position: absolute;
            background: #1C1C1E;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            display: none;
            z-index: 50;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        #selection-popup::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            margin-left: -6px;
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: #1C1C1E transparent transparent transparent;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            margin-bottom: 8px;
            font-size: 16px;
            line-height: 1.4;
            position: relative;
        }
        .chat-user {
            background-color: #007AFF;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-ai {
            background-color: #E5E5EA;
            color: black;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        /* Correction Box */
        .correction-box {
            background-color: #FFF9C4;
            border-left: 4px solid #FBC02D;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            align-self: flex-start;
            max-width: 80%;
        }
    </style>
</head>
<body class="text-gray-900 select-none">

    <div id="selection-popup">ç¿»è­¯ä¸¦æ”¶è—</div>

    <div id="app" class="h-full flex flex-col relative">

        <header class="px-4 py-3 bg-white/80 backdrop-blur-xl border-b border-ios-separator flex justify-between items-center z-10 sticky top-0">
            <h1 id="page-title" class="text-2xl font-bold tracking-tight">Home</h1>
            <div id="header-actions">
                </div>
        </header>

        <main class="flex-1 overflow-hidden relative">
            
            <div id="view-home" class="view-section active overflow-y-auto pb-24 px-4 pt-4">
                <div class="bg-white rounded-xl p-1 mb-6 flex shadow-sm">
                    <button onclick="setLang('en')" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all lang-btn active-lang" data-lang="en">English</button>
                    <button onclick="setLang('jp')" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all lang-btn text-gray-400" data-lang="jp">æ—¥æœ¬èª</button>
                    <button onclick="setLang('kr')" class="flex-1 py-2 rounded-lg text-sm font-semibold transition-all lang-btn text-gray-400" data-lang="kr">í•œêµ­ì–´</button>
                </div>

                <div class="mb-6">
                    <h2 class="text-sm font-medium text-gray-500 mb-2 uppercase ml-2">é›£åº¦ç­‰ç´š (Level)</h2>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setLevel('beginner')" class="level-btn bg-white p-3 rounded-2xl border-2 border-transparent shadow-sm flex flex-col items-center gap-2 active-level ring-2 ring-ios-blue">
                            <i class="fa-solid fa-seedling text-ios-green text-xl"></i>
                            <span class="text-xs font-medium">åˆç´š</span>
                        </button>
                        <button onclick="setLevel('intermediate')" class="level-btn bg-white p-3 rounded-2xl border-2 border-transparent shadow-sm flex flex-col items-center gap-2 text-gray-400">
                            <i class="fa-solid fa-tree text-ios-blue text-xl"></i>
                            <span class="text-xs font-medium">ä¸­ç´š</span>
                        </button>
                        <button onclick="setLevel('advanced')" class="level-btn bg-white p-3 rounded-2xl border-2 border-transparent shadow-sm flex flex-col items-center gap-2 text-gray-400">
                            <i class="fa-solid fa-briefcase text-purple-500 text-xl"></i>
                            <span class="text-xs font-medium">é«˜ç´š</span>
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <button onclick="startChat('freetalk')" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 rounded-2xl shadow-lg flex items-center justify-between transform transition active:scale-95">
                        <div class="flex items-center gap-3">
                            <div class="bg-white/20 p-2 rounded-full"><i class="fa-solid fa-comments"></i></div>
                            <div class="text-left">
                                <div class="font-bold">è‡ªç”±å°è©± (Free Talk)</div>
                                <div class="text-xs opacity-80">ç„¡è§’è‰²é™åˆ¶ï¼Œéš¨æ„èŠèŠ</div>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right opacity-50"></i>
                    </button>
                </div>

                <div>
                    <h2 class="text-sm font-medium text-gray-500 mb-2 uppercase ml-2">æƒ…å¢ƒé¸æ“‡ (Scenarios)</h2>
                    <div id="scenario-list" class="grid grid-cols-2 gap-4">
                        </div>
                </div>
            </div>

            <div id="view-learn" class="view-section overflow-y-auto pb-24 px-4 pt-4">
                <h2 class="text-xl font-bold mb-4">å¯¦ç”¨ç”Ÿå­˜èª²ç¨‹</h2>
                <div id="course-list" class="space-y-4">
                    </div>
            </div>

            <div id="view-chat" class="view-section relative bg-gray-100">
                <div id="mission-bar" class="absolute top-0 left-0 w-full bg-yellow-100/90 backdrop-blur-md px-4 py-2 z-20 border-b border-yellow-200 text-xs flex justify-between items-center hidden">
                    <span class="font-bold text-yellow-800">ğŸ¯ ä»»å‹™å–®å­—ï¼š</span>
                    <div id="mission-words" class="flex gap-2 text-yellow-900 font-mono"></div>
                </div>

                <div id="chat-container" class="flex-1 overflow-y-auto p-4 pt-10 space-y-4 select-text">
                    <div class="text-center text-gray-400 text-sm mt-4">å°è©±å·²é–‹å§‹ï¼Œè«‹æŒ‰éº¥å…‹é¢¨æˆ–è¼¸å…¥æ–‡å­—</div>
                </div>

                <div class="bg-white/90 backdrop-blur-xl border-t border-gray-200 p-2 pb-safe">
                    <div id="typing-indicator" class="hidden text-xs text-gray-400 px-4 mb-2">AI æ­£åœ¨è¼¸å…¥...</div>
                    
                    <div class="flex items-end gap-2">
                        <button id="mic-btn" class="p-3 bg-gray-100 rounded-full text-gray-500 active:bg-red-100 active:text-red-500 transition">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                        <textarea id="chat-input" rows="1" class="flex-1 bg-gray-100 rounded-2xl px-4 py-3 text-base focus:outline-none focus:ring-2 focus:ring-ios-blue resize-none max-h-32" placeholder="è¼¸å…¥è¨Šæ¯..."></textarea>
                        <button onclick="sendMessage()" class="p-3 bg-ios-blue text-white rounded-full shadow-md disabled:opacity-50">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-vocab" class="view-section overflow-y-auto pb-24 px-4 pt-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">å–®å­—æœ¬</h2>
                    <button onclick="startQuiz()" class="text-ios-blue font-semibold text-sm">é–‹å§‹æ¸¬é©—</button>
                </div>
                
                <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
                    <span class="px-3 py-1 bg-ios-blue text-white rounded-full text-xs">å…¨éƒ¨</span>
                    <span class="px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-xs">EN</span>
                    <span class="px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-xs">JP</span>
                    <span class="px-3 py-1 bg-gray-200 text-gray-600 rounded-full text-xs">KR</span>
                </div>

                <div id="vocab-list" class="space-y-3">
                    <div class="text-center text-gray-400 mt-10">é•·æŒ‰å°è©±ä¸­çš„å–®å­—å¯åŠ å…¥æ­¤è™•</div>
                </div>
            </div>

            <div id="view-settings" class="view-section overflow-y-auto pb-24 px-4 pt-4">
                <div class="bg-white rounded-xl p-4 mb-6 shadow-sm">
                    <h3 class="font-bold mb-4 text-gray-800">Google Cloud API è¨­å®š</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-gray-500 font-bold">API KEY</label>
                            <input type="password" id="setting-api-key" class="w-full mt-1 p-3 bg-gray-100 rounded-lg text-sm font-mono focus:outline-ios-blue" placeholder="AIzaSy...">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 font-bold">PROJECT ID (å¿…å¡«)</label>
                            <input type="text" id="setting-project-id" class="w-full mt-1 p-3 bg-gray-100 rounded-lg text-sm font-mono focus:outline-ios-blue" placeholder="ä¾‹å¦‚: language-app-12345">
                            <p class="text-[10px] text-gray-400 mt-1">å¿…é ˆèˆ‡ Google Cloud Console ä¸­çš„å°ˆæ¡ˆ ID ä¸€è‡´ï¼Œå¦å‰‡æœƒå‡ºç¾ Permission Deniedã€‚</p>
                        </div>
                        <button onclick="saveSettings()" class="w-full bg-ios-blue text-white py-3 rounded-lg font-bold shadow-md active:opacity-90">å„²å­˜è¨­å®š</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl overflow-hidden shadow-sm mb-6">
                    <button onclick="exportData()" class="w-full flex justify-between items-center p-4 border-b border-gray-100 active:bg-gray-50">
                        <span>å‚™ä»½è³‡æ–™ (Export JSON)</span>
                        <i class="fa-solid fa-download text-gray-400"></i>
                    </button>
                    <label class="w-full flex justify-between items-center p-4 active:bg-gray-50 cursor-pointer">
                        <span>é‚„åŸè³‡æ–™ (Import JSON)</span>
                        <i class="fa-solid fa-upload text-gray-400"></i>
                        <input type="file" onchange="importData(this)" class="hidden" accept=".json">
                    </label>
                </div>
                
                <div class="text-center text-xs text-gray-400 mt-8">
                    My Learning v1.0 <br> PWA Ready
                </div>
            </div>

        </main>

        <nav class="h-[88px] bg-white/90 backdrop-blur-md border-t border-ios-separator flex justify-around items-start pt-2 z-50 fixed bottom-0 w-full pb-safe">
            <button onclick="switchTab('home')" class="nav-btn active-nav w-16 flex flex-col items-center gap-1 text-ios-blue transition" data-target="home">
                <i class="fa-solid fa-house text-xl"></i>
                <span class="text-[10px] font-medium">é¦–é </span>
            </button>
            <button onclick="switchTab('learn')" class="nav-btn w-16 flex flex-col items-center gap-1 text-gray-400 transition" data-target="learn">
                <i class="fa-solid fa-book-open text-xl"></i>
                <span class="text-[10px] font-medium">èª²ç¨‹</span>
            </button>
            <button onclick="switchTab('vocab')" class="nav-btn w-16 flex flex-col items-center gap-1 text-gray-400 transition" data-target="vocab">
                <i class="fa-solid fa-star text-xl"></i>
                <span class="text-[10px] font-medium">å–®å­—</span>
            </button>
            <button onclick="switchTab('settings')" class="nav-btn w-16 flex flex-col items-center gap-1 text-gray-400 transition" data-target="settings">
                <i class="fa-solid fa-gear text-xl"></i>
                <span class="text-[10px] font-medium">è¨­å®š</span>
            </button>
        </nav>

    </div>

    <script>
        // --- State Management ---
        const state = {
            lang: 'en', // en, jp, kr
            level: 'beginner', // beginner, intermediate, advanced
            apiKey: localStorage.getItem('ml_api_key') || '',
            projectId: localStorage.getItem('ml_project_id') || '',
            vocab: JSON.parse(localStorage.getItem('ml_vocab') || '[]'),
            currentChatRole: null,
            missionWords: []
        };

        // --- Data ---
        const scenarios = {
            en: [
                {id: 'cafe', label: 'Coffee Shop', role: 'Barista', prompt: 'You are a friendly Barista at a New York coffee shop.'},
                {id: 'airport', label: 'Immigration', role: 'Officer', prompt: 'You are a strict US Immigration Officer.'},
                {id: 'social', label: 'Party Small Talk', role: 'New Friend', prompt: 'You are a local meeting someone at a house party.'}
            ],
            jp: [
                {id: 'izakaya', label: 'å±…é…’å±‹ (Izakaya)', role: 'åº—å“¡', prompt: 'ã‚ãªãŸã¯æ—¥æœ¬ã®å±…é…’å±‹ã®å…ƒæ°—ãªåº—å“¡ã§ã™ã€‚æ•¬èªã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚'},
                {id: 'konbini', label: 'ã‚³ãƒ³ãƒ“ãƒ‹ (Konbini)', role: 'åº—å“¡', prompt: 'ã‚ãªãŸã¯æ—¥æœ¬ã®ã‚³ãƒ³ãƒ“ãƒ‹ã®åº—å“¡ã§ã™ã€‚'},
                {id: 'hotel', label: 'æ—…é¤¨ (Ryokan)', role: 'å¥³å°†', prompt: 'ã‚ãªãŸã¯ä¼çµ±çš„ãªæ—…é¤¨ã®å¥³å°†ã§ã™ã€‚éå¸¸ã«ä¸å¯§ãªè¨€è‘‰é£ã„ã‚’ã—ã¦ãã ã•ã„ã€‚'}
            ],
            kr: [
                {id: 'restaurant', label: 'é¤å»³ (Restaurant)', role: 'é˜¿å§¨', prompt: 'ä½ æ˜¯éŸ“åœ‹é¤å»³çš„ç†±æƒ…é˜¿å§¨ã€‚'},
                {id: 'taxi', label: 'è¨ˆç¨‹è»Š (Taxi)', role: 'å¸æ©Ÿ', prompt: 'ä½ æ˜¯é¦–çˆ¾çš„è¨ˆç¨‹è»Šå¸æ©Ÿï¼Œå–œæ­¡èŠå¤©ã€‚'},
                {id: 'kpop', label: 'ç²‰çµ²è¦‹é¢æœƒ', role: 'å¶åƒ', prompt: 'ä½ æ˜¯è‘—åçš„ K-Pop å¶åƒï¼Œæ­£åœ¨å’Œç²‰çµ²èªªè©±ã€‚'}
            ]
        };

        const courses = {
            beginner: [
                { title: 'é»é¤æ±‚ç”Ÿè¡“', desc: 'å­¸æœƒå¦‚ä½•é»å’–å•¡èˆ‡ä»˜æ¬¾', task: 'å®Œæˆä¸€æ¬¡é»é¤å°è©±' },
                { title: 'è‡ªæˆ‘ä»‹ç´¹', desc: 'åŸºæœ¬çš„å§“åã€åœ‹ç±èˆ‡èˆˆè¶£', task: 'å‘ AI ä»‹ç´¹ä½ è‡ªå·±' }
            ],
            intermediate: [
                { title: 'é€€è²¨èˆ‡å®¢è¨´', desc: 'è²·éŒ¯æ±è¥¿å¦‚ä½•æ›´æ›ï¼Ÿ', task: 'æˆåŠŸé€€æ‰ä¸€ä»¶è¡£æœ' },
                { title: 'çœ‹é†«ç”Ÿ', desc: 'æè¿°ç—‡ç‹€èˆ‡é ç´„æ™‚é–“', task: 'å‘é†«ç”Ÿæè¿°æ„Ÿå†’ç—‡ç‹€' }
            ],
            advanced: [
                { title: 'å•†å‹™è«‡åˆ¤', desc: 'åƒ¹æ ¼å”å•†èˆ‡åˆç´„è¨è«–', task: 'è«‡æˆä¸€ç­†ç”Ÿæ„' },
                { title: 'æ·±å±¤æ–‡åŒ–è¨è«–', desc: 'è¨è«–ç¤¾æœƒè­°é¡Œ', task: 'è¨è«–å°æ–¼å°‘å­åŒ–çš„çœ‹æ³•' }
            ]
        };

        // --- Core UI Functions ---
        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                if (el.id === `view-${tabId}`) setTimeout(() => el.classList.add('active'), 10);
            });
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.target === tabId) {
                    btn.classList.add('text-ios-blue', 'active-nav');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('text-ios-blue', 'active-nav');
                    btn.classList.add('text-gray-400');
                }
            });

            document.getElementById('page-title').innerText = 
                tabId === 'home' ? 'My Learning' : 
                tabId === 'learn' ? 'èª²ç¨‹æ¨¡å¼' : 
                tabId === 'chat' ? 'AI å°è©±' :
                tabId === 'vocab' ? 'å–®å­—æœ¬' : 'è¨­å®š';
                
            if(tabId === 'vocab') renderVocab();
        }

        function setLang(lang) {
            state.lang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                if(btn.dataset.lang === lang) {
                    btn.classList.add('active-lang', 'text-black', 'ring-2', 'ring-black/5');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.remove('active-lang', 'text-black', 'ring-2', 'ring-black/5');
                    btn.classList.add('text-gray-400');
                }
            });
            renderHome();
        }

        function setLevel(level) {
            state.level = level;
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active-level', 'ring-2', 'ring-ios-blue');
                btn.classList.add('text-gray-400');
            });
            // Just a visual hack for the current clicked one, usually passed by event but simplified here
            const map = {beginner:0, intermediate:1, advanced:2};
            const btns = document.querySelectorAll('.level-btn');
            btns[map[level]].classList.add('active-level', 'ring-2', 'ring-ios-blue');
            btns[map[level]].classList.remove('text-gray-400');
            
            renderHome(); // Re-render courses if displayed
        }

        function renderHome() {
            const list = document.getElementById('scenario-list');
            list.innerHTML = '';
            
            const currentScenarios = scenarios[state.lang] || scenarios['en'];
            
            currentScenarios.forEach(s => {
                list.innerHTML += `
                    <div onclick="startChat('${s.id}')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 active:scale-95 transition cursor-pointer">
                        <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center mb-3 text-ios-blue">
                            <i class="fa-solid fa-location-dot"></i>
                        </div>
                        <h3 class="font-bold text-gray-800">${s.label}</h3>
                        <p class="text-xs text-gray-400 mt-1">Role: ${s.role}</p>
                    </div>
                `;
            });

            // Update Learn Tab content as well based on level
            const learnList = document.getElementById('course-list');
            learnList.innerHTML = '';
            const currentCourses = courses[state.level] || courses['beginner'];
            currentCourses.forEach(c => {
                learnList.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl shadow-sm flex flex-col gap-2">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-gray-800">${c.title}</h3>
                            <span class="bg-gray-100 text-gray-500 text-[10px] px-2 py-1 rounded-full uppercase">${state.level}</span>
                        </div>
                        <p class="text-sm text-gray-500">${c.desc}</p>
                        <button onclick="startChat('course', '${c.title}')" class="mt-2 w-full py-2 bg-ios-bg text-ios-blue font-semibold rounded-lg text-sm">é–‹å§‹ç·´ç¿’</button>
                    </div>
                `;
            });
        }

        // --- Chat Logic & API ---
        async function startChat(scenarioId, courseTitle = null) {
            if (!state.apiKey || !state.projectId) {
                alert('è«‹å…ˆåˆ°è¨­å®šé é¢è¼¸å…¥ API Key å’Œ Project IDï¼');
                switchTab('settings');
                return;
            }

            // Generate Mission Words (Mock logic for now)
            const words = state.lang === 'en' ? ['recommend', 'delicious', 'price'] :
                          state.lang === 'jp' ? ['ãŠã™ã™ã‚', 'ç¾å‘³ã—ã„', 'ã„ãã‚‰'] :
                          ['ì¶”ì²œ', 'ë§›ìˆì–´ìš”', 'ì–¼ë§ˆ'];
            state.missionWords = words;
            document.getElementById('mission-words').innerHTML = words.map(w => `<span class="bg-white/50 px-1 rounded">${w}</span>`).join('');
            document.getElementById('mission-bar').classList.remove('hidden');

            // Set System Prompt
            let systemPrompt = "";
            if (scenarioId === 'freetalk') {
                systemPrompt = `You are a helpful language tutor for ${state.lang}. Level: ${state.level}. Do not roleplay, just chat freely.`;
            } else if (scenarioId === 'course') {
                systemPrompt = `You are a language tutor teaching: ${courseTitle}. Language: ${state.lang}. Level: ${state.level}. Guide the user to complete the task.`;
            } else {
                const sc = scenarios[state.lang].find(s => s.id === scenarioId);
                systemPrompt = sc ? sc.prompt : "You are a helpful assistant.";
                systemPrompt += ` Language: ${state.lang}. Level: ${state.level}.`;
            }

            // CRITICAL: Instruction for JSON Correction
            systemPrompt += `
            IMPORTANT RESPONSE FORMAT:
            You must ALWAYS respond with a JSON object. Do not output raw text.
            Schema:
            {
                "reply": "Your conversational response here (in target language)",
                "correction": null OR {
                    "original": "The user's sentence with error",
                    "fixed": "The corrected sentence",
                    "reason": "Brief explanation of grammar error in Traditional Chinese"
                }
            }
            If the user's grammar is perfect, set "correction" to null.
            If the user makes a mistake, provide the correction object.
            `;

            state.currentChatRole = systemPrompt;
            
            // UI Reset
            document.getElementById('chat-container').innerHTML = '';
            switchTab('chat');
            
            // Initial greeting
            appendMessage('ai', 'å°è©±æº–å‚™å°±ç·’ã€‚è«‹é–‹å§‹èªªè©±æˆ–è¼¸å…¥ã€‚', null);
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            appendMessage('user', text);
            input.value = '';
            
            // Loading state
            document.getElementById('typing-indicator').classList.remove('hidden');

            try {
                // Construct API Request
                // Using gemini-1.5-flash as requested
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`;
                
                const payload = {
                    contents: [
                        { role: "user", parts: [{ text: state.currentChatRole + "\n\nUser said: " + text }] }
                    ],
                    generationConfig: {
                        response_mime_type: "application/json" // Force JSON mode
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Goog-User-Project': state.projectId // KEY FIX
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error.message || 'API Connection Failed');
                }

                const data = await response.json();
                const aiRaw = data.candidates[0].content.parts[0].text;
                const aiJson = JSON.parse(aiRaw); // Parse the enforced JSON

                document.getElementById('typing-indicator').classList.add('hidden');
                
                // Speak the response (TTS)
                speak(aiJson.reply);

                // Render
                appendMessage('ai', aiJson.reply, aiJson.correction);

            } catch (error) {
                document.getElementById('typing-indicator').classList.add('hidden');
                appendMessage('ai', `âŒ éŒ¯èª¤: ${error.message}. è«‹æª¢æŸ¥ API Key æˆ– Project IDã€‚`, null);
            }
        }

        function appendMessage(role, text, correction = null) {
            const container = document.getElementById('chat-container');
            
            let html = '';
            
            if (role === 'ai' && correction) {
                html += `
                    <div class="correction-box">
                        <div class="font-bold text-yellow-700 text-xs mb-1"><i class="fa-solid fa-wrench"></i> AI å»ºè­°ä¿®æ­£</div>
                        <div class="line-through opacity-50 text-xs">${correction.original}</div>
                        <div class="font-bold text-yellow-900">${correction.fixed}</div>
                        <div class="text-[10px] mt-1 text-yellow-800">${correction.reason}</div>
                    </div>
                `;
            }

            html += `
                <div class="chat-bubble chat-${role} flex flex-col">
                    <span>${marked.parseInline(text)}</span>
                    ${role === 'ai' ? `<button onclick="speak('${text.replace(/'/g, "\\'")}')" class="absolute -right-8 top-2 text-gray-400"><i class="fa-solid fa-volume-high"></i></button>` : ''}
                </div>
            `;

            const div = document.createElement('div');
            div.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'}`;
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- Speech Features ---
        // TTS
        function speak(text) {
            if (!window.speechSynthesis) return;
            const u = new SpeechSynthesisUtterance(text);
            // Simple mapping
            u.lang = state.lang === 'jp' ? 'ja-JP' : state.lang === 'kr' ? 'ko-KR' : 'en-US';
            window.speechSynthesis.speak(u);
        }

        // STT (Web Speech API)
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            
            const micBtn = document.getElementById('mic-btn');
            
            micBtn.onclick = () => {
                recognition.lang = state.lang === 'jp' ? 'ja-JP' : state.lang === 'kr' ? 'ko-KR' : 'en-US';
                try {
                    recognition.start();
                    micBtn.classList.add('bg-red-100', 'text-red-500', 'animate-pulse');
                } catch(e) {
                    recognition.stop();
                    micBtn.classList.remove('bg-red-100', 'text-red-500', 'animate-pulse');
                }
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('chat-input').value = text;
                sendMessage(); // Auto send on speak end
            };

            recognition.onend = () => {
                micBtn.classList.remove('bg-red-100', 'text-red-500', 'animate-pulse');
            };
        } else {
            document.getElementById('mic-btn').style.display = 'none';
        }

        // --- Selection & Translation Logic ---
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection();
            const popup = document.getElementById('selection-popup');
            
            if (!selection.toString().trim() || document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT') {
                popup.style.display = 'none';
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();

            if (rect.width > 0) {
                popup.style.display = 'block';
                popup.style.top = `${rect.top - 40}px`;
                popup.style.left = `${rect.left + (rect.width / 2) - 50}px`;
                
                // Handle click
                popup.onclick = async (e) => {
                    e.stopPropagation();
                    const text = selection.toString();
                    popup.innerText = "ç¿»è­¯ä¸­...";
                    
                    try {
                        // Quick Translation API Call
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`;
                        const payload = {
                            contents: [{ role: "user", parts: [{ text: `Translate this specific word/phrase to Traditional Chinese (Taiwan). Only output the translation, nothing else: "${text}"` }] }]
                        };
                        
                        const res = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-Goog-User-Project': state.projectId },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        const translation = data.candidates[0].content.parts[0].text.trim();
                        
                        // Save
                        state.vocab.push({
                            id: Date.now(),
                            original: text,
                            trans: translation,
                            lang: state.lang,
                            date: new Date().toLocaleDateString()
                        });
                        localStorage.setItem('ml_vocab', JSON.stringify(state.vocab));
                        
                        popup.innerText = "å·²æ”¶è—!";
                        setTimeout(() => popup.style.display = 'none', 1000);
                        setTimeout(() => popup.innerText = "ç¿»è­¯ä¸¦æ”¶è—", 1200);
                        
                    } catch(err) {
                        popup.innerText = "å¤±æ•—";
                    }
                };
            }
        });

        // --- Settings & Vocab ---
        function saveSettings() {
            const key = document.getElementById('setting-api-key').value;
            const pid = document.getElementById('setting-project-id').value;
            
            if(key && pid) {
                state.apiKey = key;
                state.projectId = pid;
                localStorage.setItem('ml_api_key', key);
                localStorage.setItem('ml_project_id', pid);
                alert('è¨­å®šå·²å„²å­˜ï¼');
                switchTab('home');
            } else {
                alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
            }
        }

        // Initialize Settings Inputs
        document.getElementById('setting-api-key').value = state.apiKey;
        document.getElementById('setting-project-id').value = state.projectId;

        function renderVocab() {
            const list = document.getElementById('vocab-list');
            list.innerHTML = '';
            
            if (state.vocab.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 mt-10">å°šç„¡å–®å­—ï¼Œè«‹åœ¨å°è©±ä¸­é¸å–æ–‡å­—æ”¶è—</div>';
                return;
            }

            [...state.vocab].reverse().forEach(v => {
                list.innerHTML += `
                    <div class="bg-white p-3 rounded-xl shadow-sm flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">${v.original}</div>
                            <div class="text-sm text-gray-500">${v.trans}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-400">${v.lang.toUpperCase()}</span>
                            <button onclick="deleteVocab(${v.id})" class="text-red-400"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        function deleteVocab(id) {
            state.vocab = state.vocab.filter(v => v.id !== id);
            localStorage.setItem('ml_vocab', JSON.stringify(state.vocab));
            renderVocab();
        }

        function startQuiz() {
            if (state.vocab.length < 3) {
                alert("å–®å­—é‡ä¸è¶³ï¼Œè«‹å…ˆæ”¶è—è‡³å°‘ 3 å€‹å–®å­—");
                return;
            }
            const q = state.vocab[Math.floor(Math.random() * state.vocab.length)];
            const ans = prompt(`ã€æ¸¬é©—ã€‘\nè«‹è¼¸å…¥ "${q.trans}" çš„åŸæ–‡ (${q.lang})`);
            if (ans && ans.toLowerCase().trim() === q.original.toLowerCase().trim()) {
                alert("ç­”å°äº†ï¼ğŸ‰");
            } else {
                alert(`ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š${q.original}`);
            }
        }

        // Backup / Restore
        function exportData() {
            const dataStr = JSON.stringify(state);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'mylearning_backup.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loaded = JSON.parse(e.target.result);
                    // Merge vital data
                    if(loaded.vocab) {
                        state.vocab = loaded.vocab;
                        localStorage.setItem('ml_vocab', JSON.stringify(state.vocab));
                    }
                    if(loaded.apiKey) localStorage.setItem('ml_api_key', loaded.apiKey);
                    if(loaded.projectId) localStorage.setItem('ml_project_id', loaded.projectId);
                    alert("è³‡æ–™é‚„åŸæˆåŠŸï¼Œå°‡é‡æ–°æ•´ç†");
                    location.reload();
                } catch(err) {
                    alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                }
            };
            reader.readAsText(file);
        }

        // --- Init ---
        // Check if settings needed
        if (!state.apiKey) switchTab('settings');
        else renderHome();

    </script>
</body>
</html>