<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Learning 3.0</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF', green: '#34C759', yellow: '#FFCC00', red: '#FF3B30', gray: '#8E8E93' }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* iOS Layout Fixes */
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            background-color: #F2F2F7;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Views Transition */
        .view-section {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px; /* Space for tab bar */
        }
        .view-section.active { display: flex; animation: fadeIn 0.2s ease-out; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Chat Specifics */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 10px; font-size: 16px; line-height: 1.5; position: relative; word-wrap: break-word; }
        .chat-user { background-color: #007AFF; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-ai { background-color: #E5E5EA; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
        
        /* Correction Box */
        .correction-box { background-color: #FFF9C4; border-left: 4px solid #FBC02D; padding: 8px; margin-bottom: 8px; border-radius: 8px; font-size: 14px; align-self: flex-start; max-width: 85%; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 60; display: none; justify-content: center; items-center: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 24px; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="text-gray-900">

    <div id="app" class="w-full h-full flex flex-col relative">

        <header class="px-4 py-3 bg-white/90 backdrop-blur-md border-b border-gray-200 z-10 flex justify-between items-center pt-safe-top">
            <h1 id="page-title" class="text-xl font-bold tracking-tight">My Learning</h1>
            <div id="header-status" class="text-[10px] font-mono text-gray-400">Ready</div>
        </header>

        <main class="flex-1 relative overflow-hidden flex flex-col">
            
            <div id="view-home" class="view-section active p-4">
                
                <div class="bg-gray-200/50 p-1 rounded-xl flex mb-6">
                    <button onclick="setLang('en')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all lang-btn" data-lang="en">English</button>
                    <button onclick="setLang('jp')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all lang-btn" data-lang="jp">日本語</button>
                    <button onclick="setLang('kr')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all lang-btn" data-lang="kr">한국어</button>
                </div>

                <div class="mb-6">
                    <button onclick="startFreeTalk()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-5 rounded-2xl shadow-lg shadow-blue-200 flex items-center justify-between active:scale-95 transition-transform">
                        <div class="flex items-center gap-4">
                            <div class="bg-white/20 h-12 w-12 rounded-full flex items-center justify-center text-xl">
                                <i class="fa-solid fa-comments"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-bold text-lg">Free Chat (自由對話)</div>
                                <div class="text-xs opacity-90">不限角色與情境，隨意練習</div>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right opacity-60"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <h2 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider ml-1">目前等級 (Current Level)</h2>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setLevel('beginner')" class="level-btn bg-white p-3 rounded-xl border border-transparent shadow-sm flex flex-col items-center gap-1 transition-all active:scale-95">
                            <i class="fa-solid fa-seedling text-ios-green mb-1"></i>
                            <span class="text-xs font-bold" id="lbl-beg">初級</span>
                        </button>
                        <button onclick="setLevel('intermediate')" class="level-btn bg-white p-3 rounded-xl border border-transparent shadow-sm flex flex-col items-center gap-1 transition-all active:scale-95">
                            <i class="fa-solid fa-layer-group text-ios-blue mb-1"></i>
                            <span class="text-xs font-bold" id="lbl-int">中級</span>
                        </button>
                        <button onclick="setLevel('advanced')" class="level-btn bg-white p-3 rounded-xl border border-transparent shadow-sm flex flex-col items-center gap-1 transition-all active:scale-95">
                            <i class="fa-solid fa-briefcase text-purple-600 mb-1"></i>
                            <span class="text-xs font-bold" id="lbl-adv">高級</span>
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider ml-1">情境選擇 (Scenarios)</h2>
                    <div id="scenario-list" class="grid grid-cols-1 gap-3">
                        </div>
                </div>
            </div>

            <div id="view-learn" class="view-section p-4">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-2xl font-bold">主題課程</h2>
                    <span id="course-level-badge" class="px-2 py-1 bg-ios-blue text-white text-[10px] rounded-md font-bold">CEFR A1</span>
                </div>
                <div id="course-list" class="space-y-4"></div>
            </div>

            <div id="view-chat" class="view-section relative bg-gray-100 !pb-0 !flex-col !h-full !overflow-hidden">
                <div class="bg-yellow-50 border-b border-yellow-200 px-4 py-2 flex justify-between items-center shadow-sm z-20 shrink-0">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-bullseye text-yellow-600"></i>
                        <span class="text-xs font-bold text-yellow-800">任務：</span>
                    </div>
                    <div id="mission-words" class="flex gap-2 text-xs font-mono text-yellow-900 font-bold"></div>
                </div>

                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 w-full">
                    <div class="text-center text-gray-400 text-xs mt-4">AI 正在連線中...</div>
                </div>

                <div class="bg-white border-t border-gray-200 p-3 pb-safe-bottom w-full shrink-0 z-30 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                    <div id="typing-indicator" class="hidden text-[10px] text-gray-400 mb-2 pl-2 flex items-center gap-1">
                        <span class="animate-pulse">●</span> AI 正在輸入...
                    </div>
                    <div class="flex items-end gap-2">
                        <button id="mic-btn" class="h-10 w-10 shrink-0 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center active:bg-red-100 active:text-red-500 transition-colors">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                        <div class="flex-1 bg-gray-100 rounded-2xl flex items-center px-3 py-1">
                            <textarea id="chat-input" rows="1" class="w-full bg-transparent border-none focus:ring-0 px-0 py-2 text-base resize-none max-h-24" placeholder="輸入訊息..."></textarea>
                        </div>
                        <button onclick="sendMessage()" class="h-10 w-10 shrink-0 rounded-full bg-ios-blue text-white shadow-md flex items-center justify-center active:scale-95 transition-transform">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-vocab" class="view-section p-4">
                <h2 class="text-2xl font-bold mb-4">單字本</h2>
                <div id="vocab-list" class="space-y-3"></div>
            </div>

            <div id="view-settings" class="view-section p-4">
                <div class="bg-white rounded-xl p-5 shadow-sm space-y-4">
                    <h3 class="font-bold border-b pb-2">API 連線設定</h3>
                    <div class="bg-blue-50 p-3 rounded text-xs text-blue-700">
                        <i class="fa-solid fa-circle-info mr-1"></i>
                        系統將自動偵測可用的模型，不再寫死 gemini-1.5-flash，以避免 404 錯誤。
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">API KEY</label>
                        <input type="password" id="api-key" class="w-full bg-gray-100 p-2 rounded mt-1 font-mono text-sm">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">PROJECT ID (選填，若有權限錯誤請填寫)</label>
                        <input type="text" id="project-id" class="w-full bg-gray-100 p-2 rounded mt-1 font-mono text-sm" placeholder="例如: my-project-123">
                    </div>
                    <button onclick="saveSettings()" class="w-full bg-ios-blue text-white py-3 rounded-lg font-bold">儲存並重啟</button>
                    <button onclick="clearCache()" class="w-full bg-gray-200 text-gray-600 py-2 rounded-lg font-bold text-sm">清除快取模型</button>
                </div>
            </div>
        </main>

        <nav class="h-[80px] bg-white border-t border-gray-200 flex justify-around items-start pt-2 z-50 shrink-0 pb-safe-bottom">
            <button onclick="switchTab('home')" class="nav-btn active-nav flex flex-col items-center w-16 gap-1" data-target="home">
                <i class="fa-solid fa-house text-xl mb-0.5"></i>
                <span class="text-[10px]">首頁</span>
            </button>
            <button onclick="switchTab('learn')" class="nav-btn flex flex-col items-center w-16 gap-1 text-gray-400" data-target="learn">
                <i class="fa-solid fa-graduation-cap text-xl mb-0.5"></i>
                <span class="text-[10px]">課程</span>
            </button>
            <button onclick="switchTab('vocab')" class="nav-btn flex flex-col items-center w-16 gap-1 text-gray-400" data-target="vocab">
                <i class="fa-solid fa-book text-xl mb-0.5"></i>
                <span class="text-[10px]">單字</span>
            </button>
            <button onclick="switchTab('settings')" class="nav-btn flex flex-col items-center w-16 gap-1 text-gray-400" data-target="settings">
                <i class="fa-solid fa-gear text-xl mb-0.5"></i>
                <span class="text-[10px]">設定</span>
            </button>
        </nav>

        <div id="role-modal" class="modal-overlay flex">
            <div class="modal-content">
                <h3 class="text-xl font-bold mb-4 text-center">確認對話角色</h3>
                <div class="bg-blue-50 p-3 rounded-lg mb-3">
                    <span class="text-xs text-blue-500 font-bold block mb-1">您將扮演 (USER)</span>
                    <div id="modal-user-role" class="font-bold text-gray-800"></div>
                </div>
                <div class="bg-gray-100 p-3 rounded-lg mb-6">
                    <span class="text-xs text-gray-500 font-bold block mb-1">AI 將扮演</span>
                    <div id="modal-ai-role" class="font-bold text-gray-800"></div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeModal()" class="flex-1 py-3 bg-gray-200 rounded-xl font-bold text-gray-600">取消</button>
                    <button onclick="confirmStartChat()" class="flex-1 py-3 bg-ios-blue text-white rounded-xl font-bold shadow-lg">開始對話</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- STATE & CONFIG ---
        const state = {
            lang: localStorage.getItem('ml_lang') || 'en',
            level: localStorage.getItem('ml_level') || 'beginner',
            apiKey: localStorage.getItem('ml_api_key') || '',
            projectId: localStorage.getItem('ml_project_id') || '',
            cachedModelName: localStorage.getItem('ml_cached_model') || null, // Stores discovered model
            vocab: JSON.parse(localStorage.getItem('ml_vocab') || '[]'),
            pendingScenario: null,
            missionWords: [],
            currentSystemPrompt: ''
        };

        const levelStandards = {
            en: { beginner: 'A1-A2', intermediate: 'B1-B2', advanced: 'C1-C2' },
            jp: { beginner: 'N4-N5', intermediate: 'N2-N3', advanced: 'N1' },
            kr: { beginner: 'TOPIK 1-2', intermediate: 'TOPIK 3-4', advanced: 'TOPIK 5-6' }
        };

        // Mission Words (Expanded)
        const missionDatabase = {
            en: {
                beginner: ['Hello', 'Price', 'Name', 'Time', 'Food', 'Water'],
                intermediate: ['Schedule', 'Refund', 'Suggest', 'Available', 'Reason'],
                advanced: ['Negotiate', 'Strategy', 'Economy', 'Perspective', 'Analyze']
            },
            jp: {
                beginner: ['すみません', 'いくら', '駅', '水', 'これ', '好き'],
                intermediate: ['予約', '変更', '理由', '説明', '相談', '経験'],
                advanced: ['経済', '交渉', '影響', '提供', '検討', '責任']
            },
            kr: {
                beginner: ['안녕하세요', '얼마', '김치', '어디', '주세요', '이름'],
                intermediate: ['예약', '환불', '추천', '이유', '가능', '확인'],
                advanced: ['경제', '협상', '문화', '해결', '책임', '영향']
            }
        };

        const scenarios = {
            en: [
                { id: 'cafe', title: 'Coffee Shop', userRole: 'Customer', aiRole: 'Barista', icon: 'fa-mug-hot', color: 'bg-orange-100 text-orange-600' },
                { id: 'immi', title: 'Immigration', userRole: 'Traveler', aiRole: 'Border Officer', icon: 'fa-passport', color: 'bg-blue-100 text-blue-600' }
            ],
            jp: [
                { id: 'izakaya', title: '居酒屋 (Izakaya)', userRole: '客', aiRole: '店員', icon: 'fa-beer-mug-empty', color: 'bg-yellow-100 text-yellow-700' },
                { id: 'hotel', title: '旅館 Check-in', userRole: '宿泊客', aiRole: '女将', icon: 'fa-hotel', color: 'bg-purple-100 text-purple-600' }
            ],
            kr: [
                { id: 'taxi', title: '搭計程車', userRole: '乘客', aiRole: '司機', icon: 'fa-taxi', color: 'bg-yellow-100 text-yellow-600' }
            ]
        };

        // --- CORE FUNCTIONS: MODEL DISCOVERY ---

        // 1. Discover Model: The "Auto-Discovery" Logic
        async function discoverModel() {
            if (state.cachedModelName) {
                console.log("Using cached model:", state.cachedModelName);
                return state.cachedModelName;
            }

            console.log("Discovering available models...");
            document.getElementById('header-status').innerText = "Finding Model...";

            try {
                // Step 1: List Models
                const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${state.apiKey}`;
                const res = await fetch(url);
                
                if (!res.ok) {
                    throw new Error(`API Key Error (${res.status}). Please check settings.`);
                }

                const data = await res.json();
                
                // Step 2: Filter for 'generateContent' support
                // Priority: Prefer 'gemini-1.5-flash' -> 'gemini-pro' -> Any Gemini
                let selectedModel = data.models.find(m => 
                    m.name.includes('gemini-1.5-flash') && m.supportedGenerationMethods.includes('generateContent')
                );

                if (!selectedModel) {
                    selectedModel = data.models.find(m => 
                        m.name.includes('gemini-pro') && m.supportedGenerationMethods.includes('generateContent')
                    );
                }

                if (!selectedModel) {
                    selectedModel = data.models.find(m => 
                        m.supportedGenerationMethods.includes('generateContent')
                    );
                }

                if (!selectedModel) {
                    throw new Error("No chat models found for this API Key.");
                }

                // Step 3: Cache and Return
                console.log("Model Found:", selectedModel.name);
                state.cachedModelName = selectedModel.name;
                localStorage.setItem('ml_cached_model', selectedModel.name);
                document.getElementById('header-status').innerText = "Model Ready";
                return selectedModel.name;

            } catch (e) {
                console.error(e);
                document.getElementById('header-status').innerText = "Connection Error";
                throw e;
            }
        }

        function clearCache() {
            localStorage.removeItem('ml_cached_model');
            state.cachedModelName = null;
            alert("模型快取已清除，下次對話將重新偵測。");
        }

        // --- UI & NAVIGATION ---

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('api-key').value = state.apiKey;
            document.getElementById('project-id').value = state.projectId;
            
            if(!state.apiKey) switchTab('settings');
            else {
                updateLevelLabels();
                renderHome();
            }

            // Auto-resize input
            const tx = document.getElementById('chat-input');
            tx.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        });

        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.target === tabId;
                btn.classList.toggle('active-nav', isActive);
                btn.classList.toggle('text-ios-blue', isActive);
                btn.classList.toggle('text-gray-400', !isActive);
            });

            if (tabId === 'learn') renderCourses(); // Simplified for demo
        }

        function setLang(lang) {
            state.lang = lang;
            localStorage.setItem('ml_lang', lang);
            updateLevelLabels();
            renderHome();
        }

        function setLevel(lvl) {
            state.level = lvl;
            localStorage.setItem('ml_level', lvl);
            updateLevelLabels();
        }

        function updateLevelLabels() {
            ['beginner', 'intermediate', 'advanced'].forEach(l => {
                const isSel = state.level === l;
                const btn = document.querySelector(`.level-btn[onclick="setLevel('${l}')"]`);
                if(isSel) {
                    btn.classList.add('ring-2', 'ring-ios-blue', 'bg-blue-50');
                    btn.classList.remove('bg-white');
                } else {
                    btn.classList.remove('ring-2', 'ring-ios-blue', 'bg-blue-50');
                    btn.classList.add('bg-white');
                }
            });
            document.querySelectorAll('.lang-btn').forEach(b => {
                if(b.dataset.lang === state.lang) b.classList.add('bg-white', 'shadow-sm', 'text-black');
                else b.classList.remove('bg-white', 'shadow-sm', 'text-black');
            });
        }

        function renderHome() {
            const list = document.getElementById('scenario-list');
            list.innerHTML = '';
            const data = scenarios[state.lang] || scenarios['en'];
            data.forEach(s => {
                list.innerHTML += `
                    <div onclick="openRoleModal('${s.id}')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 active:bg-gray-50 transition cursor-pointer">
                        <div class="h-12 w-12 rounded-full ${s.color} flex items-center justify-center text-xl shrink-0">
                            <i class="fa-solid ${s.icon}"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800">${s.title}</h3>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-500">You: ${s.userRole}</span>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300"></i>
                    </div>
                `;
            });
        }

        // --- CHAT LOGIC ---

        function startFreeTalk() {
            // Free Talk Setup: No specific role, just helpful tutor
            const prompt = `
                Roleplay Setup:
                - Type: Free Conversation / Chat
                - Language: ${state.lang}
                - Level: ${levelStandards[state.lang][state.level]}
                - Your Role: A helpful, friendly native speaker friend.
                
                Instructions:
                - Chat naturally about any topic.
                - Correct mistakes gently.
            `;
            initChat(prompt, "Hello! I'm ready to chat. What's on your mind?");
        }

        function openRoleModal(scenarioId) {
            const data = (scenarios[state.lang] || scenarios['en']).find(s => s.id === scenarioId);
            state.pendingScenario = data;
            document.getElementById('modal-user-role').innerText = data.userRole;
            document.getElementById('modal-ai-role').innerText = data.aiRole;
            document.getElementById('role-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('role-modal').style.display = 'none';
        }

        function confirmStartChat() {
            closeModal();
            const s = state.pendingScenario;
            const prompt = `
                Roleplay Setup:
                - Language: ${state.lang}
                - Level: ${state.level}
                - Your Role (AI): ${s.aiRole}
                - My Role (User): ${s.userRole}
                - Scenario: ${s.title}
                
                Instructions:
                Stay in character. Adjust vocabulary to level.
            `;
            initChat(prompt, `(Scene: ${s.title}) ${s.aiRole} is looking at you...`);
        }

        function initChat(systemInstructions, welcomeText) {
            switchTab('chat');
            
            // Random Mission Words
            const pool = missionDatabase[state.lang][state.level] || missionDatabase['en']['beginner'];
            state.missionWords = [...pool].sort(() => 0.5 - Math.random()).slice(0, 3);
            document.getElementById('mission-words').innerHTML = state.missionWords.map(w => `<span class="bg-white/80 px-2 py-0.5 rounded-md border border-yellow-300 shadow-sm">${w}</span>`).join('');

            document.getElementById('chat-container').innerHTML = '';
            
            state.currentSystemPrompt = systemInstructions + `
                CRITICAL OUTPUT FORMAT:
                Respond ONLY in JSON:
                {
                    "reply": "Response in target language",
                    "correction": null OR { "original": "...", "fixed": "...", "reason": "Explanation in Traditional Chinese" }
                }
            `;
            
            addBubble('ai', welcomeText, null);
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            addBubble('user', text);
            input.value = '';
            input.style.height = 'auto';

            const indicator = document.getElementById('typing-indicator');
            indicator.classList.remove('hidden');

            try {
                // *** 核心修改：使用動態偵測的模型名稱 ***
                const modelName = await discoverModel(); 
                
                // Construct URL with discovered name
                const url = `https://generativelanguage.googleapis.com/v1beta/${modelName}:generateContent?key=${state.apiKey}`;
                
                const payload = {
                    contents: [
                        { role: "user", parts: [{ text: state.currentSystemPrompt + "\n\nUser input: " + text }] }
                    ],
                    generationConfig: { response_mime_type: "application/json" }
                };

                const headers = { 'Content-Type': 'application/json' };
                if (state.projectId) headers['X-Goog-User-Project'] = state.projectId;

                const res = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                if(!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error?.message || "API Request Failed");
                }

                const data = await res.json();
                const aiJson = JSON.parse(data.candidates[0].content.parts[0].text);

                indicator.classList.add('hidden');
                addBubble('ai', aiJson.reply, aiJson.correction);
                speak(aiJson.reply);

            } catch(e) {
                indicator.classList.add('hidden');
                addBubble('ai', `❌ 連線錯誤: ${e.message}`);
                // Clear cache if it might be a model issue
                if(e.message.includes('404') || e.message.includes('not found')) {
                    localStorage.removeItem('ml_cached_model');
                    state.cachedModelName = null;
                }
            }
        }

        function addBubble(role, text, correction) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'}`;
            
            let html = '';
            if(correction) {
                html += `
                    <div class="correction-box">
                        <div class="flex items-center gap-1 font-bold text-yellow-800 text-xs mb-1">
                            <i class="fa-solid fa-wrench"></i> 修正建議
                        </div>
                        <div class="line-through text-gray-500 text-xs">${correction.original}</div>
                        <div class="text-green-700 font-bold text-sm">${correction.fixed}</div>
                        <div class="text-[10px] text-gray-500 mt-1">${correction.reason}</div>
                    </div>
                `;
            }
            html += `<div class="chat-bubble chat-${role}">${marked.parseInline(text)}</div>`;
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- UTILS ---
        function saveSettings() {
            const k = document.getElementById('api-key').value;
            const p = document.getElementById('project-id').value;
            if(k) {
                state.apiKey = k;
                state.projectId = p;
                localStorage.setItem('ml_api_key', k);
                localStorage.setItem('ml_project_id', p);
                // Clear model cache when settings change to re-discover
                localStorage.removeItem('ml_cached_model');
                state.cachedModelName = null;
                alert("設定已儲存 (模型快取已重置)");
                location.reload();
            }
        }

        function speak(text) {
            if(!window.speechSynthesis) return;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = state.lang === 'jp' ? 'ja-JP' : state.lang === 'kr' ? 'ko-KR' : 'en-US';
            window.speechSynthesis.speak(u);
        }

        // Render dummy courses
        function renderCourses() {
            document.getElementById('course-list').innerHTML = '<div class="text-gray-400 text-center mt-10">課程內容載入中...</div>';
        }

    </script>
</body>
</html>