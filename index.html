<!DOCTYPE html>
<html lang="zh-TW" translate="no">
<head>
    <meta charset="UTF-8">
    <!-- é˜²æ­¢ç€è¦½å™¨è‡ªå‹•ç¿»è­¯å°è‡´ API ç¶²å€éŒ¯èª¤ -->
    <meta name="google" content="notranslate"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LingoFlow Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- PWA è¨­å®š -->
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF', gray: '#8E8E93', red: '#FF3B30', green: '#34C759', yellow: '#FFCC00' }
                    },
                    boxShadow: { 'ios': '0 2px 10px rgba(0,0,0,0.05)' }
                }
            }
        }
    </script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .active-scale:active { transform: scale(0.97); transition: 0.1s; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); }
        .popover { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        /* è¼‰å…¥å‹•ç•« */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-ios-bg text-slate-900 h-[100dvh] w-screen overflow-hidden flex flex-col font-sans">

    <!-- App å®¹å™¨ -->
    <div id="app" class="flex-1 relative overflow-hidden flex flex-col">
        
        <!-- é é¢ 1: ç·´ç¿’é¦–é  (Home) -->
        <div id="view-home" class="page-view flex-1 overflow-y-auto p-5 pb-24">
            <header class="mb-6 mt-4 flex justify-between items-center">
                <div>
                    <p class="text-ios-gray text-xs font-bold uppercase tracking-wider mb-1">AI Language Coach</p>
                    <h1 class="text-3xl font-bold text-slate-900">ä»Šæ—¥ç·´ç¿’</h1>
                </div>
                <!-- èªè¨€èˆ‡ç­‰ç´šé¡¯ç¤º -->
                <div class="flex flex-col items-end gap-1">
                    <button onclick="switchView('settings')" class="bg-white px-3 py-1 rounded-full text-xs font-bold shadow-sm text-ios-blue flex items-center gap-1">
                        <span id="current-lang-display">ğŸ‡¯ğŸ‡µ æ—¥èª</span>
                    </button>
                    <span id="home-level-badge" class="text-[10px] bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full font-bold">åˆç´š (N5-N3)</span>
                </div>
            </header>

            <!-- è‡ªç”±å°è©±å¡ç‰‡ -->
            <div onclick="startChat('free')" class="bg-gradient-to-r from-blue-500 to-indigo-600 p-5 rounded-2xl shadow-lg text-white mb-6 active-scale cursor-pointer relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-xl mb-1">è‡ªç”±å°è©± (Free Talk)</h3>
                            <p class="text-blue-100 text-sm opacity-90">ä¸é™ä¸»é¡Œï¼Œåƒæœ‹å‹ä¸€æ¨£éš¨æ„èŠå¤©</p>
                        </div>
                        <i class="fa-solid fa-comments text-3xl opacity-80"></i>
                    </div>
                </div>
                <div class="absolute -right-4 -bottom-4 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
            </div>

            <!-- æƒ…å¢ƒåˆ—è¡¨ -->
            <h2 class="font-bold text-lg mb-3 ml-1 text-slate-700">æƒ…å¢ƒæ¨¡æ“¬</h2>
            <div class="space-y-3" id="scenario-list"></div>
        </div>

        <!-- é é¢ 2: èª²ç¨‹æ¨¡å¼ (Learn) -->
        <div id="view-learn" class="page-view hidden flex-1 overflow-y-auto p-5 pb-24">
            <header class="mb-6 mt-4">
                <p class="text-ios-gray text-xs font-bold uppercase tracking-wider mb-1">Curriculum</p>
                <h1 class="text-3xl font-bold">ä¸»é¡Œèª²ç¨‹</h1>
            </header>

            <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-slate-100 flex justify-between items-center">
                <div>
                    <p class="text-sm text-slate-600">ç•¶å‰æ¨™æº–</p>
                    <p id="learn-level-display" class="font-bold text-ios-blue text-lg">JLPT N5-N3</p>
                </div>
                <button onclick="switchView('settings')" class="text-xs bg-slate-100 px-3 py-1.5 rounded-lg text-slate-500 font-bold">æ›´æ›</button>
            </div>

            <div id="lesson-list" class="grid grid-cols-1 gap-3">
                <!-- èª²ç¨‹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é é¢ 3: å–®å­—æœ¬ (Vocab) -->
        <div id="view-vocab" class="page-view hidden flex-1 overflow-y-auto p-5 pb-24">
            <header class="mb-4 mt-4 flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold">å–®å­—ç­†è¨˜</h1>
                    <p class="text-ios-gray text-sm mt-1" id="vocab-subtitle">é¡¯ç¤ºç•¶å‰èªè¨€çš„å–®å­—</p>
                </div>
                <button onclick="startQuiz()" class="bg-ios-blue text-white px-4 py-2 rounded-full text-sm font-bold shadow-md active-scale">
                    <i class="fa-solid fa-graduation-cap mr-1"></i> æ¸¬é©—
                </button>
            </header>
            
            <div id="vocab-list" class="space-y-3 pb-10"></div>
        </div>

        <!-- é é¢ 4: èŠå¤©å®¤ (å…±ç”¨è¦–çª—) -->
        <div id="view-chat" class="page-view hidden flex-1 flex flex-col h-full absolute inset-0 bg-ios-bg z-50">
            <!-- å°èˆªåˆ— -->
            <div class="glass-nav pt-safe-top px-4 py-3 flex items-center justify-between shadow-sm z-30 h-16 shrink-0">
                <button onclick="backToMain()" class="text-ios-blue flex items-center gap-1 text-lg active-scale w-16">
                    <i class="fa-solid fa-chevron-left"></i> <span class="text-base font-medium">è¿”å›</span>
                </button>
                <div class="text-center flex-1 overflow-hidden">
                    <h2 id="chat-title" class="font-bold text-base truncate px-2">å°è©±</h2>
                    <p id="chat-subtitle" class="text-[10px] text-ios-gray">AI Coach</p>
                </div>
                <div class="w-16 flex justify-end">
                     <button onclick="toggleVocabDrawer()" class="text-ios-blue text-lg active-scale">
                        <i class="fa-solid fa-book-open"></i>
                    </button>
                </div>
            </div>

            <!-- å‹•æ…‹ä»»å‹™æç¤ºæ¬„ -->
            <div id="mission-banner" class="hidden bg-indigo-50 border-b border-indigo-100 p-2 px-4 flex justify-between items-center shrink-0 min-h-[40px]">
                <span class="text-xs text-indigo-800 font-bold shrink-0"><i class="fa-solid fa-bullseye mr-1"></i> ä»»å‹™ï¼š</span>
                <span id="mission-words" class="text-xs text-indigo-600 font-mono truncate flex-1 text-right">ç”Ÿæˆä¸­...</span>
            </div>

            <!-- å…§å®¹æ²å‹•å€ -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-4"></div>

            <!-- åº•éƒ¨è¼¸å…¥å€ -->
            <div class="bg-white border-t border-slate-200 p-3 pb-safe-bottom w-full shrink-0 relative z-30" id="chat-input-area">
                <!-- ç³¾æ­£å»ºè­°æµ®çª— -->
                <div id="correction-area" class="hidden absolute bottom-full left-0 w-full bg-yellow-50 border-t border-yellow-200 p-3 shadow-sm rounded-t-xl mb-[1px] mx-2 w-[calc(100%-1rem)]">
                    <div class="flex justify-between items-start mb-1">
                         <span class="text-xs font-bold text-yellow-800"><i class="fa-solid fa-wand-magic-sparkles"></i> å»ºè­°ä¿®æ­£</span>
                         <button onclick="document.getElementById('correction-area').classList.add('hidden')" class="text-yellow-600"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="correction-text" class="text-sm"></div>
                </div>

                <div class="flex items-end gap-2">
                    <button id="mic-btn" onclick="toggleSpeech()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-lg active-scale transition-colors shrink-0">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <div class="flex-1 bg-slate-100 rounded-2xl px-4 py-2 min-h-[40px] flex items-center">
                        <textarea id="msg-input" rows="1" class="w-full bg-transparent border-none outline-none resize-none max-h-24 text-base pt-1 placeholder-slate-400" placeholder="è¼¸å…¥è¨Šæ¯..."></textarea>
                    </div>
                    <button onclick="sendUserMessage()" id="send-btn" class="w-10 h-10 rounded-full bg-ios-blue text-white flex items-center justify-center text-lg shadow-md active-scale shrink-0">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¿»è­¯æŒ‰éˆ• -->
        <button id="translate-btn" class="hidden fixed z-[100] bg-slate-800 text-white text-sm py-2 px-4 rounded-full shadow-xl popover flex items-center gap-2" onclick="handleTranslate()">
            <span>ç¿»è­¯</span> <i class="fa-solid fa-plus text-xs"></i>
        </button>

        <!-- è¨­å®šé é¢ (Settings) -->
        <div id="view-settings" class="page-view hidden flex-1 overflow-y-auto p-5">
             <header class="mb-6 mt-4">
                <button onclick="switchView('home')" class="text-ios-blue mb-4 flex items-center gap-1"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
                <h1 class="text-3xl font-bold">è¨­å®š</h1>
            </header>
            
            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
                <div class="p-4 border-b border-slate-100">
                    <label class="block text-sm font-medium text-slate-500 mb-1">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full text-base p-2 bg-slate-100 rounded-lg outline-none" placeholder="è²¼ä¸Š API Key">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-ios-blue mt-1 block">å–å¾—å…è²» API Key</a>
                </div>
                <div class="p-4 flex justify-between items-center border-b border-slate-100">
                    <span class="text-base font-medium">å­¸ç¿’èªè¨€</span>
                    <select id="target-lang" class="bg-transparent text-ios-blue font-bold outline-none text-right" onchange="updateLangDisplay()">
                        <option value="Japanese">æ—¥æœ¬èª (Japanese)</option>
                        <option value="English">English</option>
                        <option value="Korean">í•œêµ­ì–´ (Korean)</option>
                    </select>
                </div>
                <div class="p-4 flex justify-between items-center">
                    <span class="text-base font-medium">ç•¶å‰ç­‰ç´š</span>
                    <select id="user-level" class="bg-transparent text-ios-blue font-bold outline-none text-right">
                        <option value="Beginner">åˆç´š (N5-N3 / A1-A2)</option>
                        <option value="Intermediate">ä¸­ç´š (N2 / B1-B2)</option>
                        <option value="Advanced">é«˜ç´š (N1 / C1-C2)</option>
                    </select>
                </div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-ios-blue text-white font-bold py-3 rounded-xl shadow-md active-scale mb-8">å„²å­˜è¨­å®š</button>

            <!-- è³‡æ–™ç®¡ç† (å‚™ä»½/é‚„åŸ) -->
            <h2 class="text-lg font-bold mb-3 text-slate-700">è³‡æ–™ç®¡ç†</h2>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6 p-4 space-y-3">
                <button onclick="exportData()" class="w-full border border-ios-blue text-ios-blue font-bold py-2.5 rounded-lg active-scale flex items-center justify-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-down"></i> å‚™ä»½è³‡æ–™ (ä¸‹è¼‰)
                </button>
                <button onclick="document.getElementById('file-input').click()" class="w-full border border-slate-300 text-slate-600 font-bold py-2.5 rounded-lg active-scale flex items-center justify-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up"></i> é‚„åŸè³‡æ–™ (ä¸Šå‚³)
                </button>
                <input type="file" id="file-input" class="hidden" accept=".json" onchange="importData(this)">
            </div>
            <div class="text-center text-xs text-slate-400 pb-10">LingoFlow Pro v2.1</div>
        </div>

    </div>

    <!-- åº•éƒ¨ Tab Bar -->
    <nav class="glass-nav h-[85px] flex justify-around items-start pt-3 absolute bottom-0 w-full z-40 pb-safe-bottom" id="tab-bar">
        <button onclick="switchView('home')" class="nav-btn active flex flex-col items-center gap-1 w-16 text-ios-blue transition-colors" data-target="home">
            <i class="fa-solid fa-house text-xl"></i>
            <span class="text-[10px] font-medium">ç·´ç¿’</span>
        </button>
        <button onclick="switchView('learn')" class="nav-btn flex flex-col items-center gap-1 w-16 text-ios-gray transition-colors" data-target="learn">
            <i class="fa-solid fa-book-open-reader text-xl"></i>
            <span class="text-[10px] font-medium">èª²ç¨‹</span>
        </button>
        <button onclick="switchView('vocab')" class="nav-btn flex flex-col items-center gap-1 w-16 text-ios-gray transition-colors" data-target="vocab">
            <i class="fa-solid fa-bookmark text-xl"></i>
            <span class="text-[10px] font-medium">å–®å­—</span>
        </button>
        <button onclick="switchView('settings')" class="nav-btn flex flex-col items-center gap-1 w-16 text-ios-gray transition-colors" data-target="settings">
            <i class="fa-solid fa-gear text-xl"></i>
            <span class="text-[10px] font-medium">è¨­å®š</span>
        </button>
    </nav>

    <script>
        // =========================================
        // 1. æ ¸å¿ƒè³‡æ–™èˆ‡åˆ†ç´šèª²ç¨‹ç³»çµ± (JLPT / CEFR)
        // =========================================
        
        const scenarios = [
            { id: 'cafe', title: 'å’–å•¡å»³é»é¤', icon: 'fa-mug-hot', color: 'bg-orange-100 text-orange-600', role: 'åº—å“¡' },
            { id: 'convenience', title: 'ä¾¿åˆ©å•†åº—', icon: 'fa-store', color: 'bg-green-100 text-green-600', role: 'åº—å“¡' },
            { id: 'airport', title: 'æ©Ÿå ´å…¥å¢ƒ', icon: 'fa-plane-arrival', color: 'bg-blue-100 text-blue-600', role: 'ç§»æ°‘å®˜' },
            { id: 'hotel', title: 'é£¯åº—å…¥ä½', icon: 'fa-hotel', color: 'bg-indigo-100 text-indigo-600', role: 'æ«ƒæª¯äººå“¡' },
            { id: 'date', title: 'æµªæ¼«ç´„æœƒ', icon: 'fa-heart', color: 'bg-pink-100 text-pink-600', role: 'ç´„æœƒå°è±¡' },
            { id: 'business', title: 'å•†å‹™æœƒè­°', icon: 'fa-briefcase', color: 'bg-slate-200 text-slate-700', role: 'å®¢æˆ¶' },
            { id: 'doctor', title: 'çœ‹é†«ç”Ÿ', icon: 'fa-user-doctor', color: 'bg-red-100 text-red-600', role: 'é†«ç”Ÿ' }
        ];

        // èª²ç¨‹è³‡æ–™åº« (æ¡ç”¨æ—¥æª¢ JLPT èˆ‡ æ­è¦ CEFR)
        const curriculumData = {
            'Japanese': {
                'Beginner': [
                    'N5: å¹³å‡åèˆ‡ç‰‡å‡å (Hiragana/Katakana)', 
                    'N5: åŸºæœ¬å•å€™èˆ‡è‡ªæˆ‘ä»‹ç´¹', 
                    'N5: å½¢å®¹è©è®ŠåŒ– (ã‚¤å½¢/ãƒŠå½¢)', 
                    'N4: å‹•è©è®ŠåŒ– (Te-form)', 
                    'N4: æˆå—å‹•è© (Ageru/Kureru)', 
                    'N3: åŸºç¤æ•¬èª (Sonkeigo/Kenjougo)'
                ],
                'Intermediate': [
                    'N2: å‡è¨­èªæ°£ (Tara/Ba/Nara)', 
                    'N2: è¢«å‹•èˆ‡ä½¿å½¹ (Passive/Causative)', 
                    'N2: å•†å‹™æ•¬èªå¯¦æˆ°', 
                    'N2: è¤‡åˆå‹•è© (-kakeru, -kiru)', 
                    'N2: è½è§£é—œéµè©å½™'
                ],
                'Advanced': [
                    'N1: æ›¸é¢èªèˆ‡è«–æ–‡çµæ§‹', 
                    'N1: æŠ½è±¡èªæ³• (Yue ni, Gotoku)', 
                    'N1: æ–°èæ™‚äº‹è¨è«–', 
                    'N1: æ“¬è²æ“¬æ…‹èªçš„é«˜ç´šæ‡‰ç”¨', 
                    'N1: æ—¥æœ¬æ–‡åŒ–èˆ‡ç¤¾æœƒè­°é¡Œ'
                ]
            },
            'English': {
                'Beginner': [
                    'A1: Greetings & Introductions',
                    'A1: Verb "To Be" & Present Simple',
                    'A2: Past Simple & Regular Verbs',
                    'A2: Daily Routines & Time',
                    'A2: Comparatives & Superlatives'
                ],
                'Intermediate': [
                    'B1: Present Perfect vs Past Simple',
                    'B1: Modal Verbs (Advice/Obligation)',
                    'B2: Conditionals (Zero, 1st, 2nd)',
                    'B2: Passive Voice in News',
                    'B2: Reported Speech'
                ],
                'Advanced': [
                    'C1: Mixed Conditionals',
                    'C1: Advanced Phrasal Verbs',
                    'C1: Inversion for Emphasis',
                    'C2: Nuances & Idioms',
                    'C2: Academic Writing Flow'
                ]
            },
            'Korean': { // ç°¡åŒ– Fallback
                'Beginner': ['TOPIK I: éŸ“æ–‡å­—æ¯', 'TOPIK I: åŸºæœ¬å¥å‹'], 
                'Intermediate': ['TOPIK II: é–“æ¥å¼•ç”¨', 'TOPIK II: è¢«å‹•æ…‹'], 
                'Advanced': ['TOPIK II: é«˜ç´šå¯«ä½œ', 'TOPIK II: å››å­—æˆèª'] 
            }
        };

        const state = {
            apiKey: localStorage.getItem('gemini_api_key') || '',
            lang: localStorage.getItem('target_lang') || 'Japanese',
            level: localStorage.getItem('user_level') || 'Beginner',
            vocab: JSON.parse(localStorage.getItem('vocab_v2')) || [],
            chatHistory: [],
            currentMode: null,
            selection: null
        };

        // =========================================
        // 2. åˆå§‹åŒ–
        // =========================================
        document.addEventListener('DOMContentLoaded', () => {
            renderScenarios();
            updateLangDisplay(); 
            
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('target-lang').value = state.lang;
            document.getElementById('user-level').value = state.level;
            
            if(!state.apiKey) switchView('settings');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if(btn.dataset.target === 'learn') renderLessons();
                    if(btn.dataset.target === 'vocab') renderVocab();
                });
            });
        });

        // =========================================
        // 3. API å‘¼å« (é›™é‡ä¿éšªæ©Ÿåˆ¶ï¼šFlash -> Pro)
        // =========================================
        
        async function callGeminiAPI(contents, isJsonMode = false) {
            if(!state.apiKey) throw new Error("è«‹å…ˆè¨­å®š API Key");

            // ç­–ç•¥ 1: å„ªå…ˆå˜—è©¦ gemini-1.5-flash-latest
            try {
                return await tryFetchModel('gemini-1.5-flash-latest', contents, isJsonMode);
            } catch (error) {
                console.warn("1.5 Flash å¤±æ•—ï¼Œå˜—è©¦åˆ‡æ›åˆ° gemini-pro (1.0)...", error);
                
                // ç­–ç•¥ 2: å¤±æ•—æ™‚ï¼Œè‡ªå‹•é™ç´šåˆ° gemini-1.5-flash (ç„¡å¾Œç¶´) æˆ– gemini-pro
                try {
                     return await tryFetchModel('gemini-1.5-flash', contents, isJsonMode);
                } catch (err2) {
                     // æœ€å¾Œæ‰‹æ®µ
                     return await tryFetchModel('gemini-pro', contents, isJsonMode);
                }
            }
        }

        async function tryFetchModel(modelName, contents, isJsonMode) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${state.apiKey}`;

            const config = {
                temperature: 0.7,
                maxOutputTokens: 800,
            };
            
            if(isJsonMode) config.responseMimeType = "application/json";

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents,
                    generationConfig: config
                })
            });

            const data = await response.json();
            
            if(data.error) {
                // å¦‚æœæ˜¯ 404 Not Found æˆ– 400 Bad Requestï¼Œæ‹‹å‡ºéŒ¯èª¤è®“å¤–å±¤ catch è™•ç†
                throw new Error(data.error.message);
            }

            return data.candidates[0].content.parts[0].text;
        }

        // =========================================
        // 4. UI æ¸²æŸ“é‚è¼¯
        // =========================================
        function switchView(viewId) {
            document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            const tabBar = document.getElementById('tab-bar');
            if (viewId === 'chat') tabBar.classList.add('hidden');
            else tabBar.classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewId) {
                    btn.classList.add('text-ios-blue');
                    btn.classList.remove('text-ios-gray');
                } else {
                    btn.classList.remove('text-ios-blue');
                    btn.classList.add('text-ios-gray');
                }
            });
        }

        function backToMain() {
            switchView('home');
            state.chatHistory = []; 
        }

        function updateLangDisplay() {
            const map = { 'Japanese': 'ğŸ‡¯ğŸ‡µ æ—¥èª', 'English': 'ğŸ‡ºğŸ‡¸ è‹±èª', 'Korean': 'ğŸ‡°ğŸ‡· éŸ“èª' };
            // ç­‰ç´šé¡¯ç¤ºé‚è¼¯
            let levelText = state.level;
            if(state.lang === 'Japanese') {
                if(state.level === 'Beginner') levelText = 'åˆç´š (N5-N3)';
                if(state.level === 'Intermediate') levelText = 'ä¸­ç´š (N2)';
                if(state.level === 'Advanced') levelText = 'é«˜ç´š (N1)';
            } else if (state.lang === 'English') {
                if(state.level === 'Beginner') levelText = 'åˆç´š (A1-A2)';
                if(state.level === 'Intermediate') levelText = 'ä¸­ç´š (B1-B2)';
                if(state.level === 'Advanced') levelText = 'é«˜ç´š (C1-C2)';
            }

            document.getElementById('current-lang-display').innerText = map[state.lang] || state.lang;
            document.getElementById('home-level-badge').innerText = levelText;
            document.getElementById('learn-level-display').innerText = levelText;
            
            renderLessons();
        }

        function renderScenarios() {
            const list = document.getElementById('scenario-list');
            list.innerHTML = scenarios.map(s => `
                <div onclick="startChat('${s.id}')" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 active-scale cursor-pointer">
                    <div class="w-10 h-10 rounded-full ${s.color} flex items-center justify-center text-lg shrink-0">
                        <i class="fa-solid ${s.icon}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-base truncate">${s.title}</h3>
                        <p class="text-xs text-slate-500">è§’è‰²: ${s.role}</p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-300 text-sm"></i>
                </div>
            `).join('');
        }

        function renderLessons() {
            const list = document.getElementById('lesson-list');
            const langData = curriculumData[state.lang] || curriculumData['English'];
            const levelData = langData[state.level] || langData['Beginner'];
            
            list.innerHTML = levelData.map(topic => `
                <div onclick="startLesson('${topic}')" class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 active-scale cursor-pointer relative overflow-hidden group">
                     <div class="flex justify-between items-center z-10 relative">
                        <div>
                            <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded mb-1 inline-block">Lesson</span>
                            <h3 class="font-bold text-lg text-slate-800">${topic}</h3>
                        </div>
                        <i class="fa-solid fa-play text-ios-blue bg-blue-50 w-8 h-8 flex items-center justify-center rounded-full"></i>
                     </div>
                </div>
            `).join('');
        }

        // =========================================
        // 5. èŠå¤©èˆ‡èª²ç¨‹é‚è¼¯ (å‹•æ…‹ç›®æ¨™è©å½™)
        // =========================================

        async function generateMissionWords(scenarioTitle) {
            const missionEl = document.getElementById('mission-words');
            missionEl.innerText = "ç”ŸæˆæŒ‘æˆ°è©å½™ä¸­...";
            
            // æ ¹æ“šä¸åŒç­‰ç´šç”Ÿæˆ
            let levelPrompt = state.level;
            if(state.lang === 'Japanese') {
                if(state.level === 'Beginner') levelPrompt = 'JLPT N4/N3 level';
                if(state.level === 'Intermediate') levelPrompt = 'JLPT N2 level';
                if(state.level === 'Advanced') levelPrompt = 'JLPT N1 level';
            }

            const prompt = `Generate 3 distinct, useful vocabulary words for a ${levelPrompt} learner of ${state.lang} specifically for the scenario: "${scenarioTitle}". 
            Return ONLY a raw JSON array of strings. Example: ["Word1", "Word2", "Word3"]`;

            try {
                const text = await callGeminiAPI([{ role: "user", parts: [{ text: prompt }] }], true);
                const words = JSON.parse(text);
                missionEl.innerText = words.join(', ');
                return words;
            } catch (e) {
                console.error("Mission gen failed", e);
                missionEl.innerText = "è«‹ç¨å¾Œå†è©¦";
                return [];
            }
        }

        async function startChat(scenarioId) {
            if(!state.apiKey) return switchView('settings');

            state.currentMode = 'chat';
            state.chatHistory = [];
            switchView('chat');
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('correction-area').classList.add('hidden');
            document.getElementById('chat-input-area').classList.remove('hidden');

            const isFreeTalk = scenarioId === 'free';
            const scenario = scenarios.find(s => s.id === scenarioId) || { title: 'Free Talk', role: 'Friend' };
            
            document.getElementById('chat-title').innerText = isFreeTalk ? 'è‡ªç”±å°è©±' : scenario.title;
            document.getElementById('chat-subtitle').innerText = isFreeTalk ? 'Free Talk' : `Role: ${scenario.role}`;
            
            // è™•ç†ç›®æ¨™å–®å­—
            const missionBanner = document.getElementById('mission-banner');

            if(!isFreeTalk) {
                missionBanner.classList.remove('hidden');
                // å‹•æ…‹ç”Ÿæˆ
                generateMissionWords(scenario.title);
            } else {
                missionBanner.classList.add('hidden');
            }

            // ç³»çµ±æç¤ºè©
            let systemPrompt = `
                Act as a language teacher/partner. 
                Language: ${state.lang}. User Level: ${state.level} (JLPT/CEFR standard).
                ${isFreeTalk ? 'Role: Friend. Chat casually.' : `Roleplay Scenario: ${scenario.title}. You are: ${scenario.role}.`}
                
                Instructions:
                1. Keep replies concise (1-3 sentences).
                2. If the user makes a grammar mistake, append a JSON correction at the end.
                3. Adjust your vocabulary to match the user's level.
                
            