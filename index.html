<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F2F7">
    <title>LingoFlow v23.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        .selectable { user-select: text; }
        body { background-color: #F2F2F7; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif; overflow: hidden; color: #1c1c1e; }
        
        /* 頁面容器優化，預留底部導覽空間 */
        .page-view { position: absolute; inset: 0; bottom: 85px; overflow-y: auto; padding: 20px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; }
        
        /* iOS 風格元件 */
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.1); }
        .ios-card { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: transform 0.1s, background-color 0.2s; border: 1px solid rgba(0,0,0,0.02); }
        .ios-card:active { transform: scale(0.98); background-color: #f5f5f5; }
        
        /* 劃詞工具 */
        #word-tools { display: none; position: absolute; background: #2c2c2e; color: white; padding: 8px 16px; border-radius: 12px; z-index: 2000; font-size: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); pointer-events: auto; }
        
        /* 隱藏捲軸但保留功能 */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="h-[100dvh] w-screen">

    <div id="word-tools">
        <div class="flex items-center gap-3">
            <span id="sel-text" class="max-w-[120px] truncate opacity-90 border-r border-gray-500 pr-3 font-medium"></span>
            <button onclick="translateAndSave()" class="text-blue-400 font-bold whitespace-nowrap active:opacity-50">翻譯收藏</button>
        </div>
    </div>

    <div id="app" class="h-full relative">

        <div id="view-home" class="page-view">
            <div class="flex justify-between items-center mb-6 mt-2">
                <h1 class="text-3xl font-bold tracking-tight">LingoFlow</h1>
                <span id="current-lang-badge" class="px-3 py-1 bg-gray-200 rounded-full text-xs font-bold text-gray-500">English</span>
            </div>
            
            <div class="bg-gray-200/80 p-1 rounded-xl flex mb-6 text-xs font-bold text-center backdrop-blur-sm">
                <div onclick="setLevel('Easy')" id="lvl-Easy" class="flex-1 py-2 rounded-lg bg-white shadow-sm transition-all cursor-pointer">初級</div>
                <div onclick="setLevel('Medium')" id="lvl-Medium" class="flex-1 py-2 rounded-lg text-gray-500 transition-all cursor-pointer">中級</div>
                <div onclick="setLevel('Hard')" id="lvl-Hard" class="flex-1 py-2 rounded-lg text-gray-500 transition-all cursor-pointer">高級</div>
            </div>

            <div onclick="startChat('Free Talk', 'Friend')" class="bg-gradient-to-br from-[#007AFF] to-[#0055ff] p-6 rounded-[24px] text-white mb-8 shadow-lg shadow-blue-200 active:scale-95 transition-all relative overflow-hidden cursor-pointer">
                <div class="relative z-10">
                    <h3 class="font-bold text-xl">Free Talk</h3>
                    <p class="text-blue-100 text-sm mt-1 opacity-90">不限主題 • 自由練習</p>
                </div>
                <i class="fa-solid fa-comments absolute -bottom-3 -right-3 text-7xl text-white opacity-20"></i>
            </div>

            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 ml-1">情境選擇</h2>
            <div id="scenario-list" class="space-y-3 pb-10"></div>
        </div>

        <div id="view-learn" class="page-view hidden">
            <h1 class="text-3xl font-bold mb-6 mt-2 tracking-tight">課程</h1>
            <div id="lesson-list" class="space-y-3 pb-10"></div>
        </div>

        <div id="view-vocab" class="page-view hidden">
            <div class="flex justify-between items-end mb-6 mt-2">
                <h1 class="text-3xl font-bold tracking-tight">單字本</h1>
                <button onclick="startQuiz()" class="bg-orange-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow active:scale-95">測驗</button>
            </div>
            <div id="vocab-display-list" class="space-y-3 pb-10"></div>
        </div>

        <div id="view-settings" class="page-view hidden">
            <h1 class="text-3xl font-bold mb-6 mt-2 tracking-tight">設定</h1>
            
            <div class="bg-white rounded-2xl overflow-hidden shadow-sm mb-6 border border-gray-100">
                <div class="p-4 border-b border-gray-100">
                    <label class="text-xs font-bold text-gray-400 uppercase">API Key</label>
                    <input type="password" id="api-key-input" class="w-full mt-2 outline-none text-sm bg-transparent" placeholder="AIza...">
                </div>
                <div class="p-4 border-b border-gray-100">
                    <label class="text-xs font-bold text-gray-400 uppercase">Project ID (若有權限問題請填)</label>
                    <input type="text" id="project-id-input" class="w-full mt-2 outline-none text-sm bg-transparent" placeholder="language-app-xxx">
                </div>
                <div class="p-4">
                    <label class="text-xs font-bold text-gray-400 uppercase">練習語言</label>
                    <select id="target-lang" class="w-full mt-2 outline-none bg-transparent font-bold text-blue-600 text-base" onchange="updateLangUI()">
                        <option value="English">English (英語)</option>
                        <option value="Japanese">日本語 (日語)</option>
                        <option value="Korean">한국어 (韓語)</option>
                    </select>
                </div>
            </div>

            <div class="bg-white rounded-2xl overflow-hidden shadow-sm mb-6 border border-gray-100">
                <div onclick="backupData()" class="p-4 border-b border-gray-100 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                    <span class="text-sm font-medium">備份資料 (JSON)</span>
                    <i class="fa-solid fa-cloud-arrow-down text-blue-500"></i>
                </div>
                <label class="p-4 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                    <span class="text-sm font-medium">還原資料</span>
                    <i class="fa-solid fa-cloud-arrow-up text-green-500"></i>
                    <input type="file" onchange="restoreData(this)" class="hidden" accept=".json">
                </label>
            </div>

            <button onclick="saveSettings()" class="w-full bg-[#007AFF] text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 text-sm transition-transform">儲存設定</button>
        </div>

        <div id="view-chat" class="fixed inset-0 bg-[#F2F2F7] z-50 hidden flex flex-col translate-x-full transition-transform duration-300">
            <div class="h-[60px] bg-white/95 backdrop-blur flex justify-between items-center px-4 border-b shadow-sm z-10 pt-2">
                <button onclick="closeChat()" class="text-[#007AFF] flex items-center gap-1 font-medium active:opacity-50 p-2"><i class="fa-solid fa-chevron-left"></i> 返回</button>
                <div class="text-center">
                    <h2 id="chat-title" class="font-bold text-base text-slate-800">對話</h2>
                    <span id="chat-subtitle" class="text-[10px] text-green-500 block leading-none mt-0.5">連線中...</span>
                </div>
                <div class="w-16"></div> </div>

            <div id="mission-bar" class="bg-blue-50 px-4 py-3 flex flex-col justify-center items-start text-xs text-blue-800 border-b border-blue-100 hidden">
                <span class="font-bold mb-1"><i class="fa-solid fa-bullseye mr-1"></i>本次任務：試著使用以下單字</span>
                <span id="mission-words" class="font-mono bg-white px-2 py-1 rounded border border-blue-200 w-full text-center">Loading...</span>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

            <div class="bg-white border-t p-3 pb-8 flex items-end gap-2">
                <button id="btn-mic" onclick="toggleSpeech()" class="w-10 h-10 rounded-full text-gray-400 hover:text-red-500 bg-gray-50 hover:bg-red-50 transition-all flex items-center justify-center border border-gray-200">
                    <i class="fa-solid fa-microphone text-lg"></i>
                </button>
                <div class="flex-1 bg-gray-100 rounded-2xl px-4 py-2 min-h-[40px] flex items-center border border-transparent focus-within:border-blue-300 focus-within:bg-white transition-all">
                    <input type="text" id="msg-input" class="w-full bg-transparent outline-none text-base text-slate-800" placeholder="輸入訊息..." onkeypress="if(event.key==='Enter') sendUserMessage()">
                </div>
                <button onclick="sendUserMessage()" class="w-10 h-10 bg-[#007AFF] text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-all">
                    <i class="fa-solid fa-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>

    <nav class="glass-nav fixed bottom-0 w-full h-[85px] flex justify-around pt-3 z-40 text-[10px] font-medium">
        <button onclick="switchView('home')" class="nav-btn text-[#007AFF] flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fa-solid fa-house text-xl"></i><span>首頁</span></button>
        <button onclick="switchView('learn')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fa-solid fa-graduation-cap text-xl"></i><span>課程</span></button>
        <button onclick="switchView('vocab')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fa-solid fa-book-bookmark text-xl"></i><span>單字</span></button>
        <button onclick="switchView('settings')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 active:scale-95 transition-transform"><i class="fa-solid fa-gear text-xl"></i><span>設定</span></button>
    </nav>

    <script>
        // --- 狀態管理 ---
        let state = {
            apiKey: localStorage.getItem('v23_key') || '',
            projectId: localStorage.getItem('v23_proj') || '',
            lang: localStorage.getItem('v23_lang') || 'English',
            level: localStorage.getItem('v23_level') || 'Medium',
            vocabs: JSON.parse(localStorage.getItem('v23_vocabs') || '[]'),
            chatHistory: []
        };
        
        // --- 資料庫 ---
        // 1. 課程資料 (包含 N2/N3 中級)
        const curriculumData = {
            'English': {
                'Easy': ['Self Introduction', 'Basic Numbers', 'Ordering Food', 'Family & Friends'],
                'Medium': ['Travel Arrangements', 'Asking for Help', 'Shopping Conversations', 'Making Plans'],
                'Hard': ['Business Negotiation', 'Academic Discussion', 'News Analysis', 'Abstract Topics']
            },
            'Japanese': {
                'Easy': ['自己紹介 (N5)', 'これ・それ・あれ (N5)', '買い物 (N5)', '時間の言い方 (N5)'],
                'Medium': ['レストランでの注文 (N3)', '道を尋ねる (N3)', '敬語の基本 (N2)', '許可を求める (N2)', '使役・受身 (N2)'], // 補上 N2
                'Hard': ['ビジネスメール (N1)', '社会問題の議論 (N1)', 'ニュースの聴解 (N1)', '面接の練習 (N1)']
            },
            'Korean': {
                'Easy': ['基本挨拶', '数字と買い物', '自己紹介'],
                'Medium': ['レストランで注文', '道を尋ねる', '旅行の計画'],
                'Hard': ['ニュース討論', '敬語の使い分け', 'ビジネス会話']
            }
        };

        // 2. 情境資料 (依語言分類)
        const scenariosData = {
            'English': [
                { id: 'cafe', title: 'Coffee Shop', role: 'Barista', icon: 'fa-mug-hot', color: 'text-amber-600 bg-amber-50' },
                { id: 'hotel', title: 'Hotel Check-in', role: 'Receptionist', icon: 'fa-bell', color: 'text-indigo-600 bg-indigo-50' },
                { id: 'interview', title: 'Job Interview', role: 'Interviewer', icon: 'fa-user-tie', color: 'text-slate-600 bg-slate-50' }
            ],
            'Japanese': [
                { id: 'cafe_jp', title: 'カフェ (Cafe)', role: '店員', icon: 'fa-mug-hot', color: 'text-amber-600 bg-amber-50' },
                { id: 'hotel_jp', title: 'ホテル (Hotel)', role: 'フロント', icon: 'fa-bell', color: 'text-indigo-600 bg-indigo-50' },
                { id: 'interview_jp', title: '面接 (Interview)', role: '面接官', icon: 'fa-user-tie', color: 'text-slate-600 bg-slate-50' }
            ],
            'Korean': [
                { id: 'cafe_kr', title: '카페 (Cafe)', role: 'Barista', icon: 'fa-mug-hot', color: 'text-amber-600 bg-amber-50' },
                { id: 'hotel_kr', title: '호텔 (Hotel)', role: 'Receptionist', icon: 'fa-bell', color: 'text-indigo-600 bg-indigo-50' },
                { id: 'interview_kr', title: '면접 (Interview)', role: 'Interviewer', icon: 'fa-user-tie', color: 'text-slate-600 bg-slate-50' }
            ]
        };

        const missionWords = {
            'English': ['absolutely', 'perspective', 'appreciate', 'wonder', 'actually', 'consider'],
            'Japanese': ['確かに (tashikani)', '例えば (tatoeba)', '実は (jitsuwa)', 'なるほど (naruhodo)', '恐縮 (kyoushuku)'],
            'Korean': ['솔직히', '예를 들어', '물론', '사실은']
        };

        // --- 初始化 ---
        window.onload = () => {
            // 載入設定
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('project-id-input').value = state.projectId;
            document.getElementById('target-lang').value = state.lang;
            
            // 初始化 UI
            setLevel(state.level);
            updateLangUI(); // 渲染情境與課程
            
            // 事件監聽
            document.addEventListener('mouseup', handleTextSelection);
        };

        // --- 核心邏輯：介面更新 ---
        function updateLangUI() {
            // 更新狀態
            const select = document.getElementById('target-lang');
            state.lang = select.value;
            document.getElementById('current-lang-badge').innerText = state.lang;
            
            // 重新渲染列表
            renderScenarios();
            renderLessons();
            renderVocabs(); // 刷新單字本篩選
        }

        function setLevel(lvl) {
            state.level = lvl;
            localStorage.setItem('v23_level', lvl);
            
            // 更新按鈕樣式
            ['Easy', 'Medium', 'Hard'].forEach(l => {
                const el = document.getElementById(`lvl-${l}`);
                if(l === lvl) el.className = "flex-1 py-2 rounded-lg bg-white shadow-sm transition-all cursor-pointer text-blue-600 ring-1 ring-black/5";
                else el.className = "flex-1 py-2 rounded-lg text-gray-500 transition-all cursor-pointer hover:bg-gray-200/50";
            });
            renderLessons(); // 等級變更時刷新課程
        }

        // --- 核心邏輯：渲染 ---
        function renderScenarios() {
            const list = document.getElementById('scenario-list');
            const data = scenariosData[state.lang] || scenariosData['English'];
            
            list.innerHTML = data.map(s => `
                <div onclick="startChat('${s.title}', '${s.role}')" class="ios-card p-4 flex items-center gap-4 cursor-pointer active:scale-98">
                    <div class="w-12 h-12 rounded-2xl ${s.color} flex items-center justify-center text-xl shadow-sm"><i class="fa-solid ${s.icon}"></i></div>
                    <div class="flex-1">
                        <div class="font-bold text-slate-800 text-base">${s.title}</div>
                        <div class="text-xs text-slate-400 font-medium">Role: ${s.role}</div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </div>
            `).join('');
        }

        function renderLessons() {
            const list = document.getElementById('lesson-list');
            // 確保資料存在，若無則 fallback 到 English Medium
            const langData = curriculumData[state.lang] || curriculumData['English'];
            const levelData = langData[state.level] || langData['Medium'];

            list.innerHTML = levelData.map((l, i) => `
                <div onclick="startChat('Lesson: ${l}', 'Tutor')" class="ios-card p-5 flex justify-between items-center cursor-pointer active:scale-98">
                    <div>
                        <div class="text-[10px] font-bold text-blue-500 uppercase mb-1 tracking-wider">UNIT ${i+1}</div>
                        <div class="font-bold text-slate-800 text-base">${l}</div>
                    </div>
                    <i class="fa-solid fa-circle-play text-blue-500 text-2xl opacity-90"></i>
                </div>
            `).join('');
        }

        // --- 核心邏輯：Gemini API ---
        async function callGemini(contents) {
            if (!state.apiKey) throw new Error("請先至設定填寫 API Key");

            const urls = [
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`,
                `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`,
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${state.apiKey}`
            ];

            const headers = { 'Content-Type': 'application/json' };
            if (state.projectId) headers['X-Goog-User-Project'] = state.projectId;

            // 嘗試多個路徑
            for (let url of urls) {
                try {
                    const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify({ contents }) });
                    const data = await res.json();
                    if (res.ok) return data.candidates[0].content.parts[0].text;
                    // 如果不是 404/403，可能是有其他錯誤訊息，記錄下來
                    if (res.status !== 404 && res.status !== 403) console.warn(data.error);
                } catch (e) { console.error(e); }
            }
            throw new Error("連線失敗。請檢查設定 (Key/Project ID/權限)。");
        }

        // --- 聊天功能 ---
        async function startChat(title, role) {
            // UI 切換
            document.getElementById('view-chat').classList.remove('translate-x-full');
            document.getElementById('chat-title').innerText = title;
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('chat-subtitle').innerText = "連線中...";
            document.getElementById('chat-subtitle').className = "text-[10px] text-orange-500 block leading-none mt-0.5";
            
            // 任務單字
            const missions = (missionWords[state.lang] || missionWords['English']).sort(() => 0.5 - Math.random()).slice(0, 3);
            document.getElementById('mission-bar').classList.remove('hidden');
            document.getElementById('mission-words').innerText = missions.join('、');

            // 系統提示詞
            let levelPrompt = state.level === 'Easy' ? 'Beginner (use simple words)' : state.level === 'Medium' ? 'Intermediate' : 'Advanced (native speed)';
            let systemPrompt = `You are a ${role} speaking ${state.lang}. User level: ${levelPrompt}.
            1. If user makes a grammar mistake, start reply with JSON: {"correction": "Correct sentence", "reason": "Why"}.
            2. Reply naturally. 
            3. Try to use these words if possible: ${missions.join(', ')}.`;

            state.chatHistory = [{ role: 'user', parts: [{ text: systemPrompt + " Start with a greeting." }] }];

            try {
                const response = await callGemini(state.chatHistory);
                document.getElementById('chat-subtitle').innerText = "線上";
                document.getElementById('chat-subtitle').className = "text-[10px] text-green-500 block leading-none mt-0.5";
                addAiBubble(response);
                state.chatHistory.push({ role: 'model', parts: [{ text: response }] });
            } catch (e) {
                addSystemBubble(`❌ 連線錯誤: ${e.message}`);
                document.getElementById('chat-subtitle').innerText = "離線";
                document.getElementById('chat-subtitle').className = "text-[10px] text-red-500 block leading-none mt-0.5";
            }
        }

        async function sendUserMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            addUserBubble(text);
            input.value = '';
            
            state.chatHistory.push({ role: 'user', parts: [{ text: text }] });
            document.getElementById('chat-subtitle').innerText = "AI 輸入中...";

            try {
                const response = await callGemini(state.chatHistory);
                addAiBubble(response);
                state.chatHistory.push({ role: 'model', parts: [{ text: response }] });
                document.getElementById('chat-subtitle').innerText = "線上";
            } catch (e) {
                addSystemBubble(e.message);
            }
        }

        function addAiBubble(text) {
            const container = document.getElementById('chat-container');
            let correctionHtml = '';
            let cleanText = text;
            
            // JSON 糾錯解析
            const jsonMatch = text.match(/^\{[\s\S]*?\}/);
            if (jsonMatch) {
                try {
                    const correction = JSON.parse(jsonMatch[0]);
                    if (correction.correction) {
                        correctionHtml = `
                            <div class="mb-2 bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs">
                                <div class="font-bold text-yellow-700 flex items-center gap-1"><i class="fa-solid fa-wrench"></i> 建議修正</div>
                                <div class="text-slate-800 mt-1 font-medium">${correction.correction}</div>
                                <div class="text-slate-500 mt-1">${correction.reason}</div>
                            </div>`;
                        cleanText = text.replace(jsonMatch[0], '').trim();
                    }
                } catch(e) {}
            }

            const div = document.createElement('div');
            div.className = 'flex justify-start mb-6 animate-fade-in';
            div.innerHTML = `
                <div class="max-w-[85%]">
                    ${correctionHtml}
                    <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-800 selectable leading-relaxed border border-gray-100">
                        ${marked.parse(cleanText)}
                    </div>
                    <button onclick="speakText(this)" data-text="${cleanText.replace(/"/g, '&quot;')}" class="mt-2 ml-1 text-gray-400 hover:text-blue-500 text-xs flex items-center gap-1 transition-colors">
                        <i class="fa-solid fa-volume-high"></i> 朗讀
                    </button>
                </div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addUserBubble(text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = 'flex justify-end mb-6 animate-fade-in';
            div.innerHTML = `<div class="bg-[#007AFF] text-white px-4 py-3 rounded-2xl rounded-tr-none shadow-md text-sm max-w-[85%] leading-relaxed break-words">${text}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemBubble(text) {
            document.getElementById('chat-container').innerHTML += `<div class="text-center text-xs text-red-400 py-4 bg-red-50 rounded-lg mx-10 my-2">${text}</div>`;
        }

        // --- 工具功能 ---
        function handleTextSelection(e) {
            const t = window.getSelection().toString().trim();
            const tools = document.getElementById('word-tools');
            if (t && t.length > 0 && t.length < 50) {
                document.getElementById('sel-text').innerText = t;
                tools.style.display = 'block';
                let left = e.pageX;
                // 防止超出右邊界
                if(left + 150 > window.innerWidth) left = window.innerWidth - 160;
                tools.style.left = left + 'px';
                tools.style.top = (e.pageY - 50) + 'px';
            } else { tools.style.display = 'none'; }
        }

        async function translateAndSave() {
            const word = document.getElementById('sel-text').innerText;
            document.getElementById('word-tools').style.display = 'none';
            
            try {
                // 簡單的翻譯請求
                const res = await callGemini([{ role: 'user', parts: [{ text: `Translate "${word}" to Traditional Chinese. Output ONLY the translation word.` }] }]);
                const newItem = { w: word, t: res.trim(), l: state.lang };
                
                if(!state.vocabs.find(v => v.w === word)) {
                    state.vocabs.push(newItem);
                    localStorage.setItem('v23_vocabs', JSON.stringify(state.vocabs));
                    alert(`已收藏: ${word} (${res})`);
                }
            } catch(e) { alert("翻譯請求失敗"); }
        }

        function renderVocabs() {
            const list = document.getElementById('vocab-display-list');
            // 只顯示當前語言的單字
            const filtered = state.vocabs.filter(v => v.l === state.lang);
            
            list.innerHTML = filtered.map(v => `
                <div class="ios-card p-4 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-slate-800 text-base">${v.w}</div>
                        <div class="text-xs text-slate-500 mt-0.5">${v.t}</div>
                    </div>
                    <button onclick="removeVocab('${v.w}')" class="text-red-400 text-xs px-2 py-1"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('') || '<div class="text-center text-gray-400 py-10 text-sm">此語言尚無收藏單字</div>';
        }

        function removeVocab(word) {
            state.vocabs = state.vocabs.filter(v => v.w !== word);
            localStorage.setItem('v23_vocabs', JSON.stringify(state.vocabs));
            renderVocabs();
        }

        // 語音
        let recognition = null;
        let isRecording = false;
        
        function toggleSpeech() {
            if (!('webkitSpeechRecognition' in window)) return alert("請使用 Chrome 或 Safari 瀏覽器");
            if (!recognition) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = state.lang === 'Japanese' ? 'ja-JP' : state.lang === 'Korean' ? 'ko-KR' : 'en-US';
                recognition.onresult = (e) => {
                    document.getElementById('msg-input').value = e.results[0][0].transcript;
                    stopRecording();
                };
                recognition.onend = stopRecording;
            }

            if (isRecording) { recognition.stop(); stopRecording(); }
            else {
                recognition.lang = state.lang === 'Japanese' ? 'ja-JP' : state.lang === 'Korean' ? 'ko-KR' : 'en-US';
                recognition.start();
                isRecording = true;
                const btn = document.getElementById('btn-mic');
                btn.className = "w-10 h-10 rounded-full bg-red-500 text-white animate-pulse flex items-center justify-center shadow-lg ring-4 ring-red-100";
            }
        }

        function stopRecording() {
            isRecording = false;
            const btn = document.getElementById('btn-mic');
            btn.className = "w-10 h-10 rounded-full text-gray-400 hover:text-red-500 bg-gray-50 hover:bg-red-50 transition-all flex items-center justify-center border border-gray-200";
        }

        function speakText(btn) {
            const text = btn.dataset.text;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = state.lang === 'Japanese' ? 'ja-JP' : state.lang === 'Korean' ? 'ko-KR' : 'en-US';
            window.speechSynthesis.speak(u);
        }

        // 頁面切換
        function switchView(t) {
            document.querySelectorAll('.page-view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${t}`).classList.remove('hidden');
            
            // 更新導覽列狀態
            document.querySelectorAll('.nav-btn').forEach(b => {
                const isActive = b.getAttribute('onclick').includes(t);
                b.className = isActive 
                    ? 'nav-btn text-[#007AFF] flex flex-col items-center gap-1 transition-colors' 
                    : 'nav-btn text-gray-400 flex flex-col items-center gap-1 transition-colors';
            });
            
            if(t === 'vocab') renderVocabs();
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value.trim();
            state.projectId = document.getElementById('project-id-input').value.trim();
            localStorage.setItem('v23_key', state.apiKey);
            localStorage.setItem('v23_proj', state.projectId);
            localStorage.setItem('v23_lang', state.lang); // 儲存語言選擇
            location.reload();
        }

        function closeChat() { document.getElementById('view-chat').classList.add('translate-x-full'); }

        // 備份還原
        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", `lingoflow_${new Date().toISOString().slice(0,10)}.json`);
            dl.click();
        }

        function restoreData(input) {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if(d.apiKey) {
                        state = d;
                        localStorage.setItem('v23_key', state.apiKey);
                        localStorage.setItem('v23_vocabs', JSON.stringify(state.vocabs));
                        alert("還原成功！");
                        location.reload();
                    }
                } catch(err) { alert("檔案損毀"); }
            };
            r.readAsText(file);
        }
    </script>
</body>
</html>