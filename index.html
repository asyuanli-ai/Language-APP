<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LingoFlow Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- PWA è¨­å®š -->
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF', gray: '#8E8E93', red: '#FF3B30', green: '#34C759', yellow: '#FFCC00' }
                    },
                    boxShadow: { 'ios': '0 2px 10px rgba(0,0,0,0.05)' }
                }
            }
        }
    </script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .active-scale:active { transform: scale(0.97); transition: 0.1s; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); }
        .popover { animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        /* è¼‰å…¥å‹•ç•« */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-ios-bg text-slate-900 h-[100dvh] w-screen overflow-hidden flex flex-col font-sans">

    <!-- App å®¹å™¨ -->
    <div id="app" class="flex-1 relative overflow-hidden flex flex-col">
        
        <!-- é é¢ 1: ç·´ç¿’é¦–é  (Home) -->
        <div id="view-home" class="page-view flex-1 overflow-y-auto p-5 pb-24">
            <header class="mb-6 mt-4 flex justify-between items-center">
                <div>
                    <p class="text-ios-gray text-xs font-bold uppercase tracking-wider mb-1">AI Language Coach</p>
                    <h1 class="text-3xl font-bold text-slate-900">ä»Šæ—¥ç·´ç¿’</h1>
                </div>
                <!-- èªè¨€èˆ‡ç­‰ç´šé¡¯ç¤º -->
                <div class="flex flex-col items-end gap-1">
                    <button onclick="switchView('settings')" class="bg-white px-3 py-1 rounded-full text-xs font-bold shadow-sm text-ios-blue flex items-center gap-1">
                        <span id="current-lang-display">ğŸ‡¯ğŸ‡µ æ—¥èª</span>
                    </button>
                    <span id="home-level-badge" class="text-[10px] bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full font-bold">åˆç´š</span>
                </div>
            </header>

            <!-- è‡ªç”±å°è©±å¡ç‰‡ -->
            <div onclick="startChat('free')" class="bg-gradient-to-r from-blue-500 to-indigo-600 p-5 rounded-2xl shadow-lg text-white mb-6 active-scale cursor-pointer relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-xl mb-1">è‡ªç”±å°è©± (Free Talk)</h3>
                            <p class="text-blue-100 text-sm opacity-90">ä¸é™ä¸»é¡Œï¼Œåƒæœ‹å‹ä¸€æ¨£éš¨æ„èŠå¤©</p>
                        </div>
                        <i class="fa-solid fa-comments text-3xl opacity-80"></i>
                    </div>
                </div>
                <div class="absolute -right-4 -bottom-4 w-32 h-32 bg-white opacity-10 rounded-full blur-2xl"></div>
            </div>

            <!-- æƒ…å¢ƒåˆ—è¡¨ -->
            <h2 class="font-bold text-lg mb-3 ml-1 text-slate-700">æƒ…å¢ƒæ¨¡æ“¬</h2>
            <div class="space-y-3" id="scenario-list"></div>
        </div>

        <!-- é é¢ 2: èª²ç¨‹æ¨¡å¼ (Learn) -->
        <div id="view-learn" class="page-view hidden flex-1 overflow-y-auto p-5 pb-24">
            <header class="mb-6 mt-4">
                <p class="text-ios-gray text-xs font-bold uppercase tracking-wider mb-1">Curriculum</p>
                <h1 class="text-3xl font-bold">ä¸»é¡Œèª²ç¨‹</h1>
            </header>

            <div class="bg-white p-4 rounded-xl shadow-sm mb-4 border border-slate-100 flex justify-between items-center">
                <div>
                    <p class="text-sm text-slate-600">ç•¶å‰ç­‰ç´š</p>
                    <p id="learn-level-display" class="font-bold text-ios-blue text-lg">åˆç´š</p>
                </div>
                <button onclick="switchView('settings')" class="text-xs bg-slate-100 px-3 py-1.5 rounded-lg text-slate-500 font-bold">æ›´æ›ç­‰ç´š</button>
            </div>

            <div id="lesson-list" class="grid grid-cols-1 gap-3">
                <!-- èª²ç¨‹ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é é¢ 3: å–®å­—æœ¬ (Vocab) -->
        <div id="view-vocab" class="page-view hidden flex-1 overflow-y-auto p-5 pb-24">
            <header class="mb-4 mt-4 flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold">å–®å­—ç­†è¨˜</h1>
                    <p class="text-ios-gray text-sm mt-1" id="vocab-subtitle">é¡¯ç¤ºç•¶å‰èªè¨€çš„å–®å­—</p>
                </div>
                <button onclick="startQuiz()" class="bg-ios-blue text-white px-4 py-2 rounded-full text-sm font-bold shadow-md active-scale">
                    <i class="fa-solid fa-graduation-cap mr-1"></i> æ¸¬é©—
                </button>
            </header>
            
            <div id="vocab-list" class="space-y-3 pb-10"></div>
        </div>

        <!-- é é¢ 4: èŠå¤©å®¤ (å…±ç”¨è¦–çª—) -->
        <div id="view-chat" class="page-view hidden flex-1 flex flex-col h-full absolute inset-0 bg-ios-bg z-50">
            <!-- å°èˆªåˆ— -->
            <div class="glass-nav pt-safe-top px-4 py-3 flex items-center justify-between shadow-sm z-30 h-16 shrink-0">
                <button onclick="backToMain()" class="text-ios-blue flex items-center gap-1 text-lg active-scale w-16">
                    <i class="fa-solid fa-chevron-left"></i> <span class="text-base font-medium">è¿”å›</span>
                </button>
                <div class="text-center flex-1 overflow-hidden">
                    <h2 id="chat-title" class="font-bold text-base truncate px-2">å°è©±</h2>
                    <p id="chat-subtitle" class="text-[10px] text-ios-gray">AI Coach</p>
                </div>
                <div class="w-16 flex justify-end">
                     <button onclick="toggleVocabDrawer()" class="text-ios-blue text-lg active-scale">
                        <i class="fa-solid fa-book-open"></i>
                    </button>
                </div>
            </div>

            <!-- å‹•æ…‹ä»»å‹™æç¤ºæ¬„ -->
            <div id="mission-banner" class="hidden bg-indigo-50 border-b border-indigo-100 p-2 px-4 flex justify-between items-center shrink-0 min-h-[40px]">
                <span class="text-xs text-indigo-800 font-bold shrink-0"><i class="fa-solid fa-bullseye mr-1"></i> ç›®æ¨™ï¼š</span>
                <span id="mission-words" class="text-xs text-indigo-600 font-mono truncate flex-1 text-right">æ­£åœ¨ç”ŸæˆæŒ‘æˆ°è©å½™...</span>
            </div>

            <!-- å…§å®¹æ²å‹•å€ -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-4"></div>

            <!-- åº•éƒ¨è¼¸å…¥å€ -->
            <div class="bg-white border-t border-slate-200 p-3 pb-safe-bottom w-full shrink-0 relative z-30" id="chat-input-area">
                <!-- ç³¾æ­£å»ºè­°æµ®çª— -->
                <div id="correction-area" class="hidden absolute bottom-full left-0 w-full bg-yellow-50 border-t border-yellow-200 p-3 shadow-sm rounded-t-xl mb-[1px] mx-2 w-[calc(100%-1rem)]">
                    <div class="flex justify-between items-start mb-1">
                         <span class="text-xs font-bold text-yellow-800"><i class="fa-solid fa-wand-magic-sparkles"></i> å»ºè­°ä¿®æ­£</span>
                         <button onclick="document.getElementById('correction-area').classList.add('hidden')" class="text-yellow-600"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <div id="correction-text" class="text-sm"></div>
                </div>

                <div class="flex items-end gap-2">
                    <button id="mic-btn" onclick="toggleSpeech()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-lg active-scale transition-colors shrink-0">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <div class="flex-1 bg-slate-100 rounded-2xl px-4 py-2 min-h-[40px] flex items-center">
                        <textarea id="msg-input" rows="1" class="w-full bg-transparent border-none outline-none resize-none max-h-24 text-base pt-1 placeholder-slate-400" placeholder="è¼¸å…¥è¨Šæ¯..."></textarea>
                    </div>
                    <button onclick="sendUserMessage()" id="send-btn" class="w-10 h-10 rounded-full bg-ios-blue text-white flex items-center justify-center text-lg shadow-md active-scale shrink-0">
                        <i class="fa-solid fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ç¿»è­¯æŒ‰éˆ• -->
        <button id="translate-btn" class="hidden fixed z-[100] bg-slate-800 text-white text-sm py-2 px-4 rounded-full shadow-xl popover flex items-center gap-2" onclick="handleTranslate()">
            <span>ç¿»è­¯</span> <i class="fa-solid fa-plus text-xs"></i>
        </button>

        <!-- è¨­å®šé é¢ (Settings) -->
        <div id="view-settings" class="page-view hidden flex-1 overflow-y-auto p-5">
             <header class="mb-6 mt-4">
                <button onclick="switchView('home')" class="text-ios-blue mb-4 flex items-center gap-1"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
                <h1 class="text-3xl font-bold">è¨­å®š</h1>
            </header>
            
            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6">
                <div class="p-4 border-b border-slate-100">
                    <label class="block text-sm font-medium text-slate-500 mb-1">Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full text-base p-2 bg-slate-100 rounded-lg outline-none" placeholder="è²¼ä¸Š API Key">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-ios-blue mt-1 block">å–å¾—å…è²» API Key</a>
                </div>
                <div class="p-4 flex justify-between items-center border-b border-slate-100">
                    <span class="text-base font-medium">å­¸ç¿’èªè¨€</span>
                    <select id="target-lang" class="bg-transparent text-ios-blue font-bold outline-none text-right" onchange="updateLangDisplay()">
                        <option value="Japanese">æ—¥æœ¬èª (Japanese)</option>
                        <option value="English">English</option>
                        <option value="Korean">í•œêµ­ì–´ (Korean)</option>
                        <option value="French">FranÃ§ais (French)</option>
                        <option value="Spanish">EspaÃ±ol (Spanish)</option>
                    </select>
                </div>
                <div class="p-4 flex justify-between items-center">
                    <span class="text-base font-medium">ç•¶å‰ç­‰ç´š</span>
                    <select id="user-level" class="bg-transparent text-ios-blue font-bold outline-none text-right">
                        <option value="Beginner">åˆç´š (Beginner)</option>
                        <option value="Intermediate">ä¸­ç´š (Intermediate)</option>
                        <option value="Advanced">é«˜ç´š (Advanced)</option>
                    </select>
                </div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-ios-blue text-white font-bold py-3 rounded-xl shadow-md active-scale mb-8">å„²å­˜è¨­å®š</button>

            <!-- è³‡æ–™ç®¡ç† (å‚™ä»½/é‚„åŸ) -->
            <h2 class="text-lg font-bold mb-3 text-slate-700">è³‡æ–™ç®¡ç†</h2>
            <div class="bg-white rounded-xl shadow-sm overflow-hidden mb-6 p-4 space-y-3">
                <p class="text-xs text-slate-500 mb-2">æ›æ‰‹æ©Ÿå‰è«‹å…ˆå‚™ä»½ï¼Œåœ¨æ–°æ‰‹æ©Ÿä½¿ç”¨ã€Œé‚„åŸã€å³å¯è½‰ç§»è³‡æ–™ã€‚</p>
                <button onclick="exportData()" class="w-full border border-ios-blue text-ios-blue font-bold py-2.5 rounded-lg active-scale flex items-center justify-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-down"></i> å‚™ä»½è³‡æ–™ (ä¸‹è¼‰)
                </button>
                <button onclick="document.getElementById('file-input').click()" class="w-full border border-slate-300 text-slate-600 font-bold py-2.5 rounded-lg active-scale flex items-center justify-center gap-2">
                    <i class="fa-solid fa-cloud-arrow-up"></i> é‚„åŸè³‡æ–™ (ä¸Šå‚³)
                </button>
                <input type="file" id="file-input" class="hidden" accept=".json" onchange="importData(this)">
            </div>
            <div class="text-center text-xs text-slate-400 pb-10">LingoFlow Pro v2.0</div>
        </div>

    </div>

    <!-- åº•éƒ¨ Tab Bar -->
    <nav class="glass-nav h-[85px] flex justify-around items-start pt-3 absolute bottom-0 w-full z-40 pb-safe-bottom" id="tab-bar">
        <button onclick="switchView('home')" class="nav-btn active flex flex-col items-center gap-1 w-16 text-ios-blue transition-colors" data-target="home">
            <i class="fa-solid fa-house text-xl"></i>
            <span class="text-[10px] font-medium">ç·´ç¿’</span>
        </button>
        <button onclick="switchView('learn')" class="nav-btn flex flex-col items-center gap-1 w-16 text-ios-gray transition-colors" data-target="learn">
            <i class="fa-solid fa-book-open-reader text-xl"></i>
            <span class="text-[10px] font-medium">èª²ç¨‹</span>
        </button>
        <button onclick="switchView('vocab')" class="nav-btn flex flex-col items-center gap-1 w-16 text-ios-gray transition-colors" data-target="vocab">
            <i class="fa-solid fa-bookmark text-xl"></i>
            <span class="text-[10px] font-medium">å–®å­—</span>
        </button>
        <button onclick="switchView('settings')" class="nav-btn flex flex-col items-center gap-1 w-16 text-ios-gray transition-colors" data-target="settings">
            <i class="fa-solid fa-gear text-xl"></i>
            <span class="text-[10px] font-medium">è¨­å®š</span>
        </button>
    </nav>

    <script>
        // =========================================
        // 1. æ ¸å¿ƒè³‡æ–™èˆ‡åˆ†ç´šèª²ç¨‹ç³»çµ±
        // =========================================
        
        // æƒ…å¢ƒè³‡æ–™
        const scenarios = [
            { id: 'cafe', title: 'å’–å•¡å»³é»é¤', icon: 'fa-mug-hot', color: 'bg-orange-100 text-orange-600', role: 'åº—å“¡' },
            { id: 'convenience', title: 'ä¾¿åˆ©å•†åº—', icon: 'fa-store', color: 'bg-green-100 text-green-600', role: 'åº—å“¡' },
            { id: 'airport', title: 'æ©Ÿå ´å…¥å¢ƒ', icon: 'fa-plane-arrival', color: 'bg-blue-100 text-blue-600', role: 'ç§»æ°‘å®˜' },
            { id: 'hotel', title: 'é£¯åº—å…¥ä½', icon: 'fa-hotel', color: 'bg-indigo-100 text-indigo-600', role: 'æ«ƒæª¯äººå“¡' },
            { id: 'date', title: 'æµªæ¼«ç´„æœƒ', icon: 'fa-heart', color: 'bg-pink-100 text-pink-600', role: 'ç´„æœƒå°è±¡' },
            { id: 'business', title: 'å•†å‹™æœƒè­°', icon: 'fa-briefcase', color: 'bg-slate-200 text-slate-700', role: 'å®¢æˆ¶' },
            { id: 'doctor', title: 'çœ‹é†«ç”Ÿ', icon: 'fa-user-doctor', color: 'bg-red-100 text-red-600', role: 'é†«ç”Ÿ' }
        ];

        // åˆ†ç´šèª²ç¨‹è³‡æ–™åº«
        const curriculumData = {
            'Japanese': {
                'Beginner': ['äº”åéŸ³èˆ‡ç™¼éŸ³ (Hiragana/Katakana)', 'è‡ªæˆ‘ä»‹ç´¹ (Self Intro)', 'åŸºç¤æ•¸å­—èˆ‡æ™‚é–“', 'é€™/é‚£/å“ªå€‹ (Kosoado)', 'åŸºæœ¬å‹•è© (Masu-form)'],
                'Intermediate': ['å‹•è©è®ŠåŒ– (Te-form)', 'è¢«å‹•èªæ…‹ (Passive)', 'ä½¿å½¹å‹•è© (Causative)', 'åŸºç¤æ•¬èª (Keigo)', 'æ—…è¡Œæƒ…å¢ƒå°è©±'],
                'Advanced': ['å•†æ¥­éƒµä»¶å¯«ä½œ', 'æ–°èæ™‚äº‹è¨è«–', 'é«˜ç´šæ•¬èªèˆ‡è¬™è®“èª', 'æŠ½è±¡è­°é¡Œè¡¨é”', 'æ—¥æœ¬æ–‡åŒ–æ·±ç©¶']
            },
            'English': {
                'Beginner': ['Basic Greetings', 'Verb "To Be"', 'Present Simple', 'Numbers & Dates', 'Daily Routine'],
                'Intermediate': ['Past Tense vs Present Perfect', 'Future Tense', 'Modal Verbs (Can/Should)', 'Comparatives', 'Ordering Food'],
                'Advanced': ['Conditionals (If...)', 'Passive Voice', 'Business Negotiation', 'Idioms & Phrasal Verbs', 'Complex Arguments']
            },
            // å…¶ä»–èªè¨€å¯ä¾æ­¤é¡æ¨ï¼Œé€™è£¡åš Fallback
            'Korean': { 'Beginner': ['éŸ“æ–‡å­—æ¯ (Hangul)', 'åŸºæœ¬å•å€™'], 'Intermediate': ['éæ ¼å¼é«” vs æ ¼å¼é«”'], 'Advanced': ['æ–°èéŸ“èª'] },
            'French': { 'Beginner': ['Bonjour & Greetings', 'Verbs ÃŠtre/Avoir'], 'Intermediate': ['PassÃ© ComposÃ©'], 'Advanced': ['Subjonctif'] },
            'Spanish': { 'Beginner': ['Hola & Pronunciation', 'Ser vs Estar'], 'Intermediate': ['Preterite vs Imperfect'], 'Advanced': ['Subjunctive Mood'] }
        };

        const state = {
            apiKey: localStorage.getItem('gemini_api_key') || '',
            lang: localStorage.getItem('target_lang') || 'Japanese',
            level: localStorage.getItem('user_level') || 'Beginner',
            vocab: JSON.parse(localStorage.getItem('vocab_v2')) || [],
            chatHistory: [],
            currentMode: null,
            selection: null
        };

        // =========================================
        // 2. åˆå§‹åŒ–
        // =========================================
        document.addEventListener('DOMContentLoaded', () => {
            renderScenarios();
            updateLangDisplay(); // é€™ä¹Ÿæœƒè§¸ç™¼ renderLessons
            
            // è¼‰å…¥è¨­å®šå€¼
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('target-lang').value = state.lang;
            document.getElementById('user-level').value = state.level;
            
            if(!state.apiKey) switchView('settings');
            
            // Tab ç›£è½
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if(btn.dataset.target === 'learn') renderLessons();
                    if(btn.dataset.target === 'vocab') renderVocab();
                });
            });
        });

        // =========================================
        // 3. UI æ¸²æŸ“é‚è¼¯
        // =========================================
        function switchView(viewId) {
            document.querySelectorAll('.page-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');

            const tabBar = document.getElementById('tab-bar');
            if (viewId === 'chat') tabBar.classList.add('hidden');
            else tabBar.classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.dataset.target === viewId) {
                    btn.classList.add('text-ios-blue');
                    btn.classList.remove('text-ios-gray');
                } else {
                    btn.classList.remove('text-ios-blue');
                    btn.classList.add('text-ios-gray');
                }
            });
        }

        function backToMain() {
            switchView('home');
            state.chatHistory = []; 
        }

        function updateLangDisplay() {
            const map = { 'Japanese': 'ğŸ‡¯ğŸ‡µ æ—¥èª', 'English': 'ğŸ‡ºğŸ‡¸ è‹±èª', 'Korean': 'ğŸ‡°ğŸ‡· éŸ“èª', 'French': 'ğŸ‡«ğŸ‡· æ³•èª', 'Spanish': 'ğŸ‡ªğŸ‡¸ è¥¿èª' };
            const levelMap = { 'Beginner': 'åˆç´š', 'Intermediate': 'ä¸­ç´š', 'Advanced': 'é«˜ç´š' };
            
            document.getElementById('current-lang-display').innerText = map[state.lang] || state.lang;
            document.getElementById('home-level-badge').innerText = levelMap[state.level] || state.level;
            document.getElementById('learn-level-display').innerText = levelMap[state.level] || state.level;
            
            renderLessons(); // æ›´æ–°èª²ç¨‹åˆ—è¡¨
        }

        function renderScenarios() {
            const list = document.getElementById('scenario-list');
            list.innerHTML = scenarios.map(s => `
                <div onclick="startChat('${s.id}')" class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 active-scale cursor-pointer">
                    <div class="w-10 h-10 rounded-full ${s.color} flex items-center justify-center text-lg shrink-0">
                        <i class="fa-solid ${s.icon}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-bold text-base truncate">${s.title}</h3>
                        <p class="text-xs text-slate-500">è§’è‰²: ${s.role}</p>
                    </div>
                    <i class="fa-solid fa-chevron-right text-slate-300 text-sm"></i>
                </div>
            `).join('');
        }

        function renderLessons() {
            const list = document.getElementById('lesson-list');
            // æ ¹æ“šèªè¨€å’Œç­‰ç´šå–å¾—èª²ç¨‹
            const langData = curriculumData[state.lang] || curriculumData['English'];
            const levelData = langData[state.level] || langData['Beginner'];
            
            list.innerHTML = levelData.map(topic => `
                <div onclick="startLesson('${topic}')" class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 active-scale cursor-pointer relative overflow-hidden group">
                     <div class="flex justify-between items-center z-10 relative">
                        <div>
                            <span class="bg-blue-100 text-blue-700 text-[10px] font-bold px-2 py-0.5 rounded mb-1 inline-block">Lesson</span>
                            <h3 class="font-bold text-lg text-slate-800">${topic}</h3>
                        </div>
                        <i class="fa-solid fa-play text-ios-blue bg-blue-50 w-8 h-8 flex items-center justify-center rounded-full"></i>
                     </div>
                </div>
            `).join('');
        }

        // =========================================
        // 4. API å‘¼å« (gemini-1.5-flash) èˆ‡ éŒ¯èª¤ä¿®å¾©
        // =========================================
        
        async function callGeminiAPI(contents, isJsonMode = false) {
            if(!state.apiKey) throw new Error("è«‹å…ˆè¨­å®š API Key");

            // å¼·åˆ¶ä½¿ç”¨æ­£ç¢ºçš„æ¨¡å‹åç¨±ï¼Œä¸å«ç©ºæ ¼
            const modelName = "gemini-1.5-flash"; 
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${state.apiKey}`;

            const config = {
                temperature: 0.7,
                maxOutputTokens: 800,
            };
            
            // å¦‚æœéœ€è¦ JSON æ ¼å¼ (ä¾‹å¦‚ç”Ÿæˆå–®å­—)
            if(isJsonMode) {
                config.responseMimeType = "application/json";
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents,
                    generationConfig: config
                })
            });

            const data = await response.json();
            
            if(data.error) {
                console.error("Gemini API Error:", data.error);
                throw new Error(data.error.message || "API é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Key æˆ–ç¶²è·¯");
            }

            return data.candidates[0].content.parts[0].text;
        }

        // =========================================
        // 5. èŠå¤©èˆ‡èª²ç¨‹é‚è¼¯ (å‹•æ…‹ç›®æ¨™è©å½™)
        // =========================================

        async function generateMissionWords(scenarioTitle) {
            const missionEl = document.getElementById('mission-words');
            missionEl.innerText = "æ­£åœ¨åˆ†æå ´æ™¯ä¸¦ç”ŸæˆæŒ‘æˆ°è©å½™...";
            
            const prompt = `Generate 3 distinct, useful vocabulary words (or short phrases) for a ${state.level} learner of ${state.lang} specifically for the scenario: "${scenarioTitle}". 
            Return ONLY a raw JSON array of strings. Example: ["Word1", "Word2", "Word3"]`;

            try {
                const text = await callGeminiAPI([{ role: "user", parts: [{ text: prompt }] }], true);
                const words = JSON.parse(text);
                missionEl.innerText = words.join(', ');
                return words;
            } catch (e) {
                console.error("Mission gen failed", e);
                missionEl.innerText = "ç„¡æ³•ç”Ÿæˆè©å½™ (ç¶²è·¯å•é¡Œ)";
                return [];
            }
        }

        async function startChat(scenarioId) {
            if(!state.apiKey) return switchView('settings');

            state.currentMode = 'chat';
            state.chatHistory = [];
            switchView('chat');
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('correction-area').classList.add('hidden');
            document.getElementById('chat-input-area').classList.remove('hidden');

            const isFreeTalk = scenarioId === 'free';
            const scenario = scenarios.find(s => s.id === scenarioId) || { title: 'Free Talk', role: 'Friend' };
            
            document.getElementById('chat-title').innerText = isFreeTalk ? 'è‡ªç”±å°è©±' : scenario.title;
            document.getElementById('chat-subtitle').innerText = isFreeTalk ? 'Free Talk' : `Role: ${scenario.role}`;
            
            // è™•ç†ç›®æ¨™å–®å­—
            const missionBanner = document.getElementById('mission-banner');
            let missionWords = [];

            if(!isFreeTalk) {
                missionBanner.classList.remove('hidden');
                // éåŒæ­¥ç”Ÿæˆå–®å­—ï¼Œä¸å¡ä½ UI
                generateMissionWords(scenario.title).then(words => {
                     missionWords = words;
                     // å–®å­—ç”Ÿæˆå¾Œï¼Œå¯ä»¥å·å·ç™¼ä¸€å€‹ system prompt çµ¦ AI (å¦‚æœéœ€è¦æ›´å¼·çš„å¼•å°)
                     // ä½†ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘ç›´æ¥åœ¨ä¸‹é¢çš„ initial prompt å‘Šè¨´ AI æ™šé»å†å¼•å°ï¼Œæˆ–è€…é€™è£¡åƒ…ä½œ UI æç¤º
                });
            } else {
                missionBanner.classList.add('hidden');
            }

            // ç³»çµ±æç¤ºè©
            let systemPrompt = `
                Act as a language teacher/partner. 
                Language: ${state.lang}. User Level: ${state.level}.
                ${isFreeTalk ? 'Role: Friend. Chat casually.' : `Roleplay Scenario: ${scenario.title}. You are: ${scenario.role}.`}
                
                Instructions:
                1. Keep replies concise (1-3 sentences).
                2. If the user makes a grammar mistake, append a JSON correction at the end.
                3. Adjust your vocabulary to match the user's level (${state.level}).
                
                Response Format:
                [Dialogue Text]
                |||
                { "original": "user input", "correction": "corrected version", "reason": "brief explanation" } (Only if error exists, else null)
            `;

            addMessage('ai', 'Thinking...');
            // å‘¼å« API
            try {
                const contents = [{ role: "user", parts: [{ text: systemPrompt + " (Start the conversation now)" }] }];
                const response = await callGeminiAPI(contents);
                processAIResponse(response, true);
                // å„²å­˜ Context
                state.chatHistory.push({ role: 'user', text: systemPrompt + " (Start)" }); 
                state.chatHistory.push({ role: 'model', text: response.split('|||')[0].trim() });
            } catch(e) {
                document.getElementById('chat-container').innerHTML = `<div class="text-center text-red-500 mt-5">${e.message}</div>`;
            }
        }

        async function startLesson(topic) {
            if(!state.apiKey) return switchView('settings');
            
            state.currentMode = 'lesson';
            state.chatHistory = [];
            switchView('chat');
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('mission-banner').classList.add('hidden');
            document.getElementById('chat-title').innerText = topic;
            document.getElementById('chat-subtitle').innerText = 'AI Tutor';

            const systemPrompt = `
                You are a professional language tutor teaching ${state.lang}.
                Topic: ${topic}. Target Level: ${state.level}.
                
                Please teach this concept clearly. 
                Structure:
                1. Explanation (Concise)
                2. Examples (with translations)
                3. A practice question for the user to try.
                
                Use Markdown for formatting.
            `;

            addMessage('ai', 'Preparing lesson...');
            try {
                const contents = [{ role: "user", parts: [{ text: systemPrompt }] }];
                const response = await callGeminiAPI(contents);
                processAIResponse(response, true);
                state.chatHistory.push({ role: 'user', text: systemPrompt });
                state.chatHistory.push({ role: 'model', text: response });
            } catch(e) {
                document.getElementById('chat-container').innerHTML = `<div class="text-center text-red-500 mt-5">${e.message}</div>`;
            }
        }

        async function sendUserMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            addMessage('user', text);
            input.value = '';
            input.style.height = 'auto'; 
            document.getElementById('correction-area').classList.add('hidden');

            // æº–å‚™ loading
            const loadingId = addLoadingIndicator();

            try {
                // å»ºæ§‹æ­·å²ç´€éŒ„
                let contents = state.chatHistory.map(m => ({
                    role: m.role === 'user' ? 'user' : 'model',
                    parts: [{ text: m.text }]
                }));
                contents.push({ role: "user", parts: [{ text: text }] });

                const rawText = await callGeminiAPI(contents);
                removeLoadingIndicator(loadingId);
                
                processAIResponse(rawText);

                // æ›´æ–°æ­·å²
                state.chatHistory.push({ role: 'user', text: text });
                state.chatHistory.push({ role: 'model', text: rawText.split('|||')[0].trim() });

            } catch (error) {
                removeLoadingIndicator(loadingId);
                addMessage('system', 'Error: ' + error.message);
            }
        }

        function processAIResponse(rawText, isInit = false) {
            if(isInit) document.getElementById('chat-container').innerHTML = '';
            
            const parts = rawText.split('|||');
            const dialogue = parts[0].trim();
            
            addMessage('ai', dialogue);

            if(state.currentMode === 'chat' && parts.length > 1) {
                try {
                    const json = JSON.parse(parts[1].trim());
                    if(json && json.correction) showCorrection(json);
                } catch(e) {}
            }
        }

        function showCorrection(data) {
            const area = document.getElementById('correction-area');
            const text = document.getElementById('correction-text');
            area.classList.remove('hidden');
            text.innerHTML = `
                <div class="flex flex-col">
                    <span class="line-through text-red-400 text-xs">${data.original}</span>
                    <span class="text-green-600 font-bold">${data.correction}</span>
                    <span class="text-xs text-slate-500 mt-1">${data.reason}</span>
                </div>
            `;
        }

        function addMessage(role, text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            const htmlText = marked.parse(text);

            if(role === 'user') {
                div.className = "flex justify-end animate-fade-in";
                div.innerHTML = `<div class="bg-ios-blue text-white px-4 py-2 rounded-2xl rounded-tr-sm max-w-[85%] text-base shadow-sm break-words">${text}</div>`;
            } else if(role === 'ai') {
                div.className = "flex justify-start animate-fade-in mb-4";
                div.innerHTML = `
                    <div class="flex items-end gap-2 max-w-[95%]">
                        <div class="w-6 h-6 rounded-full bg-gradient-to-tr from-purple-500 to-blue-500 shrink-0 flex items-center justify-center text-[10px] text-white font-bold mb-1">AI</div>
                        <div class="bg-white px-4 py-2 rounded-2xl rounded-tl-sm shadow-sm text-slate-800 text-base prose prose-sm max-w-none selectable-text">
                            ${htmlText}
                        </div>
                    </div>
                `;
            } else if (role === 'system') {
                div.className = "text-center text-xs text-red-400 my-2";
                div.innerText = text;
            }

            container.appendChild(div);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
        }

        function addLoadingIndicator() {
            const container = document.getElementById('chat-container');
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex justify-start items-center gap-2 ml-10 mb-4";
            div.innerHTML = `
                <div class="bg-slate-200 px-3 py-2 rounded-xl rounded-tl-sm flex gap-1">
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            return id;
        }

        function removeLoadingIndicator(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // =========================================
        // 6. å–®å­—èˆ‡ç¿»è­¯ç³»çµ±
        // =========================================
        
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection();
            const btn = document.getElementById('translate-btn');
            const text = selection.toString().trim();

            if (!text || text.length > 50 || (state.currentMode !== 'chat' && state.currentMode !== 'lesson')) {
                btn.classList.add('hidden');
                return;
            }

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            btn.style.top = `${rect.bottom + 10}px`;
            btn.style.left = `50%`;
            btn.style.transform = `translateX(-50%)`;
            state.selection = text;
            btn.classList.remove('hidden');
        });

        async function handleTranslate() {
            const word = state.selection;
            const btn = document.getElementById('translate-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                const prompt = `Translate "${word}" to Traditional Chinese. Source: ${state.lang}. Return JSON: {"meaning": "xxx", "pos": "noun/verb/phrase"}`;
                const text = await callGeminiAPI([{ role: "user", parts: [{ text: prompt }] }], true);
                const data = JSON.parse(text);

                const newItem = {
                    id: Date.now(),
                    word,
                    meaning: data.meaning,
                    pos: data.pos,
                    lang: state.lang,
                    date: new Date().toLocaleDateString()
                };

                state.vocab.unshift(newItem);
                localStorage.setItem('vocab_v2', JSON.stringify(state.vocab));
                
                btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²æ”¶è—';
                setTimeout(() => {
                    btn.classList.add('hidden');
                    btn.innerHTML = 'ç¿»è­¯';
                    window.getSelection().removeAllRanges();
                }, 1000);

            } catch(e) {
                alert('ç¿»è­¯éŒ¯èª¤');
                btn.classList.add('hidden');
            }
        }

        function renderVocab() {
            const list = document.getElementById('vocab-list');
            const subtitle = document.getElementById('vocab-subtitle');
            const filtered = state.vocab.filter(v => v.lang === state.lang);
            
            subtitle.innerText = `${state.lang} æ”¶è—ï¼š${filtered.length} å€‹`;

            if(filtered.length === 0) {
                list.innerHTML = `<div class="text-center text-slate-400 mt-10">å°šç„¡ ${state.lang} å–®å­—</div>`;
                return;
            }

            list.innerHTML = filtered.map(v => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center group">
                    <div>
                        <div class="flex items-baseline gap-2">
                            <h4 class="font-bold text-lg text-slate-800">${v.word}</h4>
                            <span class="text-[10px] bg-slate-100 px-1 rounded text-slate-500">${v.pos || ''}</span>
                        </div>
                        <p class="text-slate-600 text-sm">${v.meaning}</p>
                    </div>
                    <button onclick="deleteVocab(${v.id})" class="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-red-500">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function deleteVocab(id) {
            state.vocab = state.vocab.filter(v => v.id !== id);
            localStorage.setItem('vocab_v2', JSON.stringify(state.vocab));
            renderVocab();
        }

        // =========================================
        // 7. è¨­å®šã€å‚™ä»½èˆ‡å…¶ä»–
        // =========================================
        function saveSettings() {
            const key = document.getElementById('api-key-input').value;
            const lang = document.getElementById('target-lang').value;
            const level = document.getElementById('user-level').value;

            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('target_lang', lang);
            localStorage.setItem('user_level', level);
            
            state.apiKey = key;
            state.lang = lang;
            state.level = level;

            updateLangDisplay();
            switchView('home');
        }

        function exportData() {
            const backupData = {
                version: '2.0',
                date: new Date().toLocaleString(),
                vocab: state.vocab,
                settings: { apiKey: state.apiKey, lang: state.lang, level: state.level }
            };
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            a.href = url;
            a.download = `LingoFlow_Backup_${dateStr}.json`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 0);
        }

        function importData(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (!confirm(`ç¢ºå®šè¦é‚„åŸå‚™ä»½ (æ—¥æœŸ: ${json.date}) å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ã€‚`)) return;
                    if (json.settings) {
                        localStorage.setItem('gemini_api_key', json.settings.apiKey || '');
                        localStorage.setItem('target_lang', json.settings.lang || 'Japanese');
                        localStorage.setItem('user_level', json.settings.level || 'Beginner');
                    }
                    if (json.vocab) localStorage.setItem('vocab_v2', JSON.stringify(json.vocab));
                    alert("âœ… é‚„åŸæˆåŠŸï¼");
                    location.reload();
                } catch (err) { alert("âŒ é‚„åŸå¤±æ•—ï¼š" + err.message); }
            };
            reader.readAsText(file);
        }

        // èªéŸ³è¼¸å…¥ (æ”¯æ´å¤šèª)
        function toggleSpeech() {
            if (!('webkitSpeechRecognition' in window)) return alert('æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥');
            const recognition = new webkitSpeechRecognition();
            const langMap = {'Japanese': 'ja-JP', 'English': 'en-US', 'Korean': 'ko-KR', 'French': 'fr-FR', 'Spanish': 'es-ES'};
            recognition.lang = langMap[state.lang];
            recognition.onstart = () => document.getElementById('mic-btn').classList.add('text-red-500', 'animate-pulse');
            recognition.onend = () => document.getElementById('mic-btn').classList.remove('text-red-500', 'animate-pulse');
            recognition.onresult = (e) => { document.getElementById('msg-input').value += e.results[0][0].transcript; };
            recognition.start();
        }
        
        // Input Auto Height
        document.getElementById('msg-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

    </script>
</body>
</html>