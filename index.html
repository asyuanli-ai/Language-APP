<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoFlow v11.0 Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 h-screen flex flex-col font-sans">
    <div class="p-4 bg-white shadow-sm flex justify-between items-center">
        <h1 class="font-bold text-xl text-blue-600">LingoFlow</h1>
        <button onclick="localStorage.clear();location.reload();" class="text-xs text-red-500 underline">清除緩存並重啟</button>
    </div>

    <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 text-sm leading-relaxed">
            系統已就緒。請確認您已貼上新的 API Key。<br><br>
            <b>提示：</b>選取對話文字可自動收藏至單字本。
        </div>
    </div>

    <div class="p-4 bg-white border-t space-y-3">
        <div id="vocab-hint" class="hidden text-xs bg-black text-white p-2 rounded-lg flex justify-between items-center">
            <span>收藏單字：<b id="sel-word"></b></span>
            <button onclick="doSave()" class="bg-blue-500 px-2 py-1 rounded">確認</button>
        </div>
        <div class="flex gap-2">
            <input type="text" id="user-input" class="flex-1 border rounded-full px-5 py-3 outline-none focus:ring-2 focus:ring-blue-500" placeholder="輸入 API Key 或對話...">
            <button onclick="handleMain()" class="bg-blue-600 text-white w-12 h-12 rounded-full shadow-lg">↑</button>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('v11_key') || '';
        let vocabs = JSON.parse(localStorage.getItem('v11_vocabs') || '[]');

        // 劃詞收藏功能
        document.addEventListener('mouseup', () => {
            const word = window.getSelection().toString().trim();
            if (word && word.length < 30) {
                document.getElementById('sel-word').innerText = word;
                document.getElementById('vocab-hint').classList.remove('hidden');
            } else {
                document.getElementById('vocab-hint').classList.add('hidden');
            }
        });

        function doSave() {
            const w = document.getElementById('sel-word').innerText;
            if(!vocabs.includes(w)) {
                vocabs.push(w);
                localStorage.setItem('v11_vocabs', JSON.stringify(vocabs));
                alert('已收藏：' + w);
            }
        }

        async function handleMain() {
            const input = document.getElementById('user-input');
            const val = input.value.trim();
            if(!val) return;

            // 如果輸入看起來像 Key
            if(val.startsWith('AIza')) {
                apiKey = val;
                localStorage.setItem('v11_key', apiKey);
                addMsg('system', '✅ 金鑰已更新！現在可以開始對話。');
                input.value = '';
                return;
            }

            if(!apiKey) return addMsg('system', '❌ 請先貼上 AIza 開頭的 API Key。');

            addMsg('user', val);
            input.value = '';

            // 解決 404 的核心路徑切換
            const paths = [
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`,
                `https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=${apiKey}`
            ];

            let success = false;
            for(let url of paths) {
                if(success) break;
                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: val }] }] })
                    });
                    const data = await res.json();
                    if(res.ok) {
                        addMsg('ai', data.candidates[0].content.parts[0].text);
                        success = true;
                    } else if(res.status !== 404) {
                        addMsg('system', `錯誤 ${res.status}: ${data.error.message}`);
                        break;
                    }
                } catch(e) { console.error(e); }
            }
            if(!success) addMsg('system', '❌ 依然 404。請確認 Console 頁面的「啟用」按鈕是否已按下。');
        }

        function addMsg(role, text) {
            const box = document.getElementById('chat-box');
            const d = document.createElement('div');
            d.className = `flex ${role==='user'?'justify-end':role==='system'?'justify-center':'justify-start'}`;
            const innerClass = role==='user'?'bg-blue-600 text-white':role==='system'?'text-gray-400 text-[10px] italic':'bg-white border';
            d.innerHTML = `<div class="${innerClass} p-3 rounded-2xl shadow-sm max-w-[85%] text-sm">${text}</div>`;
            box.appendChild(d);
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>