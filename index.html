<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F2F7">
    <title>LingoFlow v25.0 Fixed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        .selectable { user-select: text; }
        body { background-color: #F2F2F7; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; overflow: hidden; color: #1c1c1e; }
        .page-view { position: absolute; inset: 0; bottom: 85px; overflow-y: auto; padding: 20px; scroll-behavior: smooth; -webkit-overflow-scrolling: touch; padding-bottom: 120px; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); border-top: 1px solid rgba(0,0,0,0.1); }
        
        /* ä¿®æ­£ï¼šä½¿ç”¨ Button ç¢ºä¿é»æ“Šæœ‰æ•ˆ */
        .ios-btn-card { 
            width: 100%; display: flex; align-items: center; text-align: left;
            background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.02); 
            transition: 0.1s; position: relative;
        }
        .ios-btn-card:active { background-color: #e5e5ea; transform: scale(0.98); }
        
        #word-tools { display: none; position: absolute; background: #1c1c1e; color: white; padding: 8px 16px; border-radius: 12px; z-index: 2000; font-size: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); pointer-events: auto; }
        
        /* Loading Spinner */
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-left-color: #007AFF; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-[100dvh] w-screen">

    <div id="word-tools">
        <div class="flex items-center gap-3">
            <span id="sel-text" class="max-w-[120px] truncate opacity-90 border-r border-gray-500 pr-3 font-medium"></span>
            <button onclick="app.translateAndSave()" class="text-blue-400 font-bold whitespace-nowrap active:opacity-50">ç¿»è­¯æ”¶è—</button>
        </div>
    </div>

    <div id="app-root" class="h-full relative">

        <div id="view-home" class="page-view">
            <div class="flex justify-between items-center mb-4 mt-2">
                <h1 class="text-3xl font-bold tracking-tight">LingoFlow</h1>
                <span id="current-lang-badge" class="px-3 py-1 bg-gray-200 rounded-full text-xs font-bold text-gray-500">English</span>
            </div>
            
            <div class="bg-gray-200/80 p-1 rounded-xl flex mb-6 text-xs font-bold text-center">
                <button onclick="app.setLevel('Easy')" id="lvl-Easy" class="flex-1 py-2 rounded-lg bg-white shadow-sm transition-all">åˆç´š (Survival)</button>
                <button onclick="app.setLevel('Medium')" id="lvl-Medium" class="flex-1 py-2 rounded-lg text-gray-500 transition-all">ä¸­ç´š (Life)</button>
                <button onclick="app.setLevel('Hard')" id="lvl-Hard" class="flex-1 py-2 rounded-lg text-gray-500 transition-all">é«˜ç´š (Biz/Social)</button>
            </div>

            <button onclick="app.initChat('Free Talk', 'Friend')" class="w-full text-left bg-gradient-to-br from-[#007AFF] to-[#0055ff] p-6 rounded-[24px] text-white mb-8 shadow-lg shadow-blue-200 active:scale-95 transition-all relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="font-bold text-xl">Free Talk (è‡ªç”±å°è©±)</h3>
                    <p class="text-blue-100 text-sm mt-1 opacity-90">ä¸é™ä¸»é¡Œ â€¢ éš¨æ„èŠèŠ</p>
                </div>
                <i class="fa-solid fa-comments absolute -bottom-3 -right-3 text-7xl text-white opacity-20"></i>
            </button>

            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 ml-1">å¯¦ç”¨æƒ…å¢ƒ</h2>
            <div id="scenario-list"></div>
        </div>

        <div id="view-learn" class="page-view hidden">
            <h1 class="text-3xl font-bold mb-6 mt-2 tracking-tight">å¯¦æˆ°èª²ç¨‹</h1>
            <div id="lesson-list"></div>
        </div>

        <div id="view-vocab" class="page-view hidden">
            <div class="flex justify-between items-end mb-6 mt-2">
                <h1 class="text-3xl font-bold tracking-tight">å–®å­—æœ¬</h1>
                <button onclick="app.startQuiz()" class="bg-orange-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow active:scale-95">æ¸¬é©—</button>
            </div>
            <div id="vocab-display-list"></div>
        </div>

        <div id="view-settings" class="page-view hidden">
            <h1 class="text-3xl font-bold mb-6 mt-2 tracking-tight">è¨­å®š</h1>
            <div class="bg-white rounded-2xl overflow-hidden shadow-sm mb-6 border border-gray-100">
                <div class="p-4 border-b border-gray-100">
                    <label class="text-xs font-bold text-gray-400 uppercase">API Key</label>
                    <input type="password" id="api-key-input" class="w-full mt-2 outline-none text-sm bg-transparent" placeholder="AIza...">
                </div>
                <div class="p-4 border-b border-gray-100">
                    <label class="text-xs font-bold text-gray-400 uppercase">Project ID</label>
                    <input type="text" id="project-id-input" class="w-full mt-2 outline-none text-sm bg-transparent" placeholder="language-app-xxx">
                </div>
                <div class="p-4">
                    <label class="text-xs font-bold text-gray-400 uppercase">ç·´ç¿’èªè¨€</label>
                    <select id="target-lang" class="w-full mt-2 outline-none bg-transparent font-bold text-blue-600 text-base" onchange="app.handleLangChange()">
                        <option value="English">English</option>
                        <option value="Japanese">æ—¥æœ¬èª</option>
                        <option value="Korean">í•œêµ­ì–´</option>
                    </select>
                </div>
            </div>
            <button onclick="app.saveSettings()" class="w-full bg-[#007AFF] text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 text-sm">å„²å­˜è¨­å®š</button>
            <div class="mt-8 text-center">
                <button onclick="alert('JS Status: OK')" class="text-[10px] text-gray-300 bg-gray-100 px-2 py-1 rounded">Debug Check</button>
            </div>
        </div>

        <div id="view-chat" class="fixed inset-0 bg-[#F2F2F7] z-50 hidden flex flex-col translate-x-full transition-transform duration-300">
            <div class="h-[60px] bg-white/95 backdrop-blur flex justify-between items-center px-4 border-b shadow-sm z-10 pt-2">
                <button onclick="app.closeChat()" class="text-[#007AFF] flex items-center gap-1 font-medium active:opacity-50 p-2"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
                <div class="text-center">
                    <h2 id="chat-title" class="font-bold text-base text-slate-800">å°è©±</h2>
                    <span id="chat-status" class="text-[10px] text-gray-400 block leading-none mt-0.5">æº–å‚™ä¸­...</span>
                </div>
                <div class="w-16"></div>
            </div>
            
            <div id="mission-bar" class="bg-blue-50 px-4 py-3 text-xs text-blue-800 border-b border-blue-100 hidden">
                <div class="font-bold mb-1"><i class="fa-solid fa-bullseye mr-1"></i>æŒ‘æˆ°å–®å­— (Mission):</div>
                <div id="mission-words" class="font-mono bg-white px-2 py-1 rounded border border-blue-200 text-center"></div>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

            <div class="bg-white border-t p-3 pb-8 flex items-end gap-2">
                <button id="btn-mic" onclick="app.toggleSpeech()" class="w-10 h-10 rounded-full text-gray-400 bg-gray-50 border border-gray-200 flex items-center justify-center active:bg-gray-200">
                    <i class="fa-solid fa-microphone text-lg"></i>
                </button>
                <div class="flex-1 bg-gray-100 rounded-2xl px-4 py-2 min-h-[40px] flex items-center border border-transparent focus-within:border-blue-300 focus-within:bg-white transition-all">
                    <input type="text" id="msg-input" class="w-full bg-transparent outline-none text-base text-slate-800" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') app.sendUserMessage()">
                </div>
                <button onclick="app.sendUserMessage()" class="w-10 h-10 bg-[#007AFF] text-white rounded-full flex items-center justify-center shadow-lg active:scale-90">
                    <i class="fa-solid fa-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>

    <nav class="glass-nav fixed bottom-0 w-full h-[85px] flex justify-around pt-3 z-40 text-[10px] font-medium">
        <button onclick="app.switchView('home')" class="nav-btn text-[#007AFF] flex flex-col items-center gap-1 w-full"><i class="fa-solid fa-house text-xl"></i><span>é¦–é </span></button>
        <button onclick="switchView('learn')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full"><i class="fa-solid fa-graduation-cap text-xl"></i><span>èª²ç¨‹</span></button>
        <button onclick="switchView('vocab')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full"><i class="fa-solid fa-book-bookmark text-xl"></i><span>å–®å­—</span></button>
        <button onclick="switchView('settings')" class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full"><i class="fa-solid fa-gear text-xl"></i><span>è¨­å®š</span></button>
    </nav>

    <script>
        // è³‡æ–™åº«ï¼šå°ˆæ³¨æ–¼ã€Œå¯¦ç”¨æ€§ã€
        const DB = {
            English: {
                scenarios: [
                    { t: 'Supermarket', r: 'Cashier', i: 'fa-cart-shopping', c: 'text-orange-600 bg-orange-50' },
                    { t: 'Doctor', r: 'Doctor', i: 'fa-user-doctor', c: 'text-red-600 bg-red-50' },
                    { t: 'Immigration', r: 'Officer', i: 'fa-passport', c: 'text-blue-800 bg-blue-50' },
                    { t: 'Taxi', r: 'Driver', i: 'fa-taxi', c: 'text-yellow-600 bg-yellow-50' },
                    { t: 'Hotel', r: 'Receptionist', i: 'fa-bell', c: 'text-indigo-600 bg-indigo-50' },
                    { t: 'Restaurant', r: 'Waiter', i: 'fa-utensils', c: 'text-emerald-600 bg-emerald-50' }
                ],
                curriculum: {
                    Easy: [
                        { t: 'Survival: Toilet & Water', d: 'Asking for basic needs' },
                        { t: 'Shopping: How much?', d: 'Numbers and prices' },
                        { t: 'Food: Ordering Fast Food', d: 'Burgers, fries, and sizes' },
                        { t: 'Travel: Taxi to Hotel', d: 'Giving destinations' }
                    ],
                    Medium: [
                        { t: 'Problem: Return a Shirt', d: 'Explaining a defect' },
                        { t: 'Health: I have a headache', d: 'Describing symptoms' },
                        { t: 'Social: Small Talk', d: 'Weather and weekend plans' },
                        { t: 'Work: Changing a Meeting', d: 'Time and dates' }
                    ],
                    Hard: [
                        { t: 'Biz: Negotiating Price', d: 'Persuasion skills' },
                        { t: 'Social: Polite Refusal', d: 'Saying no without offending' },
                        { t: 'Opinion: Debating News', d: 'Expressing complex thoughts' },
                        { t: 'Work: Explaining Mistakes', d: 'Taking responsibility professionally' }
                    ]
                }
            },
            Japanese: {
                scenarios: [
                    { t: 'ã‚³ãƒ³ãƒ“ãƒ‹ (Combini)', r: 'åº—å“¡', i: 'fa-store', c: 'text-orange-600 bg-orange-50' },
                    { t: 'ç—…é™¢ (Hospital)', r: 'åŒ»è€…', i: 'fa-user-doctor', c: 'text-red-600 bg-red-50' },
                    { t: 'å±…é…’å±‹ (Izakaya)', r: 'åº—å“¡', i: 'fa-beer-mug-empty', c: 'text-yellow-600 bg-yellow-50' },
                    { t: 'ç¾å®¹é™¢ (Hair Salon)', r: 'ç¾å®¹å¸«', i: 'fa-scissors', c: 'text-pink-600 bg-pink-50' },
                    { t: 'é§… (Station)', r: 'é§…å“¡', i: 'fa-train', c: 'text-blue-600 bg-blue-50' },
                    { t: 'æ—…é¤¨ (Ryokan)', r: 'å¥³å°†', i: 'fa-bed', c: 'text-indigo-600 bg-indigo-50' }
                ],
                curriculum: {
                    Easy: [
                        { t: 'ç”Ÿå­˜: ãƒˆã‚¤ãƒ¬ã¯ã©ã“ï¼Ÿ', d: 'å ´æ‰€ã‚’å°‹ã­ã‚‹ (Where is...)' },
                        { t: 'è²·ã„ç‰©: ã„ãã‚‰ã§ã™ã‹', d: 'å€¤æ®µã¨æ•°å­— (Prices)' },
                        { t: 'é£Ÿäº‹: ã“ã‚Œã‚’ãã ã•ã„', d: 'æ³¨æ–‡ã®åŸºæœ¬ (Ordering)' },
                        { t: 'ç§»å‹•: ãƒã‚¹ã«ä¹—ã‚‹', d: 'è¡Œãå…ˆã‚’è¨€ã† (Destinations)' }
                    ],
                    Medium: [
                        { t: 'ç¾å®¹é™¢: ã‚«ãƒƒãƒˆã®æ³¨æ–‡', d: 'å†™çœŸã‚’è¦‹ã›ã¦é ¼ã‚€ (Requests)' },
                        { t: 'ç—…é™¢: é ­ãŒç—›ã„ã§ã™', d: 'ç—‡çŠ¶ã‚’ä¼ãˆã‚‹ (Symptoms)' },
                        { t: 'ãƒˆãƒ©ãƒ–ãƒ«: è½ã¨ã—ç‰©', d: 'é§…å“¡ã«èª¬æ˜ã™ã‚‹ (Lost items)' },
                        { t: 'æ–­ã‚‹: èª˜ã„ã‚’æ–­ã‚‹', d: 'è¡Œã‘ã¾ã›ã‚“ã¨ä¼ãˆã‚‹ (Refusing)' }
                    ],
                    Hard: [
                        { t: 'æ•¬èª: ç›®ä¸Šã®äººã¸ã®ãƒ¡ãƒ¼ãƒ«', d: 'ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ« (Business Email)' },
                        { t: 'è¬ç½ª: ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ', d: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ (Apologizing)' },
                        { t: 'è­°è«–: ãƒ‹ãƒ¥ãƒ¼ã‚¹ã«ã¤ã„ã¦', d: 'æ„è¦‹ã‚’è¨€ã† (Opinions)' },
                        { t: 'ä¾é ¼: ä»•äº‹ã‚’é ¼ã‚€', d: 'ä¸å¯§ã«ãŠé¡˜ã„ã™ã‚‹ (Requests)' }
                    ]
                }
            },
            Korean: {
                scenarios: [
                    { t: 'í¸ì˜ì  (Store)', r: 'ì§ì›', i: 'fa-store', c: 'text-blue-600 bg-blue-50' },
                    { t: 'íƒì‹œ (Taxi)', r: 'ê¸°ì‚¬ë‹˜', i: 'fa-taxi', c: 'text-yellow-600 bg-yellow-50' },
                    { t: 'ì‹ë‹¹ (Restaurant)', r: 'ì´ëª¨ë‹˜', i: 'fa-utensils', c: 'text-red-600 bg-red-50' }
                ],
                curriculum: {
                    Easy: [{ t: 'Survival: Toilet', d: 'Basic locations' }, { t: 'Food: Ordering', d: 'Basic menu' }],
                    Medium: [{ t: 'Shopping: Bargaining', d: 'Asking for discount' }, { t: 'Travel: Asking Way', d: 'Directions' }],
                    Hard: [{ t: 'Work: Email', d: 'Formal writing' }, { t: 'Social: Honorifics', d: 'Respectful speech' }]
                }
            }
        };

        // å‘½åç©ºé–“ App é˜²æ­¢å…¨åŸŸè®Šæ•¸æ±™æŸ“
        const app = {
            state: {
                apiKey: localStorage.getItem('v25_key') || '',
                projectId: localStorage.getItem('v25_proj') || '',
                lang: localStorage.getItem('v25_lang') || 'English',
                level: localStorage.getItem('v25_level') || 'Medium',
                vocabs: JSON.parse(localStorage.getItem('v25_vocabs') || '[]'),
                chatHistory: []
            },

            init: function() {
                document.getElementById('api-key-input').value = this.state.apiKey;
                document.getElementById('project-id-input').value = this.state.projectId;
                document.getElementById('target-lang').value = this.state.lang;
                
                this.setLevel(this.state.level);
                this.updateUI();
                document.addEventListener('mouseup', this.handleTextSelection.bind(this));
            },

            handleLangChange: function() {
                this.state.lang = document.getElementById('target-lang').value;
                this.updateUI();
            },

            updateUI: function() {
                document.getElementById('current-lang-badge').innerText = this.state.lang;
                this.renderScenarios();
                this.renderLessons();
                this.renderVocabs();
            },

            setLevel: function(lvl) {
                this.state.level = lvl;
                localStorage.setItem('v25_level', lvl);
                ['Easy', 'Medium', 'Hard'].forEach(l => {
                    const el = document.getElementById(`lvl-${l}`);
                    el.className = l === lvl 
                        ? "flex-1 py-2 rounded-lg bg-white shadow-sm transition-all text-blue-600 ring-1 ring-blue-100 font-bold" 
                        : "flex-1 py-2 rounded-lg text-gray-500 transition-all hover:bg-gray-100";
                });
                this.renderLessons();
            },

            renderScenarios: function() {
                const list = document.getElementById('scenario-list');
                const data = DB[this.state.lang].scenarios || [];
                list.innerHTML = data.map(s => `
                    <button onclick="app.initChat('${s.t}', '${s.r}')" class="ios-btn-card">
                        <div class="w-10 h-10 rounded-xl ${s.c} flex items-center justify-center text-lg mr-4 shrink-0"><i class="fa-solid ${s.i}"></i></div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-800 text-base">${s.t}</div>
                            <div class="text-xs text-slate-400 font-medium">Role: ${s.r}</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                    </button>
                `).join('');
            },

            renderLessons: function() {
                const list = document.getElementById('lesson-list');
                const data = DB[this.state.lang].curriculum[this.state.level] || [];
                list.innerHTML = data.map((l, i) => `
                    <button onclick="app.initChat('Lesson: ${l.t}', 'Teacher')" class="ios-btn-card justify-between">
                        <div>
                            <div class="text-[10px] font-bold text-blue-500 uppercase mb-0.5 tracking-wider">UNIT ${i+1}</div>
                            <div class="font-bold text-slate-800 text-base">${l.t}</div>
                            <div class="text-xs text-slate-400 mt-1">${l.d}</div>
                        </div>
                        <i class="fa-solid fa-circle-play text-blue-500 text-2xl opacity-80 shrink-0 ml-3"></i>
                    </button>
                `).join('');
            },

            // --- èŠå¤©åŠŸèƒ½ ---
            initChat: function(title, role) {
                // UI
                document.getElementById('view-chat').classList.remove('translate-x-full');
                document.getElementById('chat-title').innerText = title;
                document.getElementById('chat-container').innerHTML = '';
                document.getElementById('chat-status').innerText = "é€£ç·šä¸­...";
                document.getElementById('chat-status').className = "text-[10px] text-blue-500 block mt-0.5 animate-pulse";
                
                // Prompt
                const levelMap = { 'Easy': 'Beginner (N5/A1)', 'Medium': 'Intermediate (N3/B1)', 'Hard': 'Advanced (N1/C1)' };
                const sysPrompt = `Act as a ${role} speaking ${this.state.lang}. User level: ${levelMap[this.state.level]}. 
                If user mistakes, JSON format: {"correction": "...", "reason": "..."} first. 
                Be helpful and concise.`;

                this.state.chatHistory = [{ role: 'user', parts: [{ text: sysPrompt + " Start with a greeting." }] }];
                
                // API Call
                this.apiTurn();
            },

            apiTurn: async function() {
                try {
                    const text = await this.callGemini(this.state.chatHistory);
                    this.addBubble('ai', text);
                    this.state.chatHistory.push({ role: 'model', parts: [{ text: text }] });
                    const st = document.getElementById('chat-status');
                    st.innerText = "ç·šä¸Š";
                    st.className = "text-[10px] text-green-500 block mt-0.5";
                } catch (e) {
                    this.addBubble('sys', `é€£ç·šéŒ¯èª¤: ${e.message}`);
                    const st = document.getElementById('chat-status');
                    st.innerText = "é›¢ç·š";
                    st.className = "text-[10px] text-red-500 block mt-0.5";
                }
            },

            callGemini: async function(contents) {
                if (!this.state.apiKey) throw new Error("è«‹è‡³è¨­å®šå¡«å¯« Key");
                const urls = [
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.state.apiKey}`,
                    `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${this.state.apiKey}`
                ];
                const headers = { 'Content-Type': 'application/json' };
                if (this.state.projectId) headers['X-Goog-User-Project'] = this.state.projectId;

                for (let url of urls) {
                    try {
                        const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify({ contents }) });
                        const data = await res.json();
                        if (res.ok) return data.candidates[0].content.parts[0].text;
                    } catch (e) {}
                }
                throw new Error("API é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡‘é‘°");
            },

            sendUserMessage: function() {
                const input = document.getElementById('msg-input');
                const text = input.value.trim();
                if (!text) return;
                this.addBubble('user', text);
                input.value = '';
                this.state.chatHistory.push({ role: 'user', parts: [{ text: text }] });
                this.apiTurn();
            },

            addBubble: function(role, text) {
                const container = document.getElementById('chat-container');
                const div = document.createElement('div');
                
                if (role === 'user') {
                    div.className = 'flex justify-end mb-4 animate-fade-in';
                    div.innerHTML = `<div class="bg-[#007AFF] text-white px-4 py-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[85%] leading-relaxed">${text}</div>`;
                } else if (role === 'sys') {
                    div.innerHTML = `<div class="text-center text-xs text-red-400 py-2 bg-red-50 rounded-lg">${text}</div>`;
                } else {
                    let cleanText = text;
                    let correctionHtml = '';
                    const jsonMatch = text.match(/^\{[\s\S]*?\}/);
                    if (jsonMatch) {
                        try {
                            const c = JSON.parse(jsonMatch[0]);
                            if(c.correction) {
                                correctionHtml = `<div class="mb-2 bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs"><div class="font-bold text-yellow-700">ğŸ’¡ å»ºè­°ä¿®æ­£</div><div class="text-slate-800 mt-1">${c.correction}</div></div>`;
                                cleanText = text.replace(jsonMatch[0], '').trim();
                            }
                        } catch(e) {}
                    }
                    div.className = 'flex justify-start mb-4 animate-fade-in';
                    div.innerHTML = `<div class="max-w-[90%]">${correctionHtml}<div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-800 selectable border border-gray-100">${marked.parse(cleanText)}</div></div>`;
                }
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            },

            // --- å…¶ä»– ---
            switchView: function(t) {
                document.querySelectorAll('.page-view').forEach(v => v.classList.add('hidden'));
                document.getElementById(`view-${t}`).classList.remove('hidden');
                document.querySelectorAll('.nav-btn').forEach(b => {
                    const active = b.getAttribute('onclick').includes(t);
                    b.className = active ? 'nav-btn text-[#007AFF] flex flex-col items-center gap-1 w-full' : 'nav-btn text-gray-400 flex flex-col items-center gap-1 w-full';
                });
                if(t==='vocab') this.renderVocabs();
            },

            closeChat: function() { document.getElementById('view-chat').classList.add('translate-x-full'); },

            saveSettings: function() {
                this.state.apiKey = document.getElementById('api-key-input').value.trim();
                this.state.projectId = document.getElementById('project-id-input').value.trim();
                localStorage.setItem('v25_key', this.state.apiKey);
                localStorage.setItem('v25_proj', this.state.projectId);
                localStorage.setItem('v25_lang', this.state.lang);
                localStorage.setItem('v25_level', this.state.level);
                location.reload();
            },

            // åŠƒè©ç¿»è­¯
            handleTextSelection: function(e) {
                const t = window.getSelection().toString().trim();
                const tools = document.getElementById('word-tools');
                if (t && t.length < 50) {
                    document.getElementById('sel-text').innerText = t;
                    tools.style.display = 'block';
                    tools.style.left = Math.min(e.pageX, window.innerWidth - 140) + 'px';
                    tools.style.top = (e.pageY - 50) + 'px';
                } else { tools.style.display = 'none'; }
            },

            translateAndSave: async function() {
                const w = document.getElementById('sel-text').innerText;
                document.getElementById('word-tools').style.display = 'none';
                try {
                    const res = await this.callGemini([{ role: 'user', parts: [{ text: `Translate "${w}" to Traditional Chinese. Just the word.` }] }]);
                    this.state.vocabs.push({ w: w, t: res.trim(), l: this.state.lang });
                    localStorage.setItem('v25_vocabs', JSON.stringify(this.state.vocabs));
                    alert(`å·²æ”¶è—: ${w}`);
                } catch(e) {}
            },

            renderVocabs: function() {
                const list = document.getElementById('vocab-display-list');
                const data = this.state.vocabs.filter(v => v.l === this.state.lang);
                list.innerHTML = data.map(v => `<div class="ios-btn-card justify-between"><div><div class="font-bold">${v.w}</div><div class="text-xs text-gray-500">${v.t}</div></div><button onclick="app.delVocab('${v.w}')" class="text-red-400 text-xs"><i class="fa-solid fa-trash"></i></button></div>`).join('') || '<div class="text-center text-gray-400 py-10">ç„¡å–®å­—</div>';
            },

            delVocab: function(w) {
                this.state.vocabs = this.state.vocabs.filter(v => v.w !== w);
                localStorage.setItem('v25_vocabs', JSON.stringify(this.state.vocabs));
                this.renderVocabs();
            },
            
            startQuiz: function() {
                const pool = this.state.vocabs.filter(v => v.l === this.state.lang);
                if(pool.length===0) return alert("ç„¡å–®å­—");
                const q = pool[Math.floor(Math.random()*pool.length)];
                const a = prompt(`æ¸¬é©—: ${q.t}`);
                if(a && a.toLowerCase()===q.w.toLowerCase()) alert("æ­£ç¢º!"); else alert(`éŒ¯èª¤, æ˜¯ ${q.w}`);
            }
        };
        
        // å…¨åŸŸæš´éœ²çµ¦ HTML å‘¼å«
        window.switchView = (t) => app.switchView(t);
        window.app = app;
        window.onload = () => app.init();
    </script>
</body>
</html>