<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Learning</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f2f2f7">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* iOS Base Styles */
        :root {
            --ios-bg: #f2f2f7;
            --ios-card: #ffffff;
            --ios-blue: #007aff;
            --ios-nav-blur: rgba(255, 255, 255, 0.95);
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--ios-bg);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            height: 100vh;
            overflow: hidden;
        }

        /* Page Logic */
        .ios-page {
            display: none;
            padding-top: calc(var(--safe-top) + 60px);
            padding-bottom: calc(var(--safe-bottom) + 80px);
            height: 100vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .ios-page.active-page {
            display: block !important;
            animation: fadeIn 0.2s ease-out;
        }

        /* Detail Page (Slide in from right) */
        .detail-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--ios-bg);
            z-index: 200;
            /* Higher than everything */
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            padding-top: calc(var(--safe-top) + 50px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .detail-page.show {
            transform: translateX(0);
        }

        /* Chat Specifics */
        #page-chat.active-page {
            padding-bottom: 0;
            overflow: hidden;
            display: flex !important;
            flex-direction: column;
        }

        /* Header */
        .ios-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(var(--safe-top) + 50px);
            padding-top: var(--safe-top);
            background: var(--ios-nav-blur);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 250;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 17px;
            transition: all 0.3s;
        }

        .header-btn-left {
            position: absolute;
            left: 16px;
            bottom: 12px;
            color: var(--ios-blue);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .header-btn-right {
            position: absolute;
            right: 16px;
            bottom: 12px;
            color: var(--ios-blue);
            font-size: 14px;
            cursor: pointer;
        }

        /* Tab Bar */
        .ios-tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--safe-bottom) + 55px);
            padding-bottom: var(--safe-bottom);
            background: var(--ios-nav-blur);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50;
            transition: transform 0.3s ease;
        }

        body.chat-mode .ios-tab-bar {
            transform: translateY(100%);
        }

        .tab-item {
            color: #8e8e93;
            font-size: 12px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .tab-item i {
            font-size: 20px;
        }

        .tab-item.active {
            color: var(--ios-blue);
        }

        /* Chat UI */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            /* 修正：加大底部留白至 180px，防止被輸入框擋住 */
            padding-bottom: 180px;
            background-color: var(--ios-bg);
            scroll-behavior: smooth;
        }

        #chat-input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(249, 249, 249, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px 16px;
            padding-bottom: calc(var(--safe-bottom) + 10px);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 70;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        body.chat-mode #chat-input-area {
            transform: translateY(0);
        }

        .ios-card {
            background: var(--ios-card);
            border-radius: 12px;
            padding: 16px;
            margin: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .bubble-user {
            background-color: var(--ios-blue);
            color: white;
            border-radius: 18px 18px 0 18px;
            padding: 10px 14px;
            max-width: 85%;
            margin-left: auto;
            margin-bottom: 12px;
            font-size: 16px;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .bubble-ai {
            background-color: #e5e5ea;
            color: black;
            border-radius: 18px 18px 18px 0;
            padding: 10px 14px;
            max-width: 85%;
            margin-right: auto;
            margin-bottom: 12px;
            font-size: 16px;
            line-height: 1.4;
            word-wrap: break-word;
            position: relative;
        }

        .correction-box {
            background-color: #fff8c4;
            border-left: 4px solid #f59e0b;
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 13px;
            color: #4b3600;
        }

        /* Float Translate */
        #float-translate-btn {
            position: fixed;
            background: #222;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }

        /* Key Sentences Card */
        .key-sentence-item {
            background: #f0f7ff;
            border-left: 3px solid #007aff;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* === 新增：單字卡測驗專用樣式 === */
        .flashcard {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            margin-top: 40px;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .flashcard:active {
            transform: scale(0.98);
        }

        .flashcard.revealed {
            border-color: var(--ios-blue);
            background-color: #f0f9ff;
        }
    </style>
</head>

<body>

    <header class="ios-header">
        <div id="header-back-btn" class="header-btn-left" style="display:none;" onclick="handleHeaderBack()">
            <i class="fas fa-chevron-left"></i> <span id="back-text">返回</span>
        </div>

        <span id="header-title">My Learning</span>

        <div id="audio-toggle" class="header-btn-right" style="display:none;" onclick="toggleAutoAudio()">
            <span id="audio-icon"><i class="fas fa-volume-up"></i> 朗讀</span>
        </div>
        <div id="close-detail-btn" class="header-btn-right" style="display:none;" onclick="closeCourseDetail()">
            <i class="fas fa-times text-lg"></i>
        </div>
    </header>

    <div id="float-translate-btn"><i class="fas fa-language"></i> 翻譯並收藏</div>

    <div id="page-home" class="ios-page active-page">
        <div id="api-warning" class="ios-card bg-red-50 border border-red-100 hidden">
            <h3 class="text-red-600 font-bold mb-1"><i class="fas fa-exclamation-triangle"></i> 尚未設定 API Key</h3>
            <p class="text-xs text-red-500">請前往「設定」頁面輸入 Google Gemini API Key。</p>
        </div>

        <div class="ios-card">
            <h2 class="text-lg font-bold mb-3">學習設定</h2>

            <label class="block text-sm text-gray-500 mb-1">目標語言</label>
            <div class="flex bg-gray-100 rounded-lg p-1 mb-4">
                <button onclick="setLang('en')"
                    class="lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all bg-white shadow-sm"
                    data-lang="en">English</button>
                <button onclick="setLang('jp')"
                    class="lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all text-gray-500"
                    data-lang="jp">日本語</button>
                <button onclick="setLang('kr')"
                    class="lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all text-gray-500"
                    data-lang="kr">한국어</button>
            </div>

            <label class="block text-sm text-gray-500 mb-1">難易度</label>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setLevel('beginner')"
                    class="level-btn py-2 border rounded-lg text-sm text-center active-level border-blue-500 bg-blue-50 text-blue-600"
                    data-lvl="beginner">
                    <div class="font-bold">初級</div>
                    <div class="text-xs scale-75" id="lvl-desc-1">Survival</div>
                </button>
                <button onclick="setLevel('intermediate')"
                    class="level-btn py-2 border rounded-lg text-sm text-center border-gray-200"
                    data-lvl="intermediate">
                    <div class="font-bold">中級</div>
                    <div class="text-xs scale-75" id="lvl-desc-2">Life</div>
                </button>
                <button onclick="setLevel('advanced')"
                    class="level-btn py-2 border rounded-lg text-sm text-center border-gray-200" data-lvl="advanced">
                    <div class="font-bold">高級</div>
                    <div class="text-xs scale-75" id="lvl-desc-3">Business</div>
                </button>
            </div>
        </div>

        <div class="px-4 mb-2 mt-6">
            <h3 class="text-gray-500 text-sm font-bold uppercase">情境模擬 (AI Roleplay)</h3>
        </div>
        <div class="grid grid-cols-2 gap-4 px-4 pb-4" id="scenario-grid">
        </div>

        <div class="px-4">
            <div onclick="startChat('free')"
                class="ios-card m-0 bg-gradient-to-r from-purple-500 to-indigo-500 text-white flex items-center justify-between cursor-pointer shadow-lg active:scale-95 transition">
                <div>
                    <h3 class="font-bold">自由對話 (Free Talk)</h3>
                    <p class="text-xs opacity-90">不限主題 • 隨機任務</p>
                </div>
                <i class="fas fa-comments text-2xl opacity-80"></i>
            </div>
        </div>
    </div>

    <div id="page-chat" class="ios-page">
        <div class="bg-yellow-50 px-4 py-2 border-b border-yellow-100 flex justify-between items-center text-xs shadow-sm flex-none z-10"
            id="mission-bar">
            <span class="font-bold text-yellow-800 mr-2 flex-none">Mission:</span>
            <div id="mission-words" class="flex gap-2 overflow-x-auto no-scrollbar"></div>
        </div>

        <div id="chat-container">
            <div class="text-center text-gray-400 text-xs mt-8">正在連線至 Gemini...</div>
        </div>

        <div id="chat-input-area">
            <button id="mic-btn"
                class="w-9 h-9 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center transition-all active:scale-95 flex-none">
                <i class="fas fa-microphone"></i>
            </button>
            <input type="text" id="chat-input"
                class="flex-1 bg-white border border-gray-300 rounded-full px-4 py-2 text-base focus:outline-none focus:border-blue-500"
                placeholder="輸入訊息..." autocomplete="off">
            <button id="send-btn"
                class="w-9 h-9 rounded-full bg-blue-500 text-white flex items-center justify-center shadow-md active:scale-95 flex-none">
                <i class="fas fa-arrow-up"></i>
            </button>
        </div>
    </div>

    <div id="page-learn" class="ios-page">
        <div class="px-4 pt-2">
            <div class="flex items-center gap-2 mb-4">
                <h2 class="text-2xl font-bold">主題課程</h2>
                <span id="course-level-badge"
                    class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded">LEVEL</span>
            </div>

            <div id="learn-content">
            </div>

            <div class="text-center text-xs text-gray-400 mt-6 pb-6">
                完成對話練習可解鎖成就 (模擬)
            </div>
        </div>
    </div>

    <div id="page-course-detail" class="detail-page">
        <div class="px-5 pb-20">
            <div id="course-detail-body"></div>
        </div>
    </div>

    <div id="page-vocab" class="ios-page">
        <div class="px-4 pt-2">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">單字本</h2>
                <button onclick="openQuizModal()"
                    class="text-blue-500 text-sm font-bold bg-blue-50 px-3 py-1 rounded-full">
                    <span id="quiz-btn-text">進入測驗模式</span>
                </button>
            </div>
            <div class="flex bg-gray-100 rounded-lg p-1 mb-4">
                <button onclick="setVocabLang('en')"
                    class="vocab-lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all bg-white shadow-sm text-black"
                    data-lang="en">English</button>
                <button onclick="setVocabLang('jp')"
                    class="vocab-lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all text-gray-500"
                    data-lang="jp">日本語</button>
                <button onclick="setVocabLang('kr')"
                    class="vocab-lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all text-gray-500"
                    data-lang="kr">한국어</button>
            </div>
            <div id="vocab-list" class="space-y-3 pb-8"></div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[999] hidden flex justify-center items-center">
        <div class="bg-white rounded-2xl p-6 w-11/12 max-w-sm max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold border-b-2 border-transparent">單字測驗</h3>
                <button onclick="closeQuizModal()" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="quiz-content"></div>
        </div>
    </div>

    <div id="page-settings" class="ios-page">
        <div class="px-4 pt-2">
            <h2 class="text-2xl font-bold mb-4">設定</h2>

            <div class="ios-card m-0 mb-4">
                <h3 class="font-bold mb-2 text-sm text-gray-500 uppercase">API 連線</h3>
                <input type="password" id="api-key-input" class="w-full bg-gray-100 rounded-lg p-3 text-sm mb-2"
                    placeholder="貼上您的 API Key">
                <button onclick="saveApiKey()"
                    class="w-full bg-blue-500 text-white py-3 rounded-lg text-sm font-bold shadow">儲存金鑰</button>
            </div>

            <div class="ios-card m-0">
                <h3 class="font-bold mb-2 text-sm text-gray-500 uppercase">資料備份</h3>
                <div class="flex gap-3">
                    <button onclick="backupData()"
                        class="flex-1 bg-gray-100 py-3 rounded-lg text-sm font-bold text-gray-800">匯出</button>
                    <button onclick="document.getElementById('restore-file').click()"
                        class="flex-1 bg-gray-100 py-3 rounded-lg text-sm font-bold text-gray-800">還原</button>
                    <input type="file" id="restore-file" style="display:none" onchange="restoreData(this)">
                </div>
            </div>
        </div>
    </div>

    <nav class="ios-tab-bar">
        <div class="tab-item active" onclick="switchPage('home', this)">
            <i class="fas fa-home"></i> 首頁
        </div>
        <div class="tab-item" onclick="switchPage('learn', this)">
            <i class="fas fa-book-open"></i> 課程
        </div>
        <div class="tab-item" onclick="switchPage('vocab', this)">
            <i class="fas fa-star"></i> 單字
        </div>
        <div class="tab-item" onclick="switchPage('settings', this)">
            <i class="fas fa-cog"></i> 設定
        </div>
    </nav>

    <script>
        /* =========================================
           1. API LOGIC (Core)
           ========================================= */
        async function autoDetectModel(apiKey) {
            try {
                const listUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
                const res = await fetch(listUrl);
                const data = await res.json();
                if (res.ok && data.models) {
                    const model = data.models.find(m => m.supportedGenerationMethods?.includes("generateContent"));
                    if (model) return model.name.replace('models/', '');
                }
                return 'gemini-1.5-flash';
            }
            catch (e) { return 'gemini-1.5-flash'; }
        }

        // ==========================================
        //  改良版 callGemini (放在 index.html <script> 內)
        // ==========================================
        async function callGemini(contents) {
            // == [新增自動除錯] 本地直連機制 ==
            // 當偵測到你是用本地檔案開啟 (file://) 或 localhost 時，自動改由前端直連 Gemini，不用管後端壞掉的問題！
            const isLocal = window.location.protocol === 'file:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            const apiKey = localStorage.getItem('v21_key');
            if (isLocal && apiKey) {
                console.log("【模式提示】偵測為本地測試，自動使用前端直連 Gemini 模式");
                const model = (await autoDetectModel(apiKey)) || 'gemini-1.5-flash';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                let geminiContents = [];
                if (Array.isArray(contents)) {
                    geminiContents = contents.map(item => {
                        if (item.parts) return item;
                        return { role: item.role || "user", parts: [{ text: item.text || JSON.stringify(item) }] };
                    });
                } else {
                    geminiContents = [{ role: "user", parts: [{ text: typeof contents === 'string' ? contents : JSON.stringify(contents) }] }];
                }

                try {
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: geminiContents })
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error?.message || "本地直連請求失敗");
                    return data.candidates[0].content.parts[0].text;
                } catch (e) {
                    console.error("Gemini 本地呼叫發生錯誤:", e);
                    throw e;
                }
            }

            // 以下為原本你的後端連線 (`/api/chat`) 原始邏輯（完全沒改）：
            const url = '/api/chat';

            console.log("【除錯】原始資料:", contents); // 這行會顯示在 F12 Console，幫我們抓蟲

            // --- 1. 資料格式轉換 ---
            // 目的：不管 contents 是什麼格式，我們都要努力抓出「使用者說的話」
            let messageToSend = "";
            let historyToSend = [];

            try {
                if (Array.isArray(contents) && contents.length > 0) {
                    // 情況 A：它是標準的歷史紀錄陣列
                    // 抓出最後一則 (最新的那句話)
                    const lastItem = contents[contents.length - 1];

                    // 嘗試解析 Google 的 parts 結構
                    if (lastItem.parts && Array.isArray(lastItem.parts) && lastItem.parts.length > 0) {
                        messageToSend = lastItem.parts[0].text;
                    } else if (lastItem.role && lastItem.parts) {
                        // 有些寫法是直接放物件
                        messageToSend = lastItem.parts;
                    } else {
                        // 如果結構很怪，就轉成字串硬傳
                        messageToSend = JSON.stringify(lastItem);
                    }

                    // 剩下的前面部分當作歷史
                    historyToSend = contents.slice(0, -1);

                } else if (typeof contents === 'string') {
                    // 情況 B：它只是單純的字串
                    messageToSend = contents;
                } else {
                    // 情況 C：看不懂的格式，轉成 JSON 字串硬傳
                    messageToSend = JSON.stringify(contents);
                }

                console.log("【除錯】準備發送 ->", { message: messageToSend, historyLength: historyToSend.length });

            } catch (e) {
                console.error("資料解析失敗:", e);
                messageToSend = "Error parsing input"; // 避免當機
            }

            // --- 2. 發送到 Vercel 後端 ---
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: messageToSend,
                        history: historyToSend
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // 顯示詳細錯誤
                    const errorMsg = data.error || data.details || "伺服器發生未知錯誤";
                    console.error("伺服器回傳錯誤:", errorMsg);
                    throw new Error(errorMsg);
                }

                // 回傳成功結果 (注意：這裡用 data.reply)
                return data.reply;

            } catch (error) {
                console.error("連線或處理失敗:", error);
                alert("系統錯誤: " + error.message); // 手機上會跳出視窗告訴你錯在哪
                throw error;
            }
        }
        /* =========================================
           2. APP DATA (Expanded Courses)
           ========================================= */
        // Helper to create course objects
        function createCourse(id, title, desc, sentences, aiRole, userRole, context) {
            return { id, title, desc, sentences, aiRole, userRole, context };
        }

        const APP_DATA = {
            langs: {
                en: {
                    name: "English",
                    levels: { beginner: "CEFR A1/A2", intermediate: "CEFR B1/B2", advanced: "CEFR C1" },
                    scenarios: {
                        beginner: [
                            { id: 'en_cafe_b', title: 'Coffee Shop', role: 'Barista', user: 'Customer', icon: 'fa-mug-hot' },
                            { id: 'en_hotel_b', title: 'Hotel Check-in', role: 'Receptionist', user: 'Guest', icon: 'fa-bell' },
                            { id: 'en_supermarket_b', title: 'Supermarket', role: 'Cashier', user: 'Shopper', icon: 'fa-shopping-cart' },
                            { id: 'en_taxi_b', title: 'Taking a Taxi', role: 'Driver', user: 'Passenger', icon: 'fa-taxi' }
                        ],
                        intermediate: [
                            { id: 'en_job_i', title: 'Job Interview', role: 'Interviewer', user: 'Applicant', icon: 'fa-user-tie' },
                            { id: 'en_meeting_i', title: 'Company Meeting', role: 'Project Lead', user: 'Designer', icon: 'fa-users' },
                            { id: 'en_return_i', title: 'Returning an Item', role: 'Clerk', user: 'Customer', icon: 'fa-undo' },
                            { id: 'en_directions_i', title: 'Asking Directions', role: 'Local', user: 'Tourist', icon: 'fa-map' }
                        ],
                        advanced: [
                            { id: 'en_nego_a', title: 'Business Negotiation', role: 'Client', user: 'Sales Manager', icon: 'fa-handshake' },
                            { id: 'en_academic_a', title: 'Academic Debate', role: 'Professor', user: 'Student', icon: 'fa-graduation-cap' },
                            { id: 'en_presentation_a', title: 'Presentation Q&A', role: 'Audience', user: 'Presenter', icon: 'fa-chalkboard-teacher' },
                            { id: 'en_conflict_a', title: 'Resolving Conflict', role: 'Coworker', user: 'Manager', icon: 'fa-comments-dollar' }
                        ]
                    }
                },
                jp: {
                    name: "日本語",
                    levels: { beginner: "JLPT N4/N5", intermediate: "JLPT N2/N3", advanced: "JLPT N1" },
                    scenarios: {
                        beginner: [
                            { id: 'jp_izakaya_b', title: '居酒屋打工', role: '客', user: '店員', icon: 'fa-beer' },
                            { id: 'jp_konbini_b', title: '便利商店打工', role: '客', user: '店員', icon: 'fa-store' },
                            { id: 'jp_station_b', title: '車站問路', role: '駅員', user: '乗客', icon: 'fa-train' },
                            { id: 'jp_restaurant_b', title: '餐廳點餐', role: '店員', user: '客', icon: 'fa-utensils' }
                        ],
                        intermediate: [
                            { id: 'jp_hotel_i', title: '旅館櫃檯', role: '宿泊客', user: 'フロント', icon: 'fa-concierge-bell' },
                            { id: 'jp_shop_i', title: '服飾店店員', role: '客', user: '店員', icon: 'fa-tshirt' },
                            { id: 'jp_hospital_i', title: '醫院看診', role: '医者', user: '患者', icon: 'fa-hospital' },
                            { id: 'jp_friend_i', title: '朋友聚會', role: '友達', user: 'あなた', icon: 'fa-user-friends' }
                        ],
                        advanced: [
                            { id: 'jp_corptalk_a', title: '公司內部匯報', role: '上司', user: '部下', icon: 'fa-building' },
                            { id: 'jp_client_a', title: '客戶商談', role: '取引先', user: '営業', icon: 'fa-briefcase' },
                            { id: 'jp_apology_a', title: '客訴處理與道歉', role: '怒る客', user: '店長', icon: 'fa-exclamation-triangle' },
                            { id: 'jp_interview_a', title: '外商面試', role: '面接官', user: '応募者', icon: 'fa-id-badge' }
                        ]
                    }
                },
                kr: {
                    name: "한국어",
                    levels: { beginner: "TOPIK I", intermediate: "TOPIK II (Mid)", advanced: "TOPIK II (High)" },
                    scenarios: {
                        beginner: [
                            { id: 'kr_market_b', title: '傳統市場', role: '시장 상인', user: '손님', icon: 'fa-shopping-basket' },
                            { id: 'kr_cafe_b', title: '咖啡廳點餐', role: '알바생', user: '손님', icon: 'fa-coffee' },
                            { id: 'kr_subway_b', title: '地鐵站問路', role: '행인', user: '관광객', icon: 'fa-subway' },
                            { id: 'kr_restaurant_b', title: '烤肉店點餐', role: '종업원', user: '손님', icon: 'fa-fire' }
                        ],
                        intermediate: [
                            { id: 'kr_taxi_i', title: '計程車', role: '기사님', user: '승객', icon: 'fa-taxi' },
                            { id: 'kr_salon_i', title: '美容室', role: '미용사', user: '손님', icon: 'fa-cut' },
                            { id: 'kr_hospital_i', title: '藥局買藥', role: '약사', user: '환자', icon: 'fa-pills' },
                            { id: 'kr_friend_i', title: '約會計畫', role: '친구', user: '나', icon: 'fa-calendar-alt' }
                        ],
                        advanced: [
                            { id: 'kr_corptalk_a', title: '公司內部開會', role: '팀장', user: '팀원', icon: 'fa-users' },
                            { id: 'kr_interview_a', title: '外商面試', role: '면접관', user: '지원자', icon: 'fa-id-badge' },
                            { id: 'kr_realestate_a', title: '看房子', role: '부동산 중개인', user: '세입자', icon: 'fa-home' },
                            { id: 'kr_debate_a', title: '社會議題討論', role: '동료', user: '나', icon: 'fa-comments' }
                        ]
                    }
                }
            },
            courses: {
                en: {
                    beginner: [
                        createCourse(101, "Self Introduction", "Learn to introduce yourself naturally.", [{ text: "My name is...", trans: "我的名字是..." }, { text: "I am from...", trans: "我來自..." }, { text: "Nice to meet you", trans: "很高興認識你" }], "New Neighbor", "New Resident", "Meeting a new neighbor at the apartment lobby."),
                        createCourse(102, "Ordering Food", "Order your favorite meal.", [{ text: "I would like...", trans: "我想要點..." }, { text: "How much is this?", trans: "這個多少錢？" }, { text: "No spicy, please", trans: "請不要加辣" }], "Waiter", "Customer", "Ordering at a fast food restaurant."),
                        createCourse(103, "Asking Directions", "Never get lost again.", [{ text: "Where is the...", trans: "請問...在哪裡？" }, { text: "Go straight", trans: "直走" }, { text: "Turn left", trans: "左轉" }], "Police Officer", "Lost Tourist", "Asking for directions on the street."),
                        createCourse(104, "Checking into Hotel", "Hotel check-in essentials.", [{ text: "I have a reservation", trans: "我有預訂" }, { text: "Breakfast included?", trans: "有含早餐嗎？" }, { text: "What is the WiFi password?", trans: "WiFi密碼是多少？" }], "Receptionist", "Guest", "Checking in at the front desk."),
                        createCourse(105, "Taking a Taxi", "Getting to your destination.", [{ text: "Please take me to...", trans: "請載我到..." }, { text: "Stop here, please", trans: "請停在這裡" }, { text: "Keep the change", trans: "不用找零了" }], "Taxi Driver", "Passenger", "In a taxi going to the airport.")
                    ],
                    intermediate: [
                        createCourse(201, "Job Interview", "Answer common interview questions.", [{ text: "What sets me apart is my comprehensive experience in...", trans: "我與眾不同之處在於我擁有...的全面經驗" }, { text: "I consider myself highly adaptable and resilient.", trans: "我認為自己具備高度適應力與韌性" }, { text: "Could you elaborate on the team's dynamics?", trans: "您可以詳細說明一下團隊的運作模式嗎？" }], "Hiring Manager", "Applicant", "Job interview for a mid-level marketing role."),
                        createCourse(202, "Doctor Visit", "Explain your symptoms in detail.", [{ text: "I've been experiencing persistent migraines lately.", trans: "我最近一直有持續性的偏頭痛" }, { text: "The pain radiates down to my lower back.", trans: "疼痛會蔓延到我的下背部" }, { text: "Are there any side effects to this prescription?", trans: "這份處方藥有任何副作用嗎？" }], "Doctor", "Patient", "Consulting a doctor about chronic pain."),
                        createCourse(203, "Restaurant Complaint", "Politely solving food issues.", [{ text: "I'm afraid this dish is slightly undercooked.", trans: "恐怕這道菜還沒完全煮熟" }, { text: "Could you possibly have the chef look into this?", trans: "能不能請主廚確認一下這個狀況？" }, { text: "We'd appreciate it if you could deduct this from the bill.", trans: "如果不介意，希望您能將此從帳單中扣除" }], "Manager", "Customer", "Complain politely about undercooked food."),
                        createCourse(204, "Debating a Plan", "Discussing travel itineraries.", [{ text: "Wouldn't it be more practical to take the train?", trans: "搭火車難道不會比較實際嗎？" }, { text: "I see your point, but we run the risk of delays.", trans: "我懂你的意思，但我們有誤點的風險" }, { text: "Let's compromise and stick to the original schedule.", trans: "我們折衷一下，維持原訂計畫吧" }], "Friend", "You", "Debating transportation options for a trip."),
                        createCourse(205, "Shopping for Clothes", "Asking for specific fits and materials.", [{ text: "Do you have this garment in a more breathable fabric?", trans: "這件衣服有更透氣的材質嗎？" }, { text: "It's a bit snug around the shoulders.", trans: "肩膀的地方稍微有點緊" }, { text: "I'm looking for something versatile for both work and casual wear.", trans: "我在找適合上班與休閒兩穿的百搭款式" }], "Shop Assistant", "Shopper", "Buying a versatile outfit in a boutique.")
                    ],
                    advanced: [
                        createCourse(301, "Business Negotiation", "Negotiating a complex deal.", [{ text: "We are willing to make concessions provided that...", trans: "若滿足...條件，我們願意做出讓步" }, { text: "It is imperative that we reach a consensus today.", trans: "我們今天務必要達成共識" }, { text: "Let's review the stipulations in clause four.", trans: "讓我們回顧一下第四條款的規定" }], "Client", "Sales Manager", "Negotiating a high-stakes contract."),
                        createCourse(302, "Presentation Q&A", "Handling tough questions.", [{ text: "That's an insightful observation to bring forward.", trans: "您提出了非常有洞察力的觀察" }, { text: "To elaborate on the nuances of this paradigm...", trans: "為了進一步闡述這個典範的微妙之處..." }, { text: "Empirical data substantiates our preliminary hypothesis.", trans: "實證數據證實了我們的初步假設" }], "Audience Member", "Presenter", "Q&A session at a global convention."),
                        createCourse(303, "Academic Discussion", "Debating sociology.", [{ text: "I must respectfully disagree with your premise.", trans: "恕我對您的大前提難以苟同" }, { text: "The aforementioned phenomenon merely scratches the surface.", trans: "上述現象僅僅是冰山一角" }, { text: "It fundamentally contradicts established sociological frameworks.", trans: "這在本質上與既有的社會學框架相矛盾" }], "Professor", "Student", "Debating the impact of globalization."),
                        createCourse(304, "Tech Support Escalation", "Solving systemic issues.", [{ text: "We're experiencing intermittent latency across the network.", trans: "我們的網路正經歷間歇性的延遲" }, { text: "Could you verify the integrity of the recent deployment?", trans: "您能核實一下近期部署的完整性嗎？" }, { text: "We need to mitigate the vulnerabilities immediately.", trans: "我們必須立即減輕這些安全漏洞帶來的風險" }], "Senior IT Engineer", "Employee", "Reporting a critical systemic vulnerability."),
                        createCourse(305, "Networking", "Professional connection building.", [{ text: "Your recent publication profoundly altered my perspective on...", trans: "您最近發表的著作深刻改變了我對...的看法" }, { text: "I foresee a tremendous synergy between our respective divisions.", trans: "我預見我們各自部門間存在極大的協同效益" }, { text: "It would be an honor to ostensibly collaborate on future endeavors.", trans: "若未來有機會合作，將是我的榮幸" }], "Industry Expert", "Attendee", "Networking at a high-level corporate event.")
                    ]
                },
                jp: {
                    beginner: [
                        createCourse(401, "自己紹介 (Jikoshoukai)", "基本の挨拶と自己紹介。", [{ text: "はじめまして", trans: "初次見面" }, { text: "～から来ました", trans: "我來自～" }, { text: "よろしくお願いします", trans: "請多指教" }], "新しい同僚", "あなた", "会社の初日に挨拶をする。"),
                        createCourse(402, "コンビニ (Konbini)", "コンビニでの買い物。", [{ text: "これをお願いします", trans: "請給我這個" }, { text: "温めてください", trans: "請幫我微波" }, { text: "袋はいりません", trans: "不需要袋子" }], "店員", "客", "コンビニでお弁当を買う。"),
                        createCourse(403, "道を尋ねる", "迷子になった時。", [{ text: "すみません、駅はどこですか", trans: "不好意思，車站請問在哪？" }, { text: "歩いてどのくらいですか", trans: "走路大概要多久？" }, { text: "ありがとうございます", trans: "非常感謝" }], "親切な通行人", "観光客", "道に迷って助けを求める。"),
                        createCourse(404, "注文 (Order)", "レストランでの注文。", [{ text: "これを二つください", trans: "請給我兩個這個" }, { text: "おすすめは何ですか", trans: "有什麼推薦的嗎？" }, { text: "お会計をお願いします", trans: "麻煩結帳" }], "店員", "客", "居酒屋で注文する。"),
                        createCourse(405, "電車 (Train)", "電車の乗り方。", [{ text: "この電車は～に行きますか", trans: "這班電車會到～嗎？" }, { text: "切符を失くしました", trans: "我把車票弄丟了" }, { text: "乗り換えはどこですか", trans: "要在哪裡轉車？" }], "駅員", "乗客", "駅の改札口での会話。")
                    ],
                    intermediate: [
                        createCourse(501, "電話予約", "詳細な条件でのレストラン予約。", [{ text: "明日の午後7時に3名で予約可能でしょうか", trans: "請問明天晚上7點3位可以預約嗎？" }, { text: "アレルギー対応のメニューに変更できますか", trans: "能更改為適應過敏的菜單嗎？" }, { text: "窓際の静かな席を希望しております", trans: "我希望能安排靠窗安靜的位子" }], "店員", "客", "電話で特別な要望を含めた予約をする。"),
                        createCourse(502, "体調不良", "病院で詳細な症状を説明。", [{ text: "数日前から胃のあたりに鈍い痛みを感じます", trans: "幾天前開始胃部附近有隱隱作痛的感覺" }, { text: "食後に症状が悪化する傾向があります", trans: "飯後症狀有惡化的傾向" }, { text: "副作用の少ない薬を処方していただけますか", trans: "能否開一些副作用較少的藥呢？" }], "医者", "患者", "内科での詳細な診察。"),
                        createCourse(503, "買い物 (服)", "素材や用途の相談。", [{ text: "もう少し通気性の良い素材を探しています", trans: "我在找更透氣一點的材質" }, { text: "肩のあたりが少し窮屈に感じます", trans: "肩膀附近覺得有點緊繃" }, { text: "カジュアルでもフォーマルでも着回せるものはありますか", trans: "有休閒或正式都能穿搭的款式嗎？" }], "店員", "客", "服屋で用途に合わせた服を探す。"),
                        createCourse(504, "トラブル対応", "クレームと説明。", [{ text: "注文した商品と違うものが届いたのですが", trans: "我收到的商品跟訂購的不一樣" }, { text: "早急に交換の手続きをお願いできますか", trans: "可以麻煩您盡速辦理退換貨手續嗎？" }, { text: "今後の再発防止を徹底していただきたいです", trans: "希望貴公司能徹底防止今後再次發生" }], "カスタマーサポート", "顧客", "誤配に関するクレームの電話。"),
                        createCourse(505, "ホテルの要望", "部屋の問題と変更要求。", [{ text: "空調の効きが悪く、部屋が乾燥しています", trans: "空調效果不好，而且房間很乾燥" }, { text: "加湿器の貸し出しは行っておりますでしょうか", trans: "請問有提供租借加濕器的服務嗎？" }, { text: "可能であれば、高層階の部屋に変更をお願いします", trans: "如果可以的話，請幫我換到高樓層的房間" }], "フロント", "宿泊客", "ホテルの部屋からフロントへ詳細な要望。")
                    ],
                    advanced: [
                        createCourse(601, "ビジネス敬語", "取引先への挨拶と提案。", [{ text: "平素は格別のお引き立てを賜り、厚く御礼申し上げます", trans: "平素承蒙格外關照，在此致上最深的謝意" }, { text: "御社の課題解決に寄与するプランを持参いたしました", trans: "我們帶來了能有助於解決貴公司課題的方案" }, { text: "引き続き、ご愛顧のほどよろしくお願い申し上げます", trans: "今後也請您繼續多多眷顧與指教" }], "取引先", "営業担当", "重要な取引先との商談。"),
                        createCourse(602, "会議での提案", "データを用いた論理的な意見。", [{ text: "市場調査のデータに鑑みますと、この戦略は妥当かと存じます", trans: "鑒於市場調查的數據，我認為這項策略是妥當的" }, { text: "リスクヘッジの観点から、代替案も検討すべきです", trans: "從風險規避的觀點來看，也應該檢討替代方案" }, { text: "本件につきましては、持ち帰って再度精査いたします", trans: "關於此事，我們將帶回去再次仔細審查" }], "役員", "プロジェクトリーダー", "新プロジェクトの最終提案会議。"),
                        createCourse(603, "謝罪 (Apology)", "重大なミスの報告と謝罪。", [{ text: "この度の不祥事につきまして、幾重にもお詫び申し上げます", trans: "關於這次的醜聞/疏失，我們致上萬分的歉意" }, { text: "原因究明を急ぎ、抜本的な改善策を講じる所存です", trans: "我們將急於查明原因，並採取根本性的改善對策" }, { text: "多大なるご迷惑をおかけしたこと、弁解の余地もございません", trans: "造成您極大的困擾，我們沒有任何辯解的餘地" }], "重要顧客", "責任者", "トラブルによる深刻な謝罪。"),
                        createCourse(604, "議論", "複雑な社会問題について。", [{ text: "この問題の背景には、根深い制度的欠陥が潜んでいると考えます", trans: "我認為這個問題的背景隱藏著根深蒂固的制度缺陷" }, { text: "一過性の対策ではなく、包括的なアプローチが不可欠です", trans: "這並非一次性的對策，而是不可或缺的全面性方法" }, { text: "その見解は、マクロ経済の動向と矛盾していませんか", trans: "這個見解，難道沒有與總體經濟的動向矛盾嗎？" }], "専門家", "あなた", "パネルディスカッションでの意見交換。"),
                        createCourse(605, "面接 (Interview)", "高度なスキルとビジョンの説明。", [{ text: "前職で培ったマネジメント経験を御社で最大限に還元したいです", trans: "希望能將在前職培養的管理經驗，在貴公司發揮最大的回饋" }, { text: "既存の枠組みに囚われない、革新的な価値を創造できると自負しております", trans: "我自信能不侷限於既有框架，創造出革命性的價值" }, { text: "御社のグローバル展開において、シナジーを生み出せる確信があります", trans: "在貴公司的全球發展中，我有確信能產生協同效應" }], "社長", "転職志望者", "役員最終面接。")
                    ]
                },
                kr: {
                    beginner: [
                        createCourse(701, "자기소개 (Self Intro)", "이름과 국적 말하기.", [{ text: "안녕하세요", trans: "你好" }, { text: "저는 대만 사람입니다", trans: "我是台灣人" }, { text: "반갑습니다", trans: "很高興認識你" }], "한국 친구", "나", "언어 교환 모임에서 자기소개."),
                        createCourse(702, "식당 주문", "음식 주문하기.", [{ text: "이거 주세요", trans: "請給我這個" }, { text: "덜 맵게 해주세요", trans: "請不要太辣" }, { text: "물 좀 주세요", trans: "請給我一點水" }], "종업원", "손님", "김밥천국에서 주문하기."),
                        createCourse(703, "길 묻기", "길 찾기.", [{ text: "실례합니다", trans: "不好意思" }, { text: "지하철역이 어디예요?", trans: "地鐵站在哪裡？" }, { text: "멀어요?", trans: "很遠嗎？" }], "행인", "여행객", "서울 길거리에서 길 묻기."),
                        createCourse(704, "쇼핑", "가격 묻고 깎기.", [{ text: "얼마예요?", trans: "多少錢？" }, { text: "너무 비싸요", trans: "太貴了" }, { text: "좀 깎아주세요", trans: "請算便宜一點" }], "시장 상인", "손님", "동대문 시장에서 옷 사기."),
                        createCourse(705, "택시", "목적지 말하기.", [{ text: "홍대입구로 가주세요", trans: "請到弘大入口" }, { text: "여기서 세워주세요", trans: "請停在這裡" }, { text: "카드 돼요?", 전s: "可以刷卡嗎？" }], "기사님", "승객", "택시 타고 이동하기.")
                    ],
                    intermediate: [
                        createCourse(801, "약국", "증상 자세히 설명하기.", [{ text: "어제부터 으슬으슬 춥고 기침이 심해요", trans: "從昨天開始覺得發冷而且咳嗽很嚴重" }, { text: "빈속에 먹어도 부작용은 없을까요?", trans: "空腹吃的話會有什麼副作用嗎？" }, { text: "처방전 없이 살 수 있는 약으로 주세요", trans: "請給我不需要處方籤就能買的藥" }], "약사", "손님", "약국에서 구체적인 증상 설명."),
                        createCourse(802, "부동산", "조건에 맞는 방 구하기.", [{ text: "보증금 조율이 가능한 매물이 있을까요?", trans: "請問有保證金可以調整的物件嗎？" }, { text: "채광이 좋고 방음이 잘 되는 곳을 선호합니다", trans: "我偏好採光好且隔音佳的地方" }, { text: "월세에 관리비가 전부 포함된 금액인가요?", trans: "月租是包含所有管理費的金額嗎？" }], "공인중개사", "세입자", "부동산에서 방 계약 조건 확인."),
                        createCourse(803, "친구와 다툼", "오해 풀기.", [{ text: "내 말을 오해한 것 같은데 내 진심은 그게 아니었어", trans: "你好像誤會我的話了，我的真心並不是那樣的" }, { text: "미리 연락을 주지 않아서 서운했어", trans: "你沒有事先聯絡我，讓我覺得很難過" }, { text: "우리 서로 조금씩 양보해서 풀자", trans: "我們互相退讓一點，和好吧" }], "친구", "나", "친구와의 갈등 해결하기."),
                        createCourse(804, "미용실", "구체적인 스타일 요청.", [{ text: "사진처럼 층을 많이 내서 가볍게 잘라주세요", trans: "請像照片一樣剪出很多層次，弄輕盈一點" }, { text: "붉은 기가 없는 애쉬 브라운으로 염색하고 싶어요", trans: "我想要染沒有紅光的亞麻棕色" }, { text: "손상이 심한 끝부분만 살짝 다듬어 주세요", trans: "請只要稍微修剪受損嚴重的髮尾就好" }], "미용사", "손님", "미용실에서 디테일한 요청."),
                        createCourse(805, "쇼핑 컴플레인", "제품 교환 요청.", [{ text: "제품 안쪽에 박음질 불량이 있어서 교환하려고요", trans: "因為產品內側的縫線有瑕疵，我想要換貨" }, { text: "영수증을 지참했는데 바로 환불 처리 되나요?", trans: "我有帶收據，請問可以直接辦理退款嗎？" }, { text: "재고가 없다면 다른 색상으로 변경 가능할까요?", trans: "如果沒有庫存的話，可以換成別的顏色嗎？" }], "직원", "손님", "불량품에 대한 환불/교환 요청.")
                    ],
                    advanced: [
                        createCourse(901, "회사 회의", "논리적인 의견 제시 및 반박.", [{ text: "데이터 추이를 고려할 때 이 기획안은 수정이 불가피해 보입니다", trans: "考量到數據的趨勢，這份企劃案看來勢必得修改" }, { text: "리스크를 최소화하기 위한 대안을 먼저 검토하는 것이 바람직합니다", trans: "先去評估能將風險降到最低的替代方案，會是比較明智的做法" }, { text: "효율성 측면에서 기존 프로세스를 재정립할 필요가 있습니다", trans: "從效率層面來看，我們有必要重新確立既有的流程" }], "본부장", "팀장", "사업 전략 회의에서 의견 제시."),
                        createCourse(902, "면접", "이직 사유와 비전 설명.", [{ text: "과거 프로젝트를 성공적으로 이끈 경험을 바탕으로 역량을 발휘하겠습니다", trans: "我將以成功帶領過去專案的經驗為基礎，發揮我的能力" }, { text: "귀사가 추구하는 혁신적인 가치가 제 커리어 비전과 부합합니다", trans: "貴公司所追求的創新價值與我的職涯願景相符" }, { text: "주도적으로 문제를 파악하고 솔루션을 도출하는 것에 강점이 있습니다", trans: "我的優勢在於能主動掌握問題並導出解決方案" }], "임원진", "경력직 지원자", "경력직 임원 면접."),
                        createCourse(903, "비즈니스 협상", "계약 조건 조율.", [{ text: "단가 인하 요구는 시장 상황을 고려했을 때 수용하기 어렵습니다", trans: "考慮到市場狀況，要求降價實在難以接受" }, { text: "조건부로 납기일을 연장해주신다면 계약을 긍정적으로 검토하겠습니다", trans: "若是能有條件地延長交貨期，我們將會積極評估合約" }, { text: "상호 우호적인 관계를 유지할 수 있는 합의점을 도출해 봅시다", trans: "讓我們找出一個能維持雙方友好關係的共識點吧" }], "클라이언트", "영업 실장", "대형 계약 협상 테이블."),
                        createCourse(904, "고객 불만 대응", "치명적인 실수에 대한 사과.", [{ text: "이번 시스템 오류로 막대한 피해를 입혀드린 점 깊이 사죄드립니다", trans: "對於這次系統錯誤造成您巨大的損失，我們深深致歉" }, { text: "전사적 차원에서 원인을 규명하고 재발 방지 대책을 수립 중입니다", trans: "我們正在全公司層級查明原因，並制定防止再次發生的對策" }, { text: "손해 배상과 관련하여 법무팀과 협의 후 신속하게 안내해 드리겠습니다", trans: "關於損害賠償，我們會在與法務團隊協議後迅速通知您" }], "VIP 고객", "지사장", "치명적 서비스 오류에 대한 공식 사과."),
                        createCourse(905, "학술 토론", "사회 현상 분석 및 비판.", [{ text: "해당 정책이 초래할 거시경제적 파급 효과를 간과해서는 안 됩니다", trans: "我們不該忽視該項政策將帶來的總體經濟波及效應" }, { text: "이러한 현상은 기성세대의 뿌리 깊은 고정관념에서 기인한 것입니다", trans: "這樣的現象是起因於老一輩根深蒂固的刻板印象" }, { text: "표면적인 해결책보다는 구조적인 모순을 타파하는 것이 급선무입니다", trans: "比起表面上的解決方案，打破結構性的矛盾才是當務之急" }], "교수님", "대학원생", "학회에서의 심층 토론.")
                    ]
                }
            }
        };

        const MISSION_DATA = {
            en: {
                en_cafe_b: { beginner: ['coffee', 'how much', 'here'] },
                en_hotel_b: { beginner: ['reservation', 'name', 'key'] },
                en_supermarket_b: { beginner: ['bag', 'receipt', 'card'] },
                en_taxi_b: { beginner: ['address', 'stop', 'change'] },
                en_job_i: { intermediate: ['qualifications', 'adaptability', 'contribution'] },
                en_meeting_i: { intermediate: ['objective', 'milestone', 'strategy'] },
                en_return_i: { intermediate: ['defective', 'reimbursement', 'policy'] },
                en_directions_i: { intermediate: ['intersection', 'landmark', 'pedestrian'] },
                en_nego_a: { advanced: ['stipulation', 'concession', 'leverage'] },
                en_academic_a: { advanced: ['paradigm', 'empirical', 'ramification'] },
                en_presentation_a: { advanced: ['substantiate', 'correlation', 'nuance'] },
                en_conflict_a: { advanced: ['mitigate', 'discrepancy', 'consensus'] },
                free: { beginner: ['hello', 'fine', 'goodbye'], intermediate: ['fascination', 'excursion', 'lifestyle'], advanced: ['ideology', 'transformation', 'dilemma'] }
            },
            jp: {
                jp_izakaya_b: { beginner: ['ビール', 'メニュー', 'お会計'] },
                jp_konbini_b: { beginner: ['お弁当', '袋', 'いくら'] },
                jp_station_b: { beginner: ['どこ', '切符', '歩いて'] },
                jp_restaurant_b: { beginner: ['注文', '水', 'おすすめ'] },
                jp_hotel_i: { intermediate: ['手配', '眺望', '空室'] },
                jp_shop_i: { intermediate: ['試着室', '在庫', '素材'] },
                jp_hospital_i: { intermediate: ['症状', '処方箋', '診察券'] },
                jp_friend_i: { intermediate: ['近況', '充実', '予定'] },
                jp_corptalk_a: { advanced: ['抜本的', '収益', '推進'] },
                jp_client_a: { advanced: ['折衝', '妥協点', 'シナジー'] },
                jp_apology_a: { advanced: ['不手際', '再発防止', '遺憾'] },
                jp_interview_a: { advanced: ['即戦力', 'イノベーション', '先見性'] },
                free: { beginner: ['こんにちは', 'ありがとう', 'すみません'], intermediate: ['充実', '休暇', '趣味'], advanced: ['パラダイムシフト', '持続可能性', '社会的課題'] }
            },
            kr: {
                kr_market_b: { beginner: ['얼마', '이거', '주세요'] },
                kr_cafe_b: { beginner: ['아메리카노', '사이즈', '포장'] },
                kr_subway_b: { beginner: ['역', '멀어요', '어디'] },
                kr_restaurant_b: { beginner: ['맥주', '맵다', '맛있다'] },
                kr_taxi_i: { intermediate: ['목적지', '우회로', '요금'] },
                kr_salon_i: { intermediate: ['손상', '트리트먼트', '클리닉'] },
                kr_hospital_i: { intermediate: ['처방전', '진통제', '복용'] },
                kr_friend_i: { intermediate: ['안부', '근황', '약속'] },
                kr_corptalk_a: { advanced: ['차질', '시너지', '방안'] },
                kr_interview_a: { advanced: ['역량', '적합성', '기여'] },
                kr_realestate_a: { advanced: ['매물', '융자', '권리금'] },
                kr_debate_a: { advanced: ['모순', '근본적', '타파'] },
                free: { beginner: ['안녕하세요', '감사합니다', '네'], intermediate: ['여가', '취향', '여정'], advanced: ['패러다임', '본질적', '불가피'] }
            }
        };

        function getCourseVocab(courseId) {
            const courseVocabs = {
                101: ['introduce', 'neighborhood', 'glad'], 102: ['burger', 'drink', 'spicy'], 103: ['straight', 'corner', 'block'], 104: ['reservation', 'included', 'passport'], 105: ['airport', 'change', 'hurry'],
                201: ['comprehensive', 'resilient', 'adaptable', 'elaborate'], 202: ['migraine', 'radiate', 'prescription', 'persistent'], 203: ['undercooked', 'deduct', 'appreciate'], 204: ['practical', 'compromise', 'itinerary'], 205: ['garment', 'breathable', 'versatile', 'snug'],
                301: ['concession', 'consensus', 'stipulation', 'imperative'], 302: ['insightful', 'paradigm', 'empirical', 'substantiate'], 303: ['premise', 'phenomenon', 'contradict', 'framework'], 304: ['latency', 'integrity', 'vulnerability', 'mitigate'], 305: ['profoundly', 'synergy', 'ostensibly', 'endeavor'],
                401: ['同僚', '出身', '配属'], 402: ['温める', '袋', 'レシート'], 403: ['迷子', '駅', '徒歩'], 404: ['注文', 'おすすめ', '追加'], 405: ['切符', '乗り換え', '特急'],
                501: ['可能', '対応', '窓際', '希望'], 502: ['鈍い', '悪化', '処方', '傾向'], 503: ['通気性', '窮屈', '着回せる', '用途'], 504: ['早急', '交換', '再発防止', '徹底'], 505: ['加湿器', '貸し出し', '高層階', '乾燥'],
                601: ['平素', '格別', '御礼', '寄与'], 602: ['鑑みる', '妥当', 'リスクヘッジ', '代替案'], 603: ['幾重にも', '抜本的', '弁解', '不手際'], 604: ['根深い', '欠陥', '包括的', '矛盾'], 605: ['培う', '還元', '革新的', 'シナジー'],
                701: ['대만', '친구', '만나다'], 702: ['주세요', '맵다', '물'], 703: ['어디', '멀다', '역'], 704: ['얼마', '비싸다', '깎다'], 705: ['홍대', '세우다', '카드'],
                801: ['으슬으슬', '기침', '부작용', '처방전'], 802: ['보증금', '조율', '채광', '방음'], 803: ['진심', '오해', '서운하다', '양보하다'], 804: ['층을 내다', '염색', '가볍게', '손상'], 805: ['박음질', '불량', '지참하다', '재고'],
                901: ['추이', '불가피하다', '대안', '재정립'], 902: ['역량', '혁신적', '부합하다', '도출'], 903: ['인하', '수용하다', '단가', '우호적'], 904: ['막대하다', '규명하다', '방지', '배상'], 905: ['초래하다', '거시경제적', '고정관념', '모순']
            };
            return courseVocabs[courseId] || ['hello', 'word'];
        }

        let appState = {
            lang: 'en',
            level: 'beginner',
            currentScenario: null, // object
            courseMode: false, // NEW: Track if in course
            chatHistory: [],
            missionWords: [],
            completedMissions: [],
            vocabList: JSON.parse(localStorage.getItem('my_vocab') || '[]'),
            vocabLang: 'en',
            autoAudio: true
        };

        /* =========================================
           3. UI CONTROLLER
           ========================================= */

        function init() {
            const savedKey = localStorage.getItem('v21_key');
            if (savedKey) {
                document.getElementById('api-key-input').value = savedKey;
            } else {
                document.getElementById('api-warning').classList.remove('hidden');
            }
            renderHome();
            updateLevelDesc();
            renderVocab();
        }

        function switchPage(pageId, tabEl) {
            document.querySelectorAll('.ios-page').forEach(p => p.classList.remove('active-page'));
            const target = document.getElementById('page-' + pageId);
            if (target) target.classList.add('active-page');

            if (tabEl) {
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                tabEl.classList.add('active');
            }

            if (pageId === 'home') renderHome();
            if (pageId === 'learn') renderLearn();

            // Close detail if open
            document.getElementById('page-course-detail').classList.remove('show');
        }

        // Header & Navigation Logic
        function handleHeaderBack() {
            // If Course Detail is open, close it
            const detailPage = document.getElementById('page-course-detail');
            if (detailPage.classList.contains('show')) {
                closeCourseDetail();
                return;
            }
            // Otherwise, assume we are in chat mode
            endChat();
        }

        function setLang(lang) {
            appState.lang = lang;
            document.querySelectorAll('.lang-btn').forEach(b => {
                const isActive = b.dataset.lang === lang;
                b.className = isActive
                    ? 'lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all bg-white shadow-sm text-black'
                    : 'lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all text-gray-500';
            });
            updateLevelDesc();
            renderHome();
            renderLearn(); // Refresh courses if on learn page
        }

        function setLevel(lvl) {
            appState.level = lvl;
            document.querySelectorAll('.level-btn').forEach(b => {
                if (b.dataset.lvl === lvl) {
                    b.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-600');
                    b.classList.remove('border-gray-200');
                } else {
                    b.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-600');
                    b.classList.add('border-gray-200');
                }
            });
            updateLevelDesc();
            renderHome();
            renderLearn(); // Refresh courses
        }

        function updateLevelDesc() {
            const config = APP_DATA.langs[appState.lang].levels;
            document.getElementById('lvl-desc-1').innerText = config.beginner;
            document.getElementById('lvl-desc-2').innerText = config.intermediate;
            document.getElementById('lvl-desc-3').innerText = config.advanced;
        }

        function renderHome() {
            const grid = document.getElementById('scenario-grid');
            grid.innerHTML = '';
            // Update: Scenarios are now split by difficulty level
            const scenarios = APP_DATA.langs[appState.lang].scenarios[appState.level] || [];

            scenarios.forEach(s => {
                const div = document.createElement('div');
                div.className = 'ios-card m-0 flex flex-col items-center justify-center py-6 cursor-pointer active:scale-95 transition bg-white shadow-sm hover:shadow-md';
                div.onclick = () => startChat(s);
                div.innerHTML = `
            <div class="w-14 h-14 rounded-full bg-blue-50 flex items-center justify-center mb-3">
                <i class="fas ${s.icon} text-2xl text-blue-500"></i>
            </div>
            <span class="font-bold text-sm text-center text-gray-800">${s.title}</span>
        `;
                grid.appendChild(div);
            });

        }

        // --- Course & Learn Logic (SPEAK App Style) ---
        function renderLearn() {
            const content = document.getElementById('learn-content');
            const badge = document.getElementById('course-level-badge');

            // Get correct course list based on Lang AND Level
            const courses = APP_DATA.courses[appState.lang] ? APP_DATA.courses[appState.lang][appState.level] : [];

            badge.innerText = appState.level.toUpperCase();
            content.innerHTML = '';

            if (!courses || courses.length === 0) {
                content.innerHTML = '<div class="text-center text-gray-400 mt-10">此等級目前尚無課程資料</div>';
                return;
            }

            courses.forEach(c => {
                content.innerHTML += `
            <div class="ios-card m-0 mb-4 border border-gray-100 active:scale-95 transition cursor-pointer relative overflow-hidden" onclick="openCourse(${c.id})">
                <div class="absolute left-0 top-0 bottom-0 w-1 bg-blue-500"></div>
                <div class="flex flex-col gap-1 pl-2">
                    <h3 class="font-bold text-lg text-gray-800">${c.title}</h3>
                    <p class="text-gray-500 text-sm mb-2 line-clamp-1">${c.desc}</p>
                    <div class="flex gap-2 mt-1">
                        <span class="bg-gray-100 text-gray-600 text-[10px] px-2 py-1 rounded">3 個關鍵句</span>
                        <span class="bg-gray-100 text-gray-600 text-[10px] px-2 py-1 rounded">AI 模擬演練</span>
                    </div>
                </div>
                <i class="fas fa-chevron-right absolute right-4 top-1/2 -translate-y-1/2 text-gray-300"></i>
            </div>
        `;
            });
        }

        function openCourse(courseId) {
            const courses = APP_DATA.courses[appState.lang][appState.level];
            const course = courses.find(c => c.id === courseId);
            if (!course) return;

            // Build Detail View
            let sentencesHtml = '';
            course.sentences.forEach((s, idx) => {
                const escapedText = s.text.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                sentencesHtml += `
            <div class="key-sentence-item flex flex-col gap-2 bg-white p-3 rounded border border-gray-100 shadow-sm">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="font-bold text-gray-800 text-lg"><i class="fas fa-quote-left text-blue-300 text-xs mr-1"></i> ${s.text}</div>
                        <div class="text-gray-500 text-sm mt-1 ml-4">${s.trans}</div>
                    </div>
                </div>
                <div class="flex gap-2 mt-2 ml-4">
                    <button onclick="speakText('${escapedText}')" class="bg-blue-50 hover:bg-blue-100 text-blue-600 px-4 py-3 rounded-xl text-sm font-bold flex flex-1 justify-center items-center gap-2 active:scale-95 transition">
                        <i class="fas fa-volume-up text-lg"></i> 朗讀
                    </button>
                    <button onmousedown="startPronunciationPractice('${escapedText}', 'result-${idx}')" onmouseup="stopPronunciationPractice()" onmouseleave="stopPronunciationPractice()" ontouchstart="startPronunciationPractice('${escapedText}', 'result-${idx}')" ontouchend="stopPronunciationPractice()" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 px-4 py-3 rounded-xl text-sm font-bold flex flex-1 justify-center items-center gap-2 active:scale-95 transition shadow-sm border border-indigo-100">
                        <i class="fas fa-microphone text-lg"></i> 按住跟讀
                    </button>
                </div>
                <div id="result-${idx}" class="text-sm mt-1 ml-4 empty:hidden transition-all duration-300"></div>
            </div>`;
            });

            // 加入情境推薦單字
            const vocabs = getCourseVocab(courseId);
            let vocabHtml = '<div class="flex flex-wrap gap-2 mb-4">';
            vocabs.forEach(v => {
                vocabHtml += `<span class="bg-indigo-100 text-indigo-700 font-bold px-3 py-1 rounded-full text-sm">${v}</span>`;
            });
            vocabHtml += '</div>';

            const html = `
        <div class="mb-6">
            <h1 class="text-3xl font-bold mb-2">${course.title}</h1>
            <p class="text-gray-500">${course.desc}</p>
        </div>
        
        <div class="mb-6">
            <h3 class="font-bold text-gray-900 mb-2 flex items-center gap-2"><i class="fas fa-book text-indigo-500"></i> 本課引導單字</h3>
            ${vocabHtml}
            <p class="text-xs text-gray-400">這些單字在目前的情境與難度非常實用，試著加入對話中吧！</p>
        </div>

        <div class="mb-6">
            <h3 class="font-bold text-gray-900 mb-3 flex items-center gap-2"><i class="fas fa-star text-yellow-400"></i> 本課關鍵句 (Key Sentences)</h3>
            <div class="space-y-2">
                ${sentencesHtml}
            </div>
            <p class="text-xs text-gray-400 mt-2">請在接下來的對話練習中嘗試使用這些句子，系統會自動包容時態或連接詞差異。</p>
        </div>

        <div class="mb-8">
            <h3 class="font-bold text-gray-900 mb-3"><i class="fas fa-user-friends text-blue-500"></i> 模擬情境</h3>
            <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700">
                <div class="mb-2"><span class="font-bold text-gray-900">您的角色:</span> ${course.userRole}</div>
                <div class="mb-2"><span class="font-bold text-gray-900">AI 角色:</span> ${course.aiRole}</div>
                <div><span class="font-bold text-gray-900">情境:</span> ${course.context}</div>
            </div>
        </div>

        <button onclick="startCourseChat(${courseId})" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
            <i class="fas fa-microphone"></i> 開始口說練習
        </button>
        <div class="h-10"></div>
    `;

            document.getElementById('course-detail-body').innerHTML = html;

            // Header adjustments
            document.getElementById('header-title').innerText = "課程詳情";
            document.getElementById('header-back-btn').style.display = 'flex';
            document.getElementById('header-back-btn').onclick = closeCourseDetail;
            document.getElementById('back-text').innerText = "列表";

            // Show overlay
            document.getElementById('page-course-detail').classList.add('show');
        }

        function closeCourseDetail() {
            document.getElementById('page-course-detail').classList.remove('show');
            // Reset Header
            document.getElementById('header-title').innerText = "My Learning";
            document.getElementById('header-back-btn').style.display = 'none';
            document.getElementById('header-back-btn').onclick = endChat;
        }

        /* =========================================
           4. CHAT SYSTEM (Updated for Course Mode)
           ========================================= */

        // Start Chat from Course
        function startCourseChat(courseId) {
            if (!localStorage.getItem('v21_key')) {
                alert("請先設定 API Key");
                return;
            }

            const courses = APP_DATA.courses[appState.lang][appState.level];
            const course = courses.find(c => c.id === courseId);

            // Close detail page properly
            closeCourseDetail();

            // Set State
            appState.currentScenario = {
                title: course.title,
                role: course.aiRole,
                user: course.userRole,
                context: course.context // Special context
            };
            appState.courseMode = true; // Mark as course mode
            appState.chatHistory = [];
            appState.completedMissions = [];
            appState.missionWords = course.sentences.map(s => s.text); // Mission = Course Sentences

            // Switch UI
            document.getElementById('header-title').innerText = "課程練習";
            document.getElementById('header-back-btn').style.display = 'flex';
            document.getElementById('back-text').innerText = "結束";
            document.getElementById('audio-toggle').style.display = 'block';

            updateMissionUI();

            const container = document.getElementById('chat-container');
            container.innerHTML = `<div class="text-center text-gray-400 text-xs mt-8 mb-4">
        課程模式: ${course.title}<br>
        目標: 使用關鍵句
    </div>`;

            document.body.classList.add('chat-mode');
            document.querySelectorAll('.ios-page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-chat').classList.add('active-page');

            triggerAIResponse(true);
        }

        // Start Normal Chat
        function startChat(scenario) {
            if (!localStorage.getItem('v21_key')) {
                alert("請先設定 API Key");
                switchPage('settings', document.querySelectorAll('.tab-item')[3]);
                return;
            }

            appState.currentScenario = scenario;
            appState.courseMode = false;
            appState.chatHistory = [];
            appState.completedMissions = [];

            // 依據語言與難度與情境載入過關單字
            const scenarioId = scenario === 'free' ? 'free' : scenario.id;
            const pool = MISSION_DATA[appState.lang][scenarioId][appState.level];
            appState.missionWords = pool || ['Hello', 'Thank you', 'Please'];

            // UI Update
            document.getElementById('header-title').innerText = scenario === 'free' ? "自由對話" : scenario.title;
            document.getElementById('header-back-btn').style.display = 'flex';
            document.getElementById('back-text').innerText = "結束";
            document.getElementById('audio-toggle').style.display = 'block';
            updateMissionUI();

            const container = document.getElementById('chat-container');
            container.innerHTML = `<div class="text-center text-gray-400 text-xs mt-8 mb-4">
        對話已就緒 (${APP_DATA.langs[appState.lang].name})
    </div>`;

            document.body.classList.add('chat-mode');
            document.querySelectorAll('.ios-page').forEach(p => p.classList.remove('active-page'));
            document.getElementById('page-chat').classList.add('active-page');

            triggerAIResponse(true);
        }

        function endChat() {
            document.body.classList.remove('chat-mode');
            document.getElementById('header-back-btn').style.display = 'none';
            document.getElementById('audio-toggle').style.display = 'none';
            document.getElementById('header-title').innerText = "My Learning";
            window.speechSynthesis.cancel();

            // Return logic: if was course, go to learn, else home
            if (appState.courseMode) {
                switchPage('learn', document.querySelectorAll('.tab-item')[1]);
            } else {
                switchPage('home', document.querySelectorAll('.tab-item')[0]);
            }
        }

        function updateMissionUI() {
            const container = document.getElementById('mission-words');
            container.innerHTML = '';
            appState.missionWords.forEach(word => {
                const isDone = appState.completedMissions.some(m => word.toLowerCase().includes(m.toLowerCase()) || m.toLowerCase().includes(word.toLowerCase()));
                const span = document.createElement('span');
                // Handle long sentences in course mode
                const displayWord = word.length > 15 ? word.substring(0, 12) + "..." : word;

                span.className = `flex-none px-2 py-1 rounded border text-xs whitespace-nowrap transition-all ${isDone ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-gray-300 text-gray-600'}`;
                span.innerHTML = isDone ? `<i class="fas fa-check mr-1"></i>${displayWord}` : displayWord;
                container.appendChild(span);
            });
        }

        // Audio Toggle
        function toggleAutoAudio() {
            appState.autoAudio = !appState.autoAudio;
            const btn = document.getElementById('audio-icon');
            if (appState.autoAudio) {
                btn.innerHTML = '<i class="fas fa-volume-up"></i> 朗讀';
                btn.classList.remove('opacity-50');
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i> 靜音';
                btn.classList.add('opacity-50');
            }
        }

        // === 修正任務判定邏輯 (寬鬆比對/時態包容) 全域化 ===
        function checkMissionStandalone(input, target, lang) {
            const cleanIn = input.toLowerCase().replace(/[.,\/#!$%\\^&\\*;:{}=\\-_`~()?\s+]/g, " ");
            const cleanTar = target.toLowerCase().replace(/[.,\/#!$%\\^&\\*;:{}=\\-_`~()?\s+]/g, " ");

            if (cleanIn.replace(/\s+/g, "").includes(cleanTar.replace(/\s+/g, "")) ||
                cleanTar.replace(/\s+/g, "").includes(cleanIn.replace(/\s+/g, ""))) return true;

            if (lang === 'en') {
                const stopWords = ['i', 'you', 'he', 'she', 'it', 'we', 'they', 'a', 'an', 'the', 'is', 'am', 'are', 'was', 'were', 'to', 'and', 'but', 'or', 'in', 'on', 'at'];
                const wordsTar = cleanTar.split(/\s+/).filter(w => w.length > 2 && !stopWords.includes(w));
                const wordsIn = cleanIn.split(/\s+/);
                let matchCount = 0;
                for (let wt of wordsTar) {
                    const stem = wt.replace(/(ing|ed|s|ly|d)$/, '');
                    if (wordsIn.some(wi => wi.includes(stem))) matchCount++;
                }
                if (wordsTar.length > 0 && (matchCount / wordsTar.length) >= 0.5) return true;
            } else {
                const charIn = cleanIn.replace(/\s+/g, "");
                const charTar = cleanTar.replace(/\s+/g, "");
                const minMatchLen = Math.max(2, Math.floor(charTar.length * 0.5));
                for (let i = 0; i <= charTar.length - minMatchLen; i++) {
                    const chunk = charTar.substring(i, i + minMatchLen);
                    if (charIn.includes(chunk)) return true;
                }
            }
            return false;
        }

        // --- 發音與跟讀練習模組 ---
        let pronuncRecognition = null;

        function startPronunciationPractice(targetText, elementId) {
            if (!('webkitSpeechRecognition' in window)) {
                alert("您的瀏覽器不支援語音辨識功能，請使用 Chrome 或 Safari.");
                return;
            }

            const resEl = document.getElementById(elementId);
            resEl.innerHTML = '<span class="text-blue-500 font-medium"><i class="fas fa-spinner fa-spin mr-1"></i> 聆聽中... 請說話</span>';
            resEl.className = "text-sm mt-2 p-2 bg-blue-50 rounded border border-blue-100 empty:hidden transition-all";

            if (pronuncRecognition) {
                try { pronuncRecognition.stop(); } catch (e) { }
            }

            pronuncRecognition = new webkitSpeechRecognition();
            pronuncRecognition.continuous = false;
            const map = { 'en': 'en-US', 'jp': 'ja-JP', 'kr': 'ko-KR' };
            pronuncRecognition.lang = map[appState.lang];

            let handled = false;

            pronuncRecognition.onresult = (e) => {
                handled = true;
                const transcript = e.results[0][0].transcript;
                const isPass = checkMissionStandalone(transcript, targetText, appState.lang);

                if (isPass) {
                    resEl.innerHTML = '<span class="text-green-600 font-bold"><i class="fas fa-check-circle mr-1"></i> 發音標準！</span>';
                    resEl.className = "text-sm mt-2 p-2 bg-green-50 rounded border border-green-200 empty:hidden active transition-all";
                } else {
                    resEl.innerHTML = `<span class="text-red-500 font-bold"><i class="fas fa-times-circle mr-1"></i> 聽起來像:</span> <span class="text-gray-700">${transcript}</span>`;
                    resEl.className = "text-sm mt-2 p-2 bg-red-50 rounded border border-red-200 empty:hidden active transition-all";
                }
            };

            pronuncRecognition.onerror = (e) => {
                if (!handled) {
                    resEl.innerHTML = '<span class="text-gray-500"><i class="fas fa-exclamation-circle mr-1"></i> 沒有偵測到聲音或發生錯誤</span>';
                    resEl.className = "text-sm mt-2 p-2 bg-gray-50 rounded border border-gray-200 empty:hidden active transition-all";
                }
            };

            pronuncRecognition.onend = () => {
                if (!handled && resEl.innerHTML.includes('聆聽中')) {
                    resEl.innerHTML = '<span class="text-gray-500"><i class="fas fa-stop-circle mr-1"></i> 錄音結束</span>';
                    resEl.className = "text-sm mt-2 p-2 bg-gray-50 rounded border border-gray-200 empty:hidden active transition-all";
                }
            };

            try { pronuncRecognition.start(); } catch (e) { }
        }

        function stopPronunciationPractice() {
            if (pronuncRecognition) {
                try { pronuncRecognition.stop(); } catch (e) { }
            }
        }

        // Chat Send Logic
        async function handleUserSend() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            window.speechSynthesis.cancel();
            input.value = '';

            appState.missionWords.forEach(target => {
                if (checkMissionStandalone(text, target, appState.lang)) {
                    if (!appState.completedMissions.includes(target)) {
                        appState.completedMissions.push(target);
                    }
                }
            });
            updateMissionUI();

            addBubble(text, 'user');
            await triggerAIResponse(false, text);
        }

        document.getElementById('send-btn').addEventListener('click', handleUserSend);
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleUserSend(); });

        function addBubble(text, type, correction = null) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = type === 'user' ? 'bubble-user' : 'bubble-ai';

            let html = '';
            if (correction) {
                html += `<div class="correction-box">
            <div class="font-bold flex items-center gap-1"><i class="fas fa-magic"></i> 優化建議</div>
            <div class="text-gray-800">${correction.correction}</div>
            <div class="text-[11px] mt-1 opacity-80 border-t border-yellow-300 pt-1">${correction.reason}</div>
        </div>`;
            }
            html += `<div>${text}</div>`;

            if (type === 'ai') {
                const cleanText = text.replace(/"/g, "&quot;");
                html += `<div onclick="speakText(this.nextElementSibling.innerText)" class="absolute -left-10 bottom-0 text-gray-400 p-2 cursor-pointer"><i class="fas fa-volume-up"></i></div><div style="display:none">${cleanText}</div>`;
            }

            div.innerHTML = html;
            container.appendChild(div);

            // === 修正捲動邏輯 ===
            // 使用 requestAnimationFrame 確保畫面渲染完才捲動
            requestAnimationFrame(() => {
                container.scrollTop = container.scrollHeight;
            });
            // 雙重保險，防止圖片載入造成的高度變化
            setTimeout(() => { container.scrollTop = container.scrollHeight; }, 100);
        }

        async function triggerAIResponse(isInit, userText) {
            const container = document.getElementById('chat-container');
            const loaderId = 'loader-' + Date.now();

            if (!isInit) {
                const loader = document.createElement('div');
                loader.id = loaderId;
                loader.className = 'bubble-ai';
                loader.innerHTML = '<div class="flex gap-1"><span class="animate-bounce">●</span><span class="animate-bounce" style="animation-delay:0.1s">●</span><span class="animate-bounce" style="animation-delay:0.2s">●</span></div>';
                container.appendChild(loader);
                container.scrollTop = container.scrollHeight;
            }

            try {
                let contents = [];
                let sysPrompt = "";
                const langName = APP_DATA.langs[appState.lang].name;

                if (appState.courseMode) {
                    sysPrompt = `
             System: Roleplay for Language Learning (${langName}). Level: ${appState.level}.
             Scenario: ${appState.currentScenario.context}
             Your Role: ${appState.currentScenario.role}
             User Role: ${appState.currentScenario.user}
             Goal: Help user practice these sentences: ${appState.missionWords.join(', ')}.
             
             Instructions:
             1. Stay in character.
             2. Be encouraging.
             3. If user makes grammar mistake, start with JSON {"correction": "...", "reason": "..."}.
             4. Keep replies concise.
             `;
                } else {
                    // Normal Mode
                    const scenarioInfo = appState.currentScenario === 'free'
                        ? "Mode: Free Talk."
                        : `Scenario: ${appState.currentScenario.title}. Role: ${appState.currentScenario.role}.`;
                    sysPrompt = `System: Tutor for ${langName}. Level: ${appState.level}. ${scenarioInfo}. If mistake, JSON {"correction":...}.`;
                }

                contents.push({ role: "user", parts: [{ text: sysPrompt }] });
                appState.chatHistory.slice(-6).forEach(msg => {
                    contents.push({ role: msg.role, parts: [{ text: msg.text }] });
                });

                if (!isInit) {
                    contents.push({ role: "user", parts: [{ text: userText }] });
                    appState.chatHistory.push({ role: "user", text: userText });
                } else {
                    contents.push({ role: "user", parts: [{ text: "Start the conversation naturally based on the scenario." }] });
                }

                const rawText = await callGemini(contents);

                const loader = document.getElementById(loaderId);
                if (loader) loader.remove();

                let replyText = rawText;
                let correctionData = null;
                const jsonMatch = rawText.match(/\{[\s\S]*"correction"[\s\S]*\}/);
                if (jsonMatch) {
                    try {
                        correctionData = JSON.parse(jsonMatch[0]);
                        replyText = rawText.replace(jsonMatch[0], '').trim();
                    } catch (e) { }
                }

                addBubble(replyText, 'ai', correctionData);
                appState.chatHistory.push({ role: "model", text: rawText });

                if (appState.autoAudio && replyText) speakText(replyText);

            } catch (err) {
                const loader = document.getElementById(loaderId);
                if (loader) loader.remove();
                if (!isInit) alert("Error: " + err.message);
            }
        }

        // --- UTILS ---
        function speakText(text) {
            if (!text) return;
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            const map = { 'en': 'en-US', 'jp': 'ja-JP', 'kr': 'ko-KR' };
            u.lang = map[appState.lang];
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        // STT
        const micBtn = document.getElementById('mic-btn');
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            micBtn.onclick = () => {
                if (micBtn.classList.contains('recording')) {
                    recognition.stop();
                } else {
                    const map = { 'en': 'en-US', 'jp': 'ja-JP', 'kr': 'ko-KR' };
                    recognition.lang = map[appState.lang];
                    recognition.start();
                    micBtn.classList.add('recording', 'bg-red-500', 'text-white');
                    micBtn.innerHTML = '<i class="fas fa-stop"></i>';
                }
            };
            recognition.onresult = (e) => {
                document.getElementById('chat-input').value = e.results[0][0].transcript;
                micBtn.classList.remove('recording', 'bg-red-500', 'text-white');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            };
            recognition.onend = () => {
                micBtn.classList.remove('recording', 'bg-red-500', 'text-white');
                micBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            };
        } else { micBtn.style.display = 'none'; }

        // Vocab Quiz Toggle
        /* =========================================
           Vocab & Quiz Logic (Updated)
           ========================================= */

        function setVocabLang(lang) {
            appState.vocabLang = lang;
            document.querySelectorAll('.vocab-lang-btn').forEach(b => {
                const isActive = b.dataset.lang === lang;
                b.className = isActive
                    ? 'vocab-lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all bg-white shadow-sm text-black'
                    : 'vocab-lang-btn flex-1 py-1 rounded-md text-sm font-medium transition-all text-gray-500';
            });
            renderVocab();
        }

        function openQuizModal() {
            const filteredVocab = appState.vocabList.filter(v => v.lang === appState.vocabLang);
            if (filteredVocab.length < 4) {
                alert("該語言的單字少於 4 個，選項不足，請多收藏一些單字再來測驗！");
                return;
            }
            appState.quizVocab = [...filteredVocab].sort(() => 0.5 - Math.random());
            appState.quizIndex = 0;
            appState.quizScore = 0;
            document.getElementById('quiz-modal').classList.remove('hidden');
            renderQuizQuestion();
        }

        function closeQuizModal() {
            document.getElementById('quiz-modal').classList.add('hidden');
        }

        function renderQuizQuestion() {
            const container = document.getElementById('quiz-content');
            if (appState.quizIndex >= appState.quizVocab.length) {
                container.innerHTML = `
            <div class="text-center py-6">
                <div class="text-5xl mb-4">🎉</div>
                <h3 class="text-xl font-bold mb-2">測驗完成！</h3>
                <p class="text-gray-500">得分: ${appState.quizScore} / ${appState.quizVocab.length}</p>
                <button onclick="closeQuizModal()" class="mt-6 w-full bg-blue-500 text-white py-3 rounded-lg font-bold shadow-md">關閉</button>
            </div>
        `;
                return;
            }

            const currentWord = appState.quizVocab[appState.quizIndex];
            const otherVocab = appState.vocabList.filter(v => v.lang === appState.vocabLang && v.id !== currentWord.id);
            const shuffledOthers = [...otherVocab].sort(() => 0.5 - Math.random()).slice(0, 3);
            const options = [...shuffledOthers, currentWord].sort(() => 0.5 - Math.random());

            let optionsHtml = '';
            options.forEach(opt => {
                optionsHtml += `<button onclick="checkQuizAnswer('${opt.id}', '${currentWord.id}')" class="w-full text-left p-3 mb-3 border border-gray-200 rounded-lg hover:bg-blue-50 active:bg-blue-100 transition-all outline-none font-medium text-gray-800">${opt.trans}</button>`;
            });

            container.innerHTML = `
        <div class="mb-4 flex justify-between text-sm text-gray-500 font-medium">
            <span>第 ${appState.quizIndex + 1} 題 / 共 ${appState.quizVocab.length} 題</span>
            <span>分數: ${appState.quizScore}</span>
        </div>
        <div class="text-center py-8 mb-6 bg-gray-50 rounded-xl border border-gray-100 shadow-sm flex items-center justify-center min-h-[120px]">
            <h4 class="text-3xl font-bold text-blue-600 break-words w-full px-4">${currentWord.word}</h4>
        </div>
        <div class="space-y-1">
            ${optionsHtml}
        </div>
    `;
        }

        function checkQuizAnswer(selectedId, correctId) {
            if (String(selectedId) === String(correctId)) {
                appState.quizScore++;
            } else {
                const correctWord = appState.quizVocab.find(v => String(v.id) === String(correctId));
                alert(`❌ 答錯了！\n正確答案是: ${correctWord.trans}`);
            }
            appState.quizIndex++;
            renderQuizQuestion();
        }

        function renderVocab() {
            const list = document.getElementById('vocab-list');
            const filteredVocab = appState.vocabList.filter(v => v.lang === appState.vocabLang);

            if (!filteredVocab.length) {
                list.innerHTML = '<div class="text-center text-gray-400 mt-10">該語言尚無單字<br>請在對話中選取文字進行收藏</div>';
                return;
            }
            list.innerHTML = '';
            filteredVocab.forEach(v => {
                list.innerHTML += `
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center relative">
            <div>
                <div class="font-bold text-lg text-gray-800">${v.word}</div>
                <div class="text-gray-500 text-sm mt-1">${v.trans}</div>
            </div>
            <button onclick="delVocab(${v.id})" class="text-gray-300 hover:text-red-500 px-4 py-2"><i class="fas fa-trash"></i></button>
        </div>`;
            });
        }

        function delVocab(id) {
            if (!confirm("確定要刪除這個單字嗎？")) return;
            appState.vocabList = appState.vocabList.filter(v => v.id !== id);
            localStorage.setItem('my_vocab', JSON.stringify(appState.vocabList));
            renderVocab();
        }

        // Selection Translate
        // === 修正選取翻譯邏輯 ===
        document.addEventListener('selectionchange', () => {
            const sel = window.getSelection();
            const btn = document.getElementById('float-translate-btn');
            const chatPage = document.getElementById('page-chat');

            // 只有在聊天頁面且有選取文字時才顯示
            if (sel.toString().trim().length > 0 && chatPage.classList.contains('active-page')) {
                // 改為固定位置顯示在頂部，避免被手機原生選單遮擋
                btn.style.display = 'block';
                btn.style.top = '100px'; // 固定在 Header 下方
                btn.style.left = '50%';
                btn.style.transform = 'translateX(-50%)';
                btn.style.zIndex = '9999'; // 確保最上層

                // 使用 onmousedown 防止點擊時失去焦點導致選取消失
                btn.onmousedown = async (e) => {
                    e.preventDefault(); // 關鍵：防止按鈕點擊取消了文字選取
                    e.stopPropagation();

                    const text = sel.toString();
                    btn.style.display = 'none';
                    sel.removeAllRanges(); // 翻譯後取消選取

                    await doTranslate(text);
                };
            } else {
                btn.style.display = 'none';
            }
        });

        async function doTranslate(text) {
            const id = Date.now();
            // 先顯示載入中狀態
            appState.vocabList.unshift({ id, word: text, trans: "翻譯中...", lang: appState.lang });
            renderVocab();

            try {
                // 呼叫 API (這裡會使用你剛改好的 Vercel 連線版 callGemini)
                const res = await callGemini([{ role: "user", parts: [{ text: `Translate "${text}" to Traditional Chinese. Just output translation.` }] }]);

                // 更新結果
                const item = appState.vocabList.find(i => i.id === id);
                if (item) {
                    item.trans = res.trim();
                    localStorage.setItem('my_vocab', JSON.stringify(appState.vocabList));
                    renderVocab();
                    // 簡單提示
                    alert(`已收藏：\n${text}\n⬇\n${res.trim()}`);
                }
            } catch (e) {
                console.error(e);
                alert("翻譯失敗，請檢查網路或 API Key");
                // 失敗則移除該項目
                appState.vocabList = appState.vocabList.filter(v => v.id !== id);
                renderVocab();
            }
        }

        function saveApiKey() {
            const key = document.getElementById('api-key-input').value.trim();
            if (key) { localStorage.setItem('v21_key', key); alert("API Key 已儲存"); location.reload(); }
        }
        function backupData() {
            const data = { key: localStorage.getItem('v21_key'), vocab: appState.vocabList };
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "mylearning_backup.json";
            a.click();
        }
        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if (d.key) localStorage.setItem('v21_key', d.key);
                    if (d.vocab) localStorage.setItem('my_vocab', JSON.stringify(d.vocab));
                    alert("還原成功！");
                    location.reload();
                } catch (err) { }
            };
            r.readAsText(file);
        }

        init();
    </script>
</body>

</html>
