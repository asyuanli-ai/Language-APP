<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">
    <title>LingoFlow v22.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        .selectable { user-select: text; }
        body { background-color: #F2F2F7; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; overflow: hidden; }
        .page-view { position: absolute; inset: 0; bottom: 85px; overflow-y: auto; padding: 20px; padding-top: 60px; scroll-behavior: smooth; }
        .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.1); }
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .ios-card:active { transform: scale(0.98); }
        .ios-btn { background: #007AFF; color: white; border-radius: 14px; font-weight: 600; }
        #word-tools { display: none; position: absolute; background: #1C1C1E; color: white; padding: 10px 16px; border-radius: 12px; z-index: 2000; font-size: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        /* éš±è—æ²è»¸ */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="h-[100dvh] w-screen text-slate-900">

    <div id="word-tools">
        <div class="flex items-center gap-3">
            <span id="sel-text" class="max-w-[100px] truncate opacity-80 border-r border-gray-600 pr-3"></span>
            <button onclick="translateAndSave()" class="text-blue-400 font-bold whitespace-nowrap">ç¿»è­¯ä¸¦æ”¶è—</button>
        </div>
    </div>

    <div id="app" class="h-full relative">
        
        <div class="fixed top-0 w-full h-[50px] z-40 bg-[#F2F2F7]/90 backdrop-blur flex justify-between items-end pb-2 px-6">
            <span id="header-time" class="text-xs font-bold">9:41</span>
            <div class="flex gap-1">
                <i class="fa-solid fa-signal text-xs"></i>
                <i class="fa-solid fa-wifi text-xs"></i>
                <i class="fa-solid fa-battery-full text-xs"></i>
            </div>
        </div>

        <div id="view-home" class="page-view">
            <h1 class="text-3xl font-bold mb-6 tracking-tight">Today</h1>
            
            <div class="bg-gray-200 p-1 rounded-xl flex mb-6 text-xs font-bold text-center">
                <div onclick="setLevel('Easy')" id="lvl-Easy" class="flex-1 py-2 rounded-lg bg-white shadow-sm transition-all cursor-pointer">åˆç´š</div>
                <div onclick="setLevel('Medium')" id="lvl-Medium" class="flex-1 py-2 rounded-lg text-gray-500 transition-all cursor-pointer">ä¸­ç´š</div>
                <div onclick="setLevel('Hard')" id="lvl-Hard" class="flex-1 py-2 rounded-lg text-gray-500 transition-all cursor-pointer">é«˜ç´š</div>
            </div>

            <div onclick="startChat('Free Talk', 'Friend')" class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-[24px] text-white mb-8 shadow-lg shadow-blue-200 active:scale-95 transition-all relative overflow-hidden">
                <div class="relative z-10">
                    <h3 class="font-bold text-2xl">Free Talk</h3>
                    <p class="text-blue-100 text-sm mt-1">è‡ªç”±å°è©± â€¢ éš¨æ©Ÿè©±é¡Œ</p>
                </div>
                <i class="fa-solid fa-comments absolute -bottom-4 -right-4 text-8xl text-white opacity-20"></i>
            </div>

            <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 ml-1">æƒ…å¢ƒé¸æ“‡</h2>
            <div id="scenario-list" class="space-y-4 pb-10"></div>
        </div>

        <div id="view-learn" class="page-view hidden">
            <h1 class="text-3xl font-bold mb-6 tracking-tight">èª²ç¨‹</h1>
            <div id="lesson-list" class="space-y-4 pb-10"></div>
        </div>

        <div id="view-vocab" class="page-view hidden">
            <div class="flex justify-between items-end mb-6">
                <h1 class="text-3xl font-bold tracking-tight">å–®å­—æœ¬</h1>
                <button onclick="startQuiz()" class="bg-orange-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow active:scale-95">æ¸¬é©—</button>
            </div>
            
            <div class="flex gap-2 mb-4 overflow-x-auto">
                <button onclick="filterVocab('All')" class="px-3 py-1 bg-white rounded-full text-xs font-bold border">å…¨éƒ¨</button>
                <button onclick="filterVocab('English')" class="px-3 py-1 bg-white rounded-full text-xs font-bold border">English</button>
                <button onclick="filterVocab('Japanese')" class="px-3 py-1 bg-white rounded-full text-xs font-bold border">æ—¥æœ¬èª</button>
            </div>

            <div id="vocab-display-list" class="space-y-3 pb-10"></div>
        </div>

        <div id="view-settings" class="page-view hidden">
            <h1 class="text-3xl font-bold mb-6 tracking-tight">è¨­å®š</h1>
            
            <div class="bg-white rounded-2xl overflow-hidden shadow-sm mb-6">
                <div class="p-4 border-b">
                    <label class="text-xs font-bold text-gray-400 uppercase">API é‡‘é‘°</label>
                    <input type="password" id="api-key-input" class="w-full mt-2 outline-none text-sm" placeholder="AIza...">
                </div>
                <div class="p-4 border-b">
                    <label class="text-xs font-bold text-gray-400 uppercase">Project ID (é¸å¡«)</label>
                    <input type="text" id="project-id-input" class="w-full mt-2 outline-none text-sm" placeholder="é˜²æ­¢ 404 æ¬Šé™éŒ¯èª¤">
                </div>
                <div class="p-4">
                    <label class="text-xs font-bold text-gray-400 uppercase">ç·´ç¿’èªè¨€</label>
                    <select id="target-lang" class="w-full mt-2 outline-none bg-transparent font-bold text-blue-600" onchange="renderLessons();">
                        <option value="English">English (è‹±èª)</option>
                        <option value="Japanese">æ—¥æœ¬èª (æ—¥èª)</option>
                        <option value="Korean">í•œêµ­ì–´ (éŸ“èª)</option>
                    </select>
                </div>
            </div>

            <div class="bg-white rounded-2xl overflow-hidden shadow-sm mb-6">
                <div onclick="backupData()" class="p-4 border-b flex justify-between items-center active:bg-gray-50">
                    <span class="text-sm font-medium">å‚™ä»½è³‡æ–™ (JSON)</span>
                    <i class="fa-solid fa-cloud-arrow-down text-blue-500"></i>
                </div>
                <label class="p-4 flex justify-between items-center active:bg-gray-50 cursor-pointer">
                    <span class="text-sm font-medium">é‚„åŸè³‡æ–™</span>
                    <i class="fa-solid fa-cloud-arrow-up text-green-500"></i>
                    <input type="file" onchange="restoreData(this)" class="hidden" accept=".json">
                </label>
            </div>

            <button onclick="saveSettings()" class="w-full bg-[#007AFF] text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 text-sm">å„²å­˜è¨­å®š</button>
            <p class="text-center text-[10px] text-gray-400 mt-4">LingoFlow v22.0 Flagship</p>
        </div>

        <div id="view-chat" class="fixed inset-0 bg-[#F2F2F7] z-50 hidden flex flex-col translate-x-full transition-transform duration-300">
            <div class="h-[100px] bg-white/90 backdrop-blur pt-10 px-4 flex justify-between items-center border-b shadow-sm z-10">
                <button onclick="closeChat()" class="text-[#007AFF] flex items-center gap-1 font-medium"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
                <div class="text-center">
                    <h2 id="chat-title" class="font-bold text-sm">å°è©±</h2>
                    <span id="chat-subtitle" class="text-[10px] text-gray-400">é€£ç·šä¸­...</span>
                </div>
                <button onclick="startChat(currentTitle, currentRole)" class="text-[#007AFF] text-xl"><i class="fa-solid fa-rotate-right"></i></button>
            </div>

            <div id="mission-bar" class="bg-blue-50 px-4 py-2 flex justify-between items-center text-xs text-blue-800 border-b border-blue-100 hidden">
                <span class="font-bold">ğŸ¯ æœ¬æ¬¡ä»»å‹™å–®å­—ï¼š</span>
                <span id="mission-words" class="font-mono">Loading...</span>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6"></div>

            <div class="bg-white/90 backdrop-blur border-t p-2 pb-8 flex items-end gap-2">
                <button id="btn-mic" onclick="toggleSpeech()" class="w-10 h-10 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition-all flex items-center justify-center">
                    <i class="fa-solid fa-microphone text-xl"></i>
                </button>
                <div class="flex-1 bg-gray-100 rounded-2xl px-4 py-2 min-h-[40px] flex items-center">
                    <input type="text" id="msg-input" class="w-full bg-transparent outline-none text-sm" placeholder="è¼¸å…¥è¨Šæ¯..." onkeypress="if(event.key==='Enter') sendUserMessage()">
                </div>
                <button onclick="sendUserMessage()" class="w-10 h-10 bg-[#007AFF] text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-all">
                    <i class="fa-solid fa-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>

    <nav class="glass-nav fixed bottom-0 w-full h-[85px] flex justify-around pt-3 z-40">
        <button onclick="switchView('home')" class="nav-btn text-[#007AFF] flex flex-col items-center gap-1"><i class="fa-solid fa-layer-group text-xl"></i><span class="text-[10px] font-medium">é¦–é </span></button>
        <button onclick="switchView('learn')" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i class="fa-solid fa-graduation-cap text-xl"></i><span class="text-[10px] font-medium">èª²ç¨‹</span></button>
        <button onclick="switchView('vocab')" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i class="fa-solid fa-book-bookmark text-xl"></i><span class="text-[10px] font-medium">å–®å­—</span></button>
        <button onclick="switchView('settings')" class="nav-btn text-gray-400 flex flex-col items-center gap-1"><i class="fa-solid fa-gear text-xl"></i><span class="text-[10px] font-medium">è¨­å®š</span></button>
    </nav>

    <script>
        // --- State Management ---
        let state = {
            apiKey: localStorage.getItem('v22_key') || '',
            projectId: localStorage.getItem('v22_proj') || '',
            lang: localStorage.getItem('v22_lang') || 'English',
            level: localStorage.getItem('v22_level') || 'Medium',
            vocabs: JSON.parse(localStorage.getItem('v22_vocabs') || '[]'),
            chatHistory: []
        };
        
        let currentTitle = '';
        let currentRole = '';
        let recognition = null;
        let isRecording = false;

        // --- Data: Curriculums & Scenarios ---
        const curriculumData = {
            'English': {
                'Easy': ['Alphabet & Phonics', 'Basic Greetings', 'Numbers & Colors'],
                'Medium': ['Ordering at a Cafe', 'Asking Directions', 'Making Appointments'],
                'Hard': ['Job Interview', 'Debating Topics', 'Business Presentation']
            },
            'Japanese': {
                'Easy': ['äº”åéŸ³ (Hiragana)', 'è‡ªå·±ç´¹ä»‹ (N5)', 'è²·ã„ç‰© (N5)'],
                'Medium': ['ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ (N3)', 'æ—…è¡Œã®è¨ˆç”» (N3)', 'é›»è©±å¯¾å¿œ (N3)'],
                'Hard': ['æ•¬èªã®ä½¿ã„æ–¹ (N1)', 'ãƒ‹ãƒ¥ãƒ¼ã‚¹è¨è«– (N1)', 'ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ« (N1)']
            }
        };

        const scenarios = [
            { id: 'cafe', title: 'Coffee Shop', role: 'Barista', icon: 'fa-mug-hot', color: 'text-amber-600 bg-amber-50' },
            { id: 'hotel', title: 'Hotel Check-in', role: 'Receptionist', icon: 'fa-bell', color: 'text-indigo-600 bg-indigo-50' },
            { id: 'interview', title: 'Job Interview', role: 'Interviewer', icon: 'fa-user-tie', color: 'text-slate-600 bg-slate-50' },
            { id: 'friend', title: 'Casual Chat', role: 'Close Friend', icon: 'fa-face-smile', color: 'text-green-600 bg-green-50' }
        ];

        const missionWords = {
            'English': ['awesome', 'perspective', 'actually', 'wonder', 'appreciate'],
            'Japanese': ['å®Ÿã¯ (jitsuwa)', 'ä¾‹ãˆã° (tatoeba)', 'ç¢ºã‹ã« (tashikani)', 'æ„Ÿå‹• (kandou)']
        };

        // --- Initialization ---
        window.onload = () => {
            updateTime();
            setInterval(updateTime, 10000);
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('project-id-input').value = state.projectId;
            document.getElementById('target-lang').value = state.lang;
            setLevel(state.level);
            renderScenarios();
            renderLessons();
            document.addEventListener('mouseup', handleTextSelection);
            
            // Init Speech Recognition
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = getSpeechLang();
                recognition.onresult = (event) => {
                    document.getElementById('msg-input').value = event.results[0][0].transcript;
                    toggleSpeech(); // stop recording
                };
            }
        };

        function updateTime() {
            const now = new Date();
            document.getElementById('header-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // --- Core: Gemini API Call (Robust Version) ---
        async function callGemini(contents) {
            if (!state.apiKey) throw new Error("è«‹è‡³è¨­å®šå¡«å¯« API Key");
            
            // Auto-detect endpoint strategy
            const urls = [
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`,
                `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${state.apiKey}`,
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${state.apiKey}`
            ];

            const headers = { 'Content-Type': 'application/json' };
            if (state.projectId) headers['X-Goog-User-Project'] = state.projectId;

            for (let url of urls) {
                try {
                    const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify({ contents }) });
                    const data = await res.json();
                    if (res.ok) return data.candidates[0].content.parts[0].text;
                } catch (e) { console.error(e); }
            }
            throw new Error("é€£ç·šå¤±æ•— (404/403)ã€‚è«‹æª¢æŸ¥è¨­å®šä¸­çš„ Project ID èˆ‡ API Key æ¬Šé™ã€‚");
        }

        // --- Logic: Chat ---
        async function startChat(title, role) {
            currentTitle = title;
            currentRole = role;
            
            // Setup UI
            document.getElementById('view-chat').classList.remove('translate-x-full');
            document.getElementById('chat-title').innerText = title;
            document.getElementById('chat-container').innerHTML = '';
            document.getElementById('chat-subtitle').innerText = "AI æº–å‚™ä¸­...";
            
            // Mission System
            const missions = getMissions();
            document.getElementById('mission-bar').classList.remove('hidden');
            document.getElementById('mission-words').innerText = missions.join(', ');

            // System Prompt construction
            let levelDesc = state.level === 'Easy' ? 'Beginner (N5/A1)' : state.level === 'Medium' ? 'Intermediate (N3/B1)' : 'Advanced (N1/C1)';
            let systemPrompt = `Act as a ${role} in ${state.lang}. User level: ${levelDesc}. 
            Task 1: If user makes grammar mistakes, start response with a JSON block: {"correction": "Corrected sentence", "reason": "Short explanation"}. 
            Task 2: Then reply naturally to continue the conversation.
            Task 3: Guide user to use these words: ${missions.join(', ')}.`;

            state.chatHistory = [{ role: 'user', parts: [{ text: systemPrompt + " Start with a short greeting." }] }];

            try {
                const response = await callGemini(state.chatHistory);
                document.getElementById('chat-subtitle').innerText = "ä¸Šç·šä¸­";
                addAiBubble(response);
                // We don't push the exact system prompt instruction result to history to keep context clean, just the assistant reply
                state.chatHistory.push({ role: 'model', parts: [{ text: response }] });
            } catch (e) {
                addSystemBubble(`é€£ç·šéŒ¯èª¤: ${e.message}`);
                document.getElementById('chat-subtitle').innerText = "é›¢ç·š";
            }
        }

        async function sendUserMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            addUserBubble(text);
            input.value = '';
            
            state.chatHistory.push({ role: 'user', parts: [{ text: text }] });
            document.getElementById('chat-subtitle').innerText = "AI è¼¸å…¥ä¸­...";

            try {
                const response = await callGemini(state.chatHistory);
                addAiBubble(response);
                state.chatHistory.push({ role: 'model', parts: [{ text: response }] });
                document.getElementById('chat-subtitle').innerText = "ä¸Šç·šä¸­";
            } catch (e) {
                addSystemBubble(e.message);
                document.getElementById('chat-subtitle').innerText = "éŒ¯èª¤";
            }
        }

        function addAiBubble(text) {
            const container = document.getElementById('chat-container');
            
            // 1. Parse JSON Correction
            let correctionHtml = '';
            let cleanText = text;
            
            // Regex to find JSON block at start
            const jsonMatch = text.match(/^\{[\s\S]*?\}/);
            if (jsonMatch) {
                try {
                    const correction = JSON.parse(jsonMatch[0]);
                    if (correction.correction) {
                        correctionHtml = `
                            <div class="mb-2 bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs">
                                <div class="font-bold text-yellow-700 flex items-center gap-1"><i class="fa-solid fa-wrench"></i> å„ªåŒ–å»ºè­°</div>
                                <div class="text-slate-700 mt-1">${correction.correction}</div>
                                <div class="text-slate-400 mt-1 italic">${correction.reason}</div>
                            </div>`;
                        cleanText = text.replace(jsonMatch[0], '').trim();
                    }
                } catch(e) {}
            }

            const div = document.createElement('div');
            div.className = 'flex justify-start mb-4';
            div.innerHTML = `
                <div class="max-w-[85%]">
                    ${correctionHtml}
                    <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-800 selectable leading-relaxed">
                        ${marked.parse(cleanText)}
                    </div>
                    <button onclick="speakText(this)" data-text="${cleanText.replace(/"/g, '&quot;')}" class="mt-1 ml-1 text-gray-400 hover:text-blue-500 text-xs flex items-center gap-1">
                        <i class="fa-solid fa-volume-high"></i> æœ—è®€
                    </button>
                </div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addUserBubble(text) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = 'flex justify-end mb-4';
            div.innerHTML = `<div class="bg-[#007AFF] text-white px-4 py-2.5 rounded-2xl rounded-tr-none shadow-md text-sm max-w-[85%] leading-relaxed">${text}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemBubble(text) {
            const c = document.getElementById('chat-container');
            c.innerHTML += `<div class="text-center text-xs text-red-400 py-2">${text}</div>`;
        }

        // --- Logic: Features ---
        function setLevel(lvl) {
            state.level = lvl;
            localStorage.setItem('v22_level', lvl);
            // Update UI
            ['Easy', 'Medium', 'Hard'].forEach(l => {
                const el = document.getElementById(`lvl-${l}`);
                if(l === lvl) el.className = "flex-1 py-2 rounded-lg bg-white shadow-sm transition-all cursor-pointer text-black";
                else el.className = "flex-1 py-2 rounded-lg text-gray-400 transition-all cursor-pointer";
            });
            renderLessons(); // Refresh lessons based on level
        }

        function getMissions() {
            const list = missionWords[state.lang] || missionWords['English'];
            // Randomly pick 3
            return list.sort(() => 0.5 - Math.random()).slice(0, 3);
        }

        // Translation Tool
        function handleTextSelection(e) {
            const t = window.getSelection().toString().trim();
            const tools = document.getElementById('word-tools');
            if (t && t.length > 0 && t.length < 50) {
                document.getElementById('sel-text').innerText = t;
                tools.style.display = 'block';
                // Positioning logic to keep it on screen
                let left = e.pageX;
                let top = e.pageY - 50;
                if(left + 150 > window.innerWidth) left = window.innerWidth - 160;
                tools.style.left = left + 'px';
                tools.style.top = top + 'px';
            } else { tools.style.display = 'none'; }
        }

        async function translateAndSave() {
            const word = document.getElementById('sel-text').innerText;
            document.getElementById('word-tools').style.display = 'none';
            
            // Call AI for translation
            try {
                const res = await callGemini([{ role: 'user', parts: [{ text: `Translate "${word}" to Traditional Chinese. Output ONLY the translation.` }] }]);
                const newItem = { w: word, t: res.trim(), l: state.lang };
                
                // Add to vocab list
                if(!state.vocabs.find(v => v.w === word)) {
                    state.vocabs.push(newItem);
                    localStorage.setItem('v22_vocabs', JSON.stringify(state.vocabs));
                    alert(`å·²æ”¶è—: ${word} (${res})`);
                }
            } catch(e) { alert("ç¿»è­¯å¤±æ•—"); }
        }

        // Speech & TTS
        function toggleSpeech() {
            if(!recognition) return alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥ (è«‹ç”¨ Chrome/Safari)");
            const btn = document.getElementById('btn-mic');
            if(isRecording) {
                recognition.stop();
                btn.className = "w-10 h-10 rounded-full text-gray-400 hover:text-red-500 hover:bg-red-50 transition-all flex items-center justify-center";
            } else {
                recognition.lang = getSpeechLang();
                recognition.start();
                btn.className = "w-10 h-10 rounded-full bg-red-500 text-white animate-pulse flex items-center justify-center";
            }
            isRecording = !isRecording;
        }

        function speakText(btn) {
            const text = btn.dataset.text;
            const u = new SpeechSynthesisUtterance(text);
            u.lang = getSpeechLang();
            window.speechSynthesis.speak(u);
        }

        function getSpeechLang() {
            if(state.lang === 'Japanese') return 'ja-JP';
            if(state.lang === 'Korean') return 'ko-KR';
            return 'en-US';
        }

        // Backup & Restore
        function backupData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", `lingoflow_backup_${new Date().toISOString().slice(0,10)}.json`);
            document.body.appendChild(dlAnchorElem);
            dlAnchorElem.click();
            dlAnchorElem.remove();
        }

        function restoreData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.apiKey) {
                        state = data;
                        localStorage.setItem('v22_key', state.apiKey);
                        localStorage.setItem('v22_vocabs', JSON.stringify(state.vocabs));
                        alert("é‚„åŸæˆåŠŸï¼æ­£åœ¨é‡æ•´...");
                        location.reload();
                    }
                } catch(err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
            };
            reader.readAsText(file);
        }

        // --- Rendering ---
        function renderScenarios() {
            const list = document.getElementById('scenario-list');
            list.innerHTML = scenarios.map(s => `
                <div onclick="startChat('${s.title}', '${s.role}')" class="ios-card p-4 flex items-center gap-4 cursor-pointer">
                    <div class="w-12 h-12 rounded-2xl ${s.color} flex items-center justify-center text-xl"><i class="fa-solid ${s.icon}"></i></div>
                    <div class="flex-1">
                        <div class="font-bold text-slate-800">${s.title}</div>
                        <div class="text-xs text-slate-400">Role: ${s.role}</div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </div>
            `).join('');
        }

        function renderLessons() {
            const currentList = curriculumData[state.lang] ? curriculumData[state.lang][state.level] : curriculumData['English']['Medium'];
            const list = document.getElementById('lesson-list');
            if(!currentList) { list.innerHTML = 'ç„¡èª²ç¨‹è³‡æ–™'; return; }
            
            list.innerHTML = currentList.map((l, i) => `
                <div onclick="startChat('Lesson: ${l}', 'Tutor')" class="ios-card p-5 mb-4 flex justify-between items-center cursor-pointer">
                    <div>
                        <div class="text-[10px] font-bold text-blue-500 uppercase mb-1">UNIT ${i+1}</div>
                        <div class="font-bold text-slate-800">${l}</div>
                    </div>
                    <i class="fa-solid fa-play text-blue-500 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center text-xs"></i>
                </div>
            `).join('');
        }

        function renderVocabs(filterLang = 'All') {
            const list = document.getElementById('vocab-display-list');
            const filtered = state.vocabs.filter(v => filterLang === 'All' || v.l === filterLang);
            
            list.innerHTML = filtered.map(v => `
                <div class="ios-card p-4 mb-2 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-slate-800">${v.w}</div>
                        <div class="text-xs text-slate-500">${v.t}</div>
                    </div>
                    <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-400">${v.l || 'En'}</span>
                </div>
            `).join('') || '<div class="text-center text-gray-400 py-10 text-sm">å°šç„¡æ”¶è—</div>';
        }

        function filterVocab(l) { renderVocabs(l); }

        function startQuiz() {
            // Filter words by current target language
            const pool = state.vocabs.filter(v => v.l === state.lang);
            if(pool.length < 1) return alert(`ç›®å‰æ²’æœ‰ ${state.lang} çš„å–®å­—å¯è€ƒ`);
            
            const q = pool[Math.floor(Math.random() * pool.length)];
            const ans = prompt(`ã€${state.lang} æ¸¬é©—ã€‘\nè«‹è¼¸å…¥ "${q.t}" çš„åŸæ–‡ï¼š`);
            if(ans && ans.trim().toLowerCase() === q.w.toLowerCase()) alert("Correct! ğŸ‰");
            else if(ans) alert(`Wrong. The answer is: ${q.w}`);
        }

        // Views
        function switchView(t) {
            document.querySelectorAll('.page-view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${t}`).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => {
                const active = b.getAttribute('onclick').includes(t);
                b.className = active ? 'nav-btn text-[#007AFF] flex flex-col items-center gap-1 transition-colors' : 'nav-btn text-gray-400 flex flex-col items-center gap-1 transition-colors';
            });
            if(t === 'vocab') renderVocabs();
        }

        function closeChat() { 
            document.getElementById('view-chat').classList.add('translate-x-full');
            // reset status bar style if needed
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value.trim();
            state.projectId = document.getElementById('project-id-input').value.trim();
            state.lang = document.getElementById('target-lang').value;
            localStorage.setItem('v22_key', state.apiKey);
            localStorage.setItem('v22_proj', state.projectId);
            localStorage.setItem('v22_lang', state.lang);
            location.reload();
        }
    </script>
</body>
</html>