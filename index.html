<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Language App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* åŸºç¤è¨­å®š */
        * { -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        .selectable { user-select: text; }
        body { background-color: #F2F2F7; font-family: -apple-system, sans-serif; overflow: hidden; color: #1c1c1e; }
        
        /* æ»¾å‹•å€åŸŸ */
        .page-view { position: absolute; inset: 0; bottom: 80px; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        
        /* å¡ç‰‡æŒ‰éˆ• */
        .app-card {
            width: 100%; display: flex; align-items: center; text-align: left;
            background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.02);
            position: relative; transition: background-color 0.1s;
        }
        .app-card:active { background-color: #e5e5ea; transform: scale(0.99); }

        /* å°è¦½åˆ— */
        .glass-nav { background: rgba(255, 255, 255, 0.98); border-top: 1px solid #e5e5ea; }
        
        /* åŠƒè©å·¥å…· */
        #word-tools { display: none; position: absolute; background: #1c1c1e; color: white; padding: 8px 16px; border-radius: 10px; z-index: 9999; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="h-[100dvh] w-screen">

    <div id="word-tools">
        <div class="flex items-center gap-3">
            <span id="sel-text" class="max-w-[120px] truncate border-r border-gray-600 pr-3"></span>
            <button onclick="translateAndSave()" class="text-blue-400 font-bold">æ”¶è—</button>
        </div>
    </div>

    <div id="view-home" class="page-view">
        <div class="flex justify-between items-center mb-6 mt-2">
            <h1 class="text-3xl font-bold tracking-tight">My Learning</h1>
            <span id="lang-badge" class="px-3 py-1 bg-gray-200 rounded-full text-xs font-bold text-gray-600">Loading...</span>
        </div>
        
        <div class="bg-gray-200/80 p-1 rounded-xl flex mb-6 text-xs font-bold text-center">
            <button onclick="setLevel('Easy')" id="lvl-Easy" class="flex-1 py-2 rounded-lg bg-white shadow-sm text-blue-600">åˆç´š</button>
            <button onclick="setLevel('Medium')" id="lvl-Medium" class="flex-1 py-2 rounded-lg text-gray-500">ä¸­ç´š</button>
            <button onclick="setLevel('Hard')" id="lvl-Hard" class="flex-1 py-2 rounded-lg text-gray-500">é«˜ç´š</button>
        </div>

        <button onclick="openChat('è‡ªç”±å°è©± (Free Talk)', 'Friend')" class="w-full text-left bg-blue-600 p-6 rounded-[24px] text-white mb-8 shadow-lg active:scale-95 transition-all relative overflow-hidden">
            <div class="relative z-10">
                <h3 class="font-bold text-xl">è‡ªç”±å°è©±</h3>
                <p class="text-blue-100 text-sm mt-1">Free Talk</p>
            </div>
            <i class="fa-solid fa-comments absolute -bottom-2 -right-2 text-7xl text-white opacity-20"></i>
        </button>

        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 ml-1">æƒ…å¢ƒé¸æ“‡</h2>
        <div id="scenario-list"></div>
    </div>

    <div id="view-learn" class="page-view hidden">
        <h1 class="text-3xl font-bold mb-6 mt-2">èª²ç¨‹åˆ—è¡¨</h1>
        <div id="lesson-list"></div>
    </div>

    <div id="view-vocab" class="page-view hidden">
        <div class="flex justify-between items-end mb-6 mt-2">
            <h1 class="text-3xl font-bold">å–®å­—æœ¬</h1>
            <button onclick="startQuiz()" class="bg-orange-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow active:scale-95">æ¸¬é©—</button>
        </div>
        <div id="vocab-list" class="space-y-2"></div>
    </div>

    <div id="view-settings" class="page-view hidden">
        <h1 class="text-3xl font-bold mb-6 mt-2">è¨­å®š</h1>
        <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">API Key</label>
                <input type="password" id="api-key" class="w-full mt-2 p-3 bg-gray-50 rounded-lg text-sm outline-none" placeholder="è²¼ä¸Šé‡‘é‘°...">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">Project ID (é¸å¡«)</label>
                <input type="text" id="proj-id" class="w-full mt-2 p-3 bg-gray-50 rounded-lg text-sm outline-none" placeholder="å°ˆæ¡ˆ ID...">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">èªè¨€</label>
                <select id="sel-lang" class="w-full mt-2 p-3 bg-gray-50 rounded-lg text-sm outline-none font-bold text-blue-600" onchange="changeLang()">
                    <option value="English">English</option>
                    <option value="Japanese">æ—¥æœ¬èª</option>
                    <option value="Korean">í•œêµ­ì–´</option>
                </select>
            </div>
        </div>
        <button onclick="saveSettings()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold mt-6 shadow-lg active:scale-95">å„²å­˜</button>
        
        <div class="mt-6 flex gap-3">
            <button onclick="backup()" class="flex-1 py-3 bg-white border border-gray-200 rounded-xl text-xs font-bold text-gray-600">ä¸‹è¼‰å‚™ä»½</button>
            <label class="flex-1 py-3 bg-white border border-gray-200 rounded-xl text-xs font-bold text-gray-600 text-center">
                é‚„åŸå‚™ä»½ <input type="file" onchange="restore(this)" class="hidden" accept=".json">
            </label>
        </div>
    </div>

    <div id="view-chat" class="fixed inset-0 bg-[#F2F2F7] z-50 hidden flex flex-col translate-x-full transition-transform duration-200">
        <div class="h-[60px] bg-white border-b flex justify-between items-center px-4 shrink-0">
            <button onclick="closeChat()" class="text-blue-600 font-bold py-2 active:opacity-50"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
            <div class="text-center">
                <h2 id="chat-title" class="font-bold text-sm">å°è©±</h2>
                <span id="chat-status" class="text-[10px] text-gray-400 block -mt-0.5">æº–å‚™ä¸­</span>
            </div>
            <div class="w-12"></div>
        </div>
        
        <div id="mission-box" class="bg-blue-50 px-4 py-2 text-xs text-blue-800 border-b border-blue-100 hidden">
            <span class="font-bold">ğŸ¯ ä»»å‹™ï¼š</span>
            <span id="mission-text"></span>
        </div>

        <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 pb-4"></div>

        <div class="bg-white border-t p-3 pb-6 flex items-end gap-2 shrink-0">
            <button onclick="toggleMic()" id="btn-mic" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center">
                <i class="fa-solid fa-microphone"></i>
            </button>
            <div class="flex-1 bg-gray-100 rounded-2xl px-4 py-2 min-h-[40px] flex items-center">
                <input type="text" id="chat-input" class="w-full bg-transparent outline-none text-base" placeholder="è¼¸å…¥..." onkeypress="if(event.key==='Enter') sendMsg()">
            </div>
            <button onclick="sendMsg()" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90">
                <i class="fa-solid fa-arrow-up"></i>
            </button>
        </div>
    </div>

    <nav class="glass-nav fixed bottom-0 w-full h-[80px] flex justify-around pt-3 z-40 text-[10px] font-medium">
        <button class="nav-btn text-blue-600 flex flex-col items-center gap-1 w-full" onclick="goTab('home')"><i class="fa-solid fa-house text-xl"></i><span>é¦–é </span></button>
        <button class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full" onclick="goTab('learn')"><i class="fa-solid fa-graduation-cap text-xl"></i><span>èª²ç¨‹</span></button>
        <button class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full" onclick="goTab('vocab')"><i class="fa-solid fa-book text-xl"></i><span>å–®å­—</span></button>
        <button class="nav-btn text-gray-400 flex flex-col items-center gap-1 w-full" onclick="goTab('settings')"><i class="fa-solid fa-gear text-xl"></i><span>è¨­å®š</span></button>
    </nav>

    <script>
        // --- 1. è³‡æ–™åº« (ä¿®æ­£å¾Œçš„ç‰©ä»¶çµæ§‹) ---
        const DB = {
            English: {
                scenarios: [
                    { t: 'Coffee Shop', r: 'Barista', i: 'fa-mug-hot' },
                    { t: 'Doctor', r: 'Doctor', i: 'fa-user-doctor' },
                    { t: 'Immigration', r: 'Officer', i: 'fa-passport' },
                    { t: 'Taxi', r: 'Driver', i: 'fa-taxi' }
                ],
                curriculum: {
                    Easy: [
                        { title: 'Survival: Toilet', desc: 'Where is the bathroom?' },
                        { title: 'Shopping: Price', desc: 'How much is this?' },
                        { title: 'Food: Ordering', desc: 'I would like a burger.' }
                    ],
                    Medium: [
                        { title: 'Problem: Return Item', desc: 'It is broken.' },
                        { title: 'Health: Symptoms', desc: 'I have a headache.' },
                        { title: 'Social: Weekend', desc: 'What did you do?' }
                    ],
                    Hard: [
                        { title: 'Biz: Negotiation', desc: 'Discussing prices.' },
                        { title: 'Social: Refusal', desc: 'Politely saying no.' },
                        { title: 'Opinion: Debate', desc: 'Expressing views.' }
                    ]
                },
                missions: ['actually', 'wonder', 'appreciate', 'consider']
            },
            Japanese: {
                scenarios: [
                    { t: 'ã‚³ãƒ³ãƒ“ãƒ‹ (è¶…å•†)', r: 'åº—å“¡', i: 'fa-store' },
                    { t: 'ç—…é™¢ (é†«é™¢)', r: 'åŒ»è€…', i: 'fa-user-doctor' },
                    { t: 'é§… (è»Šç«™)', r: 'é§…å“¡', i: 'fa-train' },
                    { t: 'å±…é…’å±‹', r: 'åº—å“¡', i: 'fa-beer-mug-empty' },
                    { t: 'ç¾å®¹é™¢', r: 'ç¾å®¹å¸«', i: 'fa-scissors' }
                ],
                curriculum: {
                    Easy: [
                        { title: 'ç”Ÿå­˜: ãƒˆã‚¤ãƒ¬ã¯ã©ã“', desc: 'å ´æ‰€ã‚’å°‹ã­ã‚‹ (Locations)' },
                        { title: 'è²·ã„ç‰©: ã„ãã‚‰ã§ã™ã‹', desc: 'å€¤æ®µã‚’èã (Prices)' },
                        { title: 'é£Ÿäº‹: æ³¨æ–‡ã™ã‚‹', desc: 'ã“ã‚Œã‚’ãã ã•ã„ (Ordering)' }
                    ],
                    Medium: [
                        { title: 'ç¾å®¹é™¢: ã‚«ãƒƒãƒˆ', desc: 'çŸ­ãã—ã¦ãã ã•ã„ (Haircut)' },
                        { title: 'ç—…é™¢: ç—‡çŠ¶', desc: 'é ­ãŒç—›ã„ã§ã™ (Symptoms)' },
                        { title: 'ãƒˆãƒ©ãƒ–ãƒ«: è½ã¨ã—ç‰©', desc: 'è²¡å¸ƒã‚’ãªãã—ã¾ã—ãŸ (Lost Item)' },
                        { title: 'N3æ–‡æ³•: è¨±å¯', desc: 'ã€œã¦ã‚‚ã„ã„ã§ã™ã‹ (Permission)' }
                    ],
                    Hard: [
                        { title: 'æ•¬èª: ãƒ¡ãƒ¼ãƒ«', desc: 'ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒ¼ãƒ« (Business Email)' },
                        { title: 'è¬ç½ª: ã‚¯ãƒ¬ãƒ¼ãƒ ', desc: 'ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ (Apology)' },
                        { title: 'ä¾é ¼: ãŠé¡˜ã„', desc: 'ã€œã¦ã„ãŸã ã‘ã¾ã›ã‚“ã‹ (Request)' }
                    ]
                },
                missions: ['ç¢ºã‹ã«', 'ä¾‹ãˆã°', 'å®Ÿã¯', 'ãªã‚‹ã»ã©']
            },
            Korean: {
                scenarios: [
                    { t: 'í¸ì˜ì  (è¶…å•†)', r: 'Clerk', i: 'fa-store' },
                    { t: 'ì‹ë‹¹ (é¤å»³)', r: 'Server', i: 'fa-utensils' },
                    { t: 'íƒì‹œ (è¨ˆç¨‹è»Š)', r: 'Driver', i: 'fa-taxi' }
                ],
                curriculum: {
                    Easy: [{ title: 'Survival: Toilet', desc: 'Location' }],
                    Medium: [{ title: 'Shopping: Bargain', desc: 'Discount' }],
                    Hard: [{ title: 'Biz: Email', desc: 'Formal' }]
                },
                missions: ['ì†”ì§íˆ', 'í˜¹ì‹œ', 'ë¬¼ë¡ ']
            }
        };

        // --- 2. å…¨åŸŸè®Šæ•¸èˆ‡åˆå§‹åŒ– ---
        let key = localStorage.getItem('k') || '';
        let proj = localStorage.getItem('p') || '';
        let lang = localStorage.getItem('l') || 'English';
        let level = localStorage.getItem('lvl') || 'Medium';
        let vocabs = JSON.parse(localStorage.getItem('v') || '[]');
        let history = [];

        window.onload = () => {
            // è¼‰å…¥ UI
            document.getElementById('api-key').value = key;
            document.getElementById('proj-id').value = proj;
            document.getElementById('sel-lang').value = lang;
            
            updateLevelBtns();
            renderAll();
            
            document.addEventListener('mouseup', handleSelect);
        };

        // --- 3. æ¸²æŸ“é‚è¼¯ ---
        function renderAll() {
            document.getElementById('lang-badge').innerText = lang;
            
            // æƒ…å¢ƒæ¸²æŸ“
            const scList = document.getElementById('scenario-list');
            scList.innerHTML = DB[lang].scenarios.map(s => `
                <button onclick="openChat('${s.t}', '${s.r}')" class="app-card">
                    <div class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center text-xl mr-4 text-blue-600"><i class="fa-solid ${s.i}"></i></div>
                    <div>
                        <div class="font-bold text-gray-800">${s.t}</div>
                        <div class="text-xs text-gray-400">Role: ${s.r}</div>
                    </div>
                    <i class="fa-solid fa-chevron-right ml-auto text-gray-300 text-xs"></i>
                </button>
            `).join('');

            // èª²ç¨‹æ¸²æŸ“ (é€™å°±æ˜¯ä¹‹å‰ undefined çš„ä¿®å¾©é—œéµ)
            const leList = document.getElementById('lesson-list');
            const lessons = DB[lang].curriculum[level] || [];
            leList.innerHTML = lessons.map((l, i) => `
                <button onclick="openChat('Lesson: ${l.title}', 'Teacher')" class="app-card flex-col items-start gap-1">
                    <div class="text-[10px] font-bold text-blue-500 uppercase">UNIT ${i+1}</div>
                    <div class="font-bold text-gray-800">${l.title}</div>
                    <div class="text-xs text-gray-400">${l.desc}</div>
                </button>
            `).join('');

            // å–®å­—æ¸²æŸ“
            renderVocab();
        }

        function renderVocab() {
            const list = document.getElementById('vocab-list');
            const data = vocabs.filter(v => v.l === lang);
            list.innerHTML = data.map(v => `
                <div class="app-card justify-between py-3">
                    <div>
                        <div class="font-bold text-sm">${v.w}</div>
                        <div class="text-xs text-gray-500">${v.t}</div>
                    </div>
                    <button onclick="delVocab('${v.w}')" class="text-red-400 px-2"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('') || '<div class="text-center text-gray-400 py-10 text-xs">ç„¡å–®å­—</div>';
        }

        // --- 4. äº’å‹•é‚è¼¯ ---
        function goTab(t) {
            ['home', 'learn', 'vocab', 'settings'].forEach(id => {
                const el = document.getElementById(`view-${id}`);
                if(id === t) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
            // æ›´æ–°æŒ‰éˆ•é¡è‰²
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if(btn.onclick.toString().includes(t)) {
                    btn.classList.add('text-blue-600');
                    btn.classList.remove('text-gray-400');
                } else {
                    btn.classList.add('text-gray-400');
                    btn.classList.remove('text-blue-600');
                }
            });
        }

        function setLevel(l) {
            level = l;
            localStorage.setItem('lvl', l);
            updateLevelBtns();
            renderAll();
        }

        function updateLevelBtns() {
            ['Easy', 'Medium', 'Hard'].forEach(l => {
                const btn = document.getElementById(`lvl-${l}`);
                if(l === level) btn.className = "flex-1 py-2 rounded-lg bg-white shadow-sm text-blue-600 font-bold ring-1 ring-blue-100";
                else btn.className = "flex-1 py-2 rounded-lg text-gray-500";
            });
        }

        function changeLang() {
            lang = document.getElementById('sel-lang').value;
            renderAll();
        }

        function saveSettings() {
            key = document.getElementById('api-key').value.trim();
            proj = document.getElementById('proj-id').value.trim();
            lang = document.getElementById('sel-lang').value;
            
            localStorage.setItem('k', key);
            localStorage.setItem('p', proj);
            localStorage.setItem('l', lang);
            alert('å„²å­˜æˆåŠŸ');
            renderAll();
        }

        // --- 5. èŠå¤©èˆ‡ API ---
        function openChat(title, role) {
            document.getElementById('view-chat').classList.remove('translate-x-full');
            document.getElementById('chat-title').innerText = title;
            document.getElementById('chat-box').innerHTML = '';
            document.getElementById('chat-status').innerText = 'é€£ç·šä¸­...';
            document.getElementById('chat-status').className = 'text-[10px] text-blue-500 block -mt-0.5 animate-pulse';

            // ä»»å‹™å–®å­—
            const ms = DB[lang].missions.slice(0, 3);
            document.getElementById('mission-box').classList.remove('hidden');
            document.getElementById('mission-text').innerText = ms.join(', ');

            // Prompt
            const lvlMap = { Easy: 'Beginner (N5)', Medium: 'Intermediate (N3)', Hard: 'Advanced (N1)' };
            const sys = `Act as ${role} in ${lang}. User is ${lvlMap[level]}. If user makes mistake, return JSON {"correction": "...", "reason": "..."}. Be concise.`;
            
            history = [{ role: 'user', parts: [{ text: sys + " Start with greeting." }] }];
            apiCall();
        }

        async function apiCall() {
            if(!key) return addBubble('sys', 'è«‹å…ˆè¨­å®š API Key');
            
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`;
                const headers = { 'Content-Type': 'application/json' };
                if(proj) headers['X-Goog-User-Project'] = proj;
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ contents: history })
                });
                
                const data = await res.json();
                if(!res.ok) throw new Error(data.error?.message || 'Error');
                
                const txt = data.candidates[0].content.parts[0].text;
                addBubble('ai', txt);
                history.push({ role: 'model', parts: [{ text: txt }] });
                
                document.getElementById('chat-status').innerText = 'ç·šä¸Š';
                document.getElementById('chat-status').className = 'text-[10px] text-green-500 block -mt-0.5';
            } catch(e) {
                addBubble('sys', 'é€£ç·šå¤±æ•—: ' + e.message);
                document.getElementById('chat-status').innerText = 'é›¢ç·š';
                document.getElementById('chat-status').className = 'text-[10px] text-red-500 block -mt-0.5';
            }
        }

        function sendMsg() {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if(!txt) return;
            addBubble('user', txt);
            input.value = '';
            history.push({ role: 'user', parts: [{ text: txt }] });
            apiCall();
        }

        function addBubble(role, txt) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            
            if(role === 'user') {
                div.className = 'flex justify-end mb-4';
                div.innerHTML = `<div class="bg-blue-600 text-white px-4 py-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[85%]">${txt}</div>`;
            } else if(role === 'sys') {
                div.className = 'text-center text-xs text-red-400 py-2';
                div.innerText = txt;
            } else {
                let showTxt = txt;
                let fix = '';
                // ç°¡æ˜“ JSON æª¢æŸ¥
                if(txt.trim().startsWith('{')) {
                    try {
                        const j = JSON.parse(txt);
                        if(j.correction) {
                            fix = `<div class="mb-2 bg-yellow-50 border border-yellow-200 p-2 rounded text-xs text-slate-700"><b>ğŸ’¡ ä¿®æ­£:</b> ${j.correction}<br>${j.reason}</div>`;
                            showTxt = '...'; // é€™è£¡ç°¡åŒ–ï¼Œå¯¦å‹™ä¸Š AI æ‡‰è©²æœƒç¹¼çºŒå›è©±
                        }
                    } catch(e) {}
                }
                div.className = 'flex justify-start mb-4';
                div.innerHTML = `<div class="max-w-[90%]">${fix}<div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-800 selectable border border-gray-100">${marked.parse(showTxt)}</div></div>`;
            }
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function closeChat() {
            document.getElementById('view-chat').classList.add('translate-x-full');
        }

        // --- 6. å·¥å…·åŠŸèƒ½ ---
        function handleSelect(e) {
            const t = window.getSelection().toString().trim();
            const el = document.getElementById('word-tools');
            if(t && t.length < 30) {
                document.getElementById('sel-text').innerText = t;
                el.style.display = 'block';
                el.style.left = (e.pageX < 50 ? 50 : e.pageX - 50) + 'px';
                el.style.top = (e.pageY - 50) + 'px';
            } else {
                el.style.display = 'none';
            }
        }

        async function translateAndSave() {
            const w = document.getElementById('sel-text').innerText;
            document.getElementById('word-tools').style.display = 'none';
            // ç°¡æ˜“æ¨¡æ“¬
            vocabs.push({ w: w, t: 'ç¿»è­¯ä¸­...', l: lang });
            localStorage.setItem('v', JSON.stringify(vocabs));
            alert('å·²æ”¶è— (è«‹è‡³å–®å­—æœ¬æŸ¥çœ‹)');
            renderVocab();
        }
        
        function delVocab(w) {
            vocabs = vocabs.filter(v => v.w !== w);
            localStorage.setItem('v', JSON.stringify(vocabs));
            renderVocab();
        }

        function startQuiz() {
            if(vocabs.length === 0) return alert('ç„¡å–®å­—');
            const q = vocabs[Math.floor(Math.random()*vocabs.length)];
            alert(`éš¨æ©Ÿå–®å­—: ${q.w}`);
        }

        function backup() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({k:key, p:proj, v:vocabs}));
            a.download = "backup.json";
            a.click();
        }
        
        function restore(input) {
            const r = new FileReader();
            r.onload = e => {
                const d = JSON.parse(e.target.result);
                if(d.k) { key=d.k; proj=d.p; vocabs=d.v; saveSettings(); }
            };
            r.readAsText(input.files[0]);
        }
        
        // èªéŸ³ stub
        function toggleMic() { alert('èªéŸ³åŠŸèƒ½éœ€ HTTPS æ”¯æ´'); }
    </script>
</body>
</html>