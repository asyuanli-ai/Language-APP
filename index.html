<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="mobile-web-app-capable" content="yes">
    <title>LingoFlow v26.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* åŸºç¤è¨­å®š */
        * { -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        .selectable { user-select: text; }
        body { background-color: #F2F2F7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; overflow: hidden; color: #1c1c1e; }
        
        /* é é¢æ»‘å‹•å€ */
        .page-view { position: absolute; inset: 0; bottom: 80px; overflow-y: auto; padding: 20px; scroll-behavior: smooth; padding-bottom: 100px; }
        
        /* å°è¦½åˆ— */
        .glass-nav { background: rgba(255, 255, 255, 0.96); border-top: 1px solid rgba(0,0,0,0.05); }
        
        /* å¡ç‰‡æŒ‰éˆ•æ¨£å¼ (Android é¢¨æ ¼å„ªåŒ–) */
        .app-card {
            width: 100%; display: flex; align-items: center; text-align: left;
            background: white; border-radius: 16px; padding: 16px; margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.02);
            position: relative; transition: background-color 0.1s;
        }
        .app-card:active { background-color: #e0e0e0; transform: scale(0.99); }

        /* åŠƒè©å·¥å…· */
        #word-tools { display: none; position: absolute; background: #222; color: white; padding: 8px 14px; border-radius: 8px; z-index: 9999; font-size: 14px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: auto; }
    </style>
    
    <script>
        window.onerror = function(msg, url, line) {
            alert("ç¨‹å¼ç™¼ç”ŸéŒ¯èª¤:\n" + msg + "\nè¡Œæ•¸: " + line);
            return false;
        };
    </script>
</head>
<body class="h-[100dvh] w-screen">

    <div id="word-tools">
        <div class="flex items-center gap-3">
            <span id="sel-text" class="max-w-[120px] truncate opacity-90 border-r border-gray-500 pr-3 font-medium"></span>
            <button id="btn-translate" class="text-blue-300 font-bold whitespace-nowrap">ç¿»è­¯æ”¶è—</button>
        </div>
    </div>

    <div id="app-root" class="h-full relative">

        <div id="view-home" class="page-view">
            <div class="flex justify-between items-center mb-4 mt-2">
                <h1 class="text-2xl font-bold tracking-tight text-slate-800">LingoFlow</h1>
                <span id="current-lang-badge" class="px-3 py-1 bg-gray-200 rounded-full text-xs font-bold text-gray-600">Loading...</span>
            </div>
            
            <div class="bg-gray-200/80 p-1 rounded-xl flex mb-6 text-xs font-bold text-center">
                <button class="level-btn flex-1 py-2 rounded-lg transition-all" data-lvl="Easy" id="lvl-Easy">åˆç´š</button>
                <button class="level-btn flex-1 py-2 rounded-lg transition-all" data-lvl="Medium" id="lvl-Medium">ä¸­ç´š</button>
                <button class="level-btn flex-1 py-2 rounded-lg transition-all" data-lvl="Hard" id="lvl-Hard">é«˜ç´š</button>
            </div>

            <button class="chat-trigger w-full text-left bg-blue-600 p-6 rounded-[24px] text-white mb-8 shadow-lg active:scale-95 transition-all relative overflow-hidden" 
                data-title="Free Talk" data-role="Friend">
                <div class="relative z-10">
                    <h3 class="font-bold text-xl">è‡ªç”±å°è©± (Free Talk)</h3>
                    <p class="text-blue-100 text-sm mt-1 opacity-90">ä¸é™ä¸»é¡Œ â€¢ éš¨æ„ç·´ç¿’</p>
                </div>
                <i class="fa-solid fa-comments absolute -bottom-3 -right-3 text-7xl text-white opacity-20"></i>
            </button>

            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 ml-1">æƒ…å¢ƒé¸æ“‡</h2>
            <div id="scenario-list"></div>
        </div>

        <div id="view-learn" class="page-view hidden">
            <h1 class="text-2xl font-bold mb-6 mt-2 tracking-tight text-slate-800">å­¸ç¿’èª²ç¨‹</h1>
            <div id="lesson-list"></div>
        </div>

        <div id="view-vocab" class="page-view hidden">
            <div class="flex justify-between items-end mb-6 mt-2">
                <h1 class="text-2xl font-bold tracking-tight text-slate-800">å–®å­—æœ¬</h1>
                <button id="btn-quiz" class="bg-orange-500 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow active:scale-95">æ¸¬é©—</button>
            </div>
            <div id="vocab-display-list"></div>
        </div>

        <div id="view-settings" class="page-view hidden">
            <h1 class="text-2xl font-bold mb-6 mt-2 tracking-tight text-slate-800">è¨­å®š</h1>
            <div class="bg-white rounded-2xl overflow-hidden shadow-sm mb-6 border border-gray-100 p-4 space-y-4">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">API Key</label>
                    <input type="password" id="api-key-input" class="w-full mt-2 p-3 bg-gray-50 rounded-lg text-sm outline-none" placeholder="AIza...">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Project ID</label>
                    <input type="text" id="project-id-input" class="w-full mt-2 p-3 bg-gray-50 rounded-lg text-sm outline-none" placeholder="language-app-xxx">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">ç·´ç¿’èªè¨€</label>
                    <select id="target-lang" class="w-full mt-2 p-3 bg-gray-50 rounded-lg text-sm outline-none font-bold text-blue-600">
                        <option value="English">English</option>
                        <option value="Japanese">æ—¥æœ¬èª</option>
                        <option value="Korean">í•œêµ­ì–´</option>
                    </select>
                </div>
            </div>
            
            <button id="btn-save-settings" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg active:bg-blue-700 text-sm">å„²å­˜è¨­å®š</button>
            
            <div class="mt-6 flex gap-3">
                <button id="btn-backup" class="flex-1 py-3 bg-white border border-gray-200 rounded-xl text-xs font-bold text-gray-600">ä¸‹è¼‰å‚™ä»½</button>
                <label class="flex-1 py-3 bg-white border border-gray-200 rounded-xl text-xs font-bold text-gray-600 text-center block">
                    é‚„åŸå‚™ä»½
                    <input type="file" id="file-restore" class="hidden" accept=".json">
                </label>
            </div>
        </div>

        <div id="view-chat" class="fixed inset-0 bg-[#F2F2F7] z-50 hidden flex flex-col translate-x-full transition-transform duration-200">
            <div class="h-[60px] bg-white border-b flex justify-between items-center px-4 shrink-0">
                <button id="btn-close-chat" class="text-blue-600 font-bold px-2 py-4 active:opacity-50"><i class="fa-solid fa-chevron-left"></i> è¿”å›</button>
                <div class="text-center">
                    <h2 id="chat-title" class="font-bold text-base text-slate-800">å°è©±</h2>
                    <span id="chat-status" class="text-[10px] text-gray-400 block -mt-1">æº–å‚™ä¸­</span>
                </div>
                <div class="w-16"></div>
            </div>
            
            <div id="mission-bar" class="bg-blue-50 px-4 py-2 text-xs text-blue-800 border-b border-blue-100 hidden">
                <span class="font-bold">ğŸ¯ ä»»å‹™å–®å­—ï¼š</span>
                <span id="mission-words" class="font-mono ml-1"></span>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 pb-4"></div>

            <div class="bg-white border-t p-3 pb-6 flex items-end gap-2 shrink-0">
                <button id="btn-mic" class="w-10 h-10 rounded-full text-gray-500 bg-gray-100 flex items-center justify-center active:bg-gray-200">
                    <i class="fa-solid fa-microphone"></i>
                </button>
                <div class="flex-1 bg-gray-100 rounded-2xl px-4 py-2 min-h-[40px] flex items-center">
                    <input type="text" id="msg-input" class="w-full bg-transparent outline-none text-base text-slate-800" placeholder="è¼¸å…¥è¨Šæ¯...">
                </div>
                <button id="btn-send" class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <nav class="glass-nav fixed bottom-0 w-full h-[80px] flex justify-around pt-3 z-40 text-[10px] font-medium">
        <button class="nav-btn w-full flex flex-col items-center gap-1 text-blue-600" data-target="home"><i class="fa-solid fa-house text-xl"></i><span>é¦–é </span></button>
        <button class="nav-btn w-full flex flex-col items-center gap-1 text-gray-400" data-target="learn"><i class="fa-solid fa-graduation-cap text-xl"></i><span>èª²ç¨‹</span></button>
        <button class="nav-btn w-full flex flex-col items-center gap-1 text-gray-400" data-target="vocab"><i class="fa-solid fa-book text-xl"></i><span>å–®å­—</span></button>
        <button class="nav-btn w-full flex flex-col items-center gap-1 text-gray-400" data-target="settings"><i class="fa-solid fa-gear text-xl"></i><span>è¨­å®š</span></button>
    </nav>

    <script>
        // --- 1. è³‡æ–™åº« (ä¿®æ­£æ—¥æ–‡æ¨™ç¤º) ---
        const DB = {
            English: {
                scenarios: [
                    { t: 'Coffee Shop', r: 'Barista', i: 'fa-mug-hot' },
                    { t: 'Check-in', r: 'Receptionist', i: 'fa-bell' },
                    { t: 'Doctor', r: 'Doctor', i: 'fa-user-doctor' },
                    { t: 'Supermarket', r: 'Cashier', i: 'fa-cart-shopping' },
                    { t: 'Taxi', r: 'Driver', i: 'fa-taxi' }
                ],
                curriculum: {
                    Easy: ['Basic Greetings', 'Numbers & Prices', 'Ordering Food', 'My Family'],
                    Medium: ['Asking Directions', 'Seeing a Doctor', 'Shopping Return', 'Travel Plans'],
                    Hard: ['Business Email', 'Job Interview', 'Complaining politely', 'News Discussion']
                },
                missions: ['definitely', 'wonder', 'actually', 'appreciate', 'basically']
            },
            Japanese: {
                scenarios: [
                    { t: 'ã‚«ãƒ•ã‚§ (Cafe)', r: 'åº—å“¡', i: 'fa-mug-hot' },
                    { t: 'ã‚³ãƒ³ãƒ“ãƒ‹ (Combini)', r: 'åº—å“¡', i: 'fa-store' },
                    { t: 'ç—…é™¢ (Hospital)', r: 'åŒ»è€…', i: 'fa-user-doctor' },
                    { t: 'é§… (Station)', r: 'é§…å“¡', i: 'fa-train' },
                    { t: 'å±…é…’å±‹ (Izakaya)', r: 'åº—å“¡', i: 'fa-beer-mug-empty' },
                    { t: 'è­¦å¯Ÿç½² (Police)', r: 'è­¦å¯Ÿå®˜', i: 'fa-shield-halved' }
                ],
                curriculum: {
                    Easy: ['è‡ªå·±ç´¹ä»‹ (Intro)', 'ã„ãã‚‰ã§ã™ã‹ (Prices)', 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ (Location)', 'ã“ã‚Œã‚’ãã ã•ã„ (Order)'],
                    Medium: ['ç¾å®¹é™¢ã§é ¼ã‚€ (Cut)', 'é ­ãŒç—›ã„ã§ã™ (Sick)', 'é“ã‚’å°‹ã­ã‚‹ (Way)', 'äºˆå®šã®å¤‰æ›´ (Plans)'],
                    Hard: ['æ•¬èªã®ä½¿ã„æ–¹ (Keigo)', 'é¢æ¥ã®ç·´ç¿’ (Interview)', 'ã‚¯ãƒ¬ãƒ¼ãƒ å¯¾å¿œ (Claim)', 'ä¼šè­°ã®ç™ºè¨€ (Meeting)']
                },
                missions: ['ç¢ºã‹ã« (Tashikani)', 'ä¾‹ãˆã° (Tatoeba)', 'å®Ÿã¯ (Jitsuwa)', 'ãªã‚‹ã»ã© (Naruhodo)']
            },
            Korean: {
                scenarios: [
                    { t: 'ì¹´í˜ (Cafe)', r: 'Barista', i: 'fa-mug-hot' },
                    { t: 'í¸ì˜ì  (Store)', r: 'Clerk', i: 'fa-store' },
                    { t: 'ì‹ë‹¹ (Restaurant)', r: 'Server', i: 'fa-utensils' }
                ],
                curriculum: {
                    Easy: ['Greetings', 'Numbers', 'Ordering'],
                    Medium: ['Shopping', 'Directions', 'Travel'],
                    Hard: ['Business', 'Interview', 'Debate']
                },
                missions: ['ì†”ì§íˆ', 'ì§„ì§œ', 'í˜¹ì‹œ', 'ë¬¼ë¡ ']
            }
        };

        // --- 2. ç‹€æ…‹ç®¡ç† ---
        let state = {
            key: localStorage.getItem('v26_key') || '',
            proj: localStorage.getItem('v26_proj') || '',
            lang: localStorage.getItem('v26_lang') || 'English',
            level: localStorage.getItem('v26_level') || 'Medium',
            vocabs: JSON.parse(localStorage.getItem('v26_vocabs') || '[]'),
            history: []
        };

        // --- 3. DOM å…ƒç´ å¿«å– ---
        const els = {
            home: document.getElementById('view-home'),
            learn: document.getElementById('view-learn'),
            vocab: document.getElementById('view-vocab'),
            settings: document.getElementById('view-settings'),
            chat: document.getElementById('view-chat'),
            chatTitle: document.getElementById('chat-title'),
            chatStatus: document.getElementById('chat-status'),
            chatContainer: document.getElementById('chat-container'),
            msgInput: document.getElementById('msg-input')
        };

        // --- 4. åˆå§‹åŒ–èˆ‡äº‹ä»¶ç¶å®š (é—œéµä¿®æ­£ï¼šå…¨åŸŸç›£è½) ---
        window.addEventListener('DOMContentLoaded', () => {
            // è¼‰å…¥è¨­å®šå€¼
            document.getElementById('api-key-input').value = state.key;
            document.getElementById('project-id-input').value = state.proj;
            document.getElementById('target-lang').value = state.lang;
            
            // åˆå§‹åŒ–æ¸²æŸ“
            renderUI();

            // å…¨åŸŸé»æ“Šç›£è½ (Event Delegation) - è§£æ±ºå‹•æ…‹å…ƒç´ é»æ“Šç„¡æ•ˆ
            document.addEventListener('click', (e) => {
                // 1. èŠå¤©è§¸ç™¼ (Free talk, Scenarios, Lessons)
                const chatBtn = e.target.closest('.chat-trigger');
                if (chatBtn) {
                    const title = chatBtn.dataset.title;
                    const role = chatBtn.dataset.role;
                    openChat(title, role);
                    return;
                }

                // 2. å°è¦½åˆ—åˆ‡æ›
                const navBtn = e.target.closest('.nav-btn');
                if (navBtn) {
                    switchTab(navBtn.dataset.target);
                    return;
                }

                // 3. ç­‰ç´šåˆ‡æ›
                const lvlBtn = e.target.closest('.level-btn');
                if (lvlBtn) {
                    setLevel(lvlBtn.dataset.lvl);
                    return;
                }
            });

            // è¨­å®šé é¢æŒ‰éˆ•
            document.getElementById('target-lang').addEventListener('change', (e) => {
                state.lang = e.target.value;
                renderUI();
            });

            document.getElementById('btn-save-settings').addEventListener('click', () => {
                state.key = document.getElementById('api-key-input').value.trim();
                state.proj = document.getElementById('project-id-input').value.trim();
                state.lang = document.getElementById('target-lang').value;
                localStorage.setItem('v26_key', state.key);
                localStorage.setItem('v26_proj', state.proj);
                localStorage.setItem('v26_lang', state.lang);
                localStorage.setItem('v26_level', state.level);
                alert('è¨­å®šå·²å„²å­˜');
                renderUI();
            });

            // èŠå¤©ç›¸é—œ
            document.getElementById('btn-close-chat').addEventListener('click', () => {
                els.chat.classList.add('translate-x-full');
            });

            document.getElementById('btn-send').addEventListener('click', sendUserMessage);
            
            // åŠƒè©å·¥å…·
            document.addEventListener('mouseup', handleSelection);
            document.getElementById('btn-translate').addEventListener('click', translateAndSave);

            // å–®å­—æœ¬
            document.getElementById('btn-quiz').addEventListener('click', startQuiz);
            
            // å‚™ä»½é‚„åŸ
            document.getElementById('btn-backup').addEventListener('click', backupData);
            document.getElementById('file-restore').addEventListener('change', restoreData);
        });

        // --- 5. æ¸²æŸ“é‚è¼¯ ---
        function renderUI() {
            document.getElementById('current-lang-badge').innerText = state.lang;
            
            // æ¸²æŸ“æƒ…å¢ƒ
            const scenarios = DB[state.lang].scenarios || [];
            document.getElementById('scenario-list').innerHTML = scenarios.map(s => `
                <button class="chat-trigger app-card" data-title="${s.t}" data-role="${s.r}">
                    <div class="w-10 h-10 rounded-xl bg-gray-50 flex items-center justify-center text-xl mr-4 text-blue-600"><i class="fa-solid ${s.i}"></i></div>
                    <div class="flex-1">
                        <div class="font-bold text-slate-800 text-base">${s.t}</div>
                        <div class="text-xs text-slate-400">Role: ${s.r}</div>
                    </div>
                    <i class="fa-solid fa-chevron-right text-gray-300 text-xs"></i>
                </button>
            `).join('');

            // æ¸²æŸ“èª²ç¨‹
            updateLevelBtns();
            const lessons = DB[state.lang].curriculum[state.level] || [];
            document.getElementById('lesson-list').innerHTML = lessons.map((l, i) => `
                <button class="chat-trigger app-card" data-title="Lesson: ${l.t}" data-role="Teacher">
                    <div class="w-full">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-bold text-blue-500 uppercase tracking-wider">UNIT ${i+1}</span>
                            <i class="fa-solid fa-circle-play text-blue-500 text-xl opacity-80"></i>
                        </div>
                        <div class="font-bold text-slate-800 text-base">${l.t}</div>
                        <div class="text-xs text-slate-400 mt-0.5">${l.d}</div>
                    </div>
                </button>
            `).join('');

            // æ¸²æŸ“å–®å­—
            renderVocabs();
        }

        function setLevel(lvl) {
            state.level = lvl;
            localStorage.setItem('v26_level', lvl);
            updateLevelBtns();
            renderUI(); // é‡ç¹ªèª²ç¨‹åˆ—è¡¨
        }

        function updateLevelBtns() {
            ['Easy', 'Medium', 'Hard'].forEach(l => {
                const el = document.getElementById(`lvl-${l}`);
                if (l === state.level) {
                    el.className = "level-btn flex-1 py-2 rounded-lg bg-white shadow-sm text-blue-600 font-bold ring-1 ring-blue-100";
                } else {
                    el.className = "level-btn flex-1 py-2 rounded-lg text-gray-500 hover:bg-gray-100";
                }
            });
        }

        function switchTab(target) {
            ['home', 'learn', 'vocab', 'settings'].forEach(t => {
                const view = document.getElementById(`view-${t}`);
                if (t === target) view.classList.remove('hidden');
                else view.classList.add('hidden');
            });
            
            // æ›´æ–°åº•éƒ¨æŒ‰éˆ•é¡è‰²
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.target === target) {
                    btn.classList.remove('text-gray-400');
                    btn.classList.add('text-blue-600');
                } else {
                    btn.classList.add('text-gray-400');
                    btn.classList.remove('text-blue-600');
                }
            });
        }

        // --- 6. èŠå¤©æ ¸å¿ƒ (ä¿®å¾©é‡é») ---
        function openChat(title, role) {
            // UI
            els.chat.classList.remove('translate-x-full');
            els.chatTitle.innerText = title;
            els.chatContainer.innerHTML = '';
            els.chatStatus.innerText = "é€£ç·šä¸­...";
            els.chatStatus.className = "text-[10px] text-blue-500 block -mt-1 animate-pulse";
            
            // ä»»å‹™å–®å­—
            const missionList = DB[state.lang].missions.sort(() => 0.5 - Math.random()).slice(0, 3);
            document.getElementById('mission-bar').classList.remove('hidden');
            document.getElementById('mission-words').innerText = missionList.join('ã€');

            // ç³»çµ±æç¤º
            const levelMap = { 'Easy': 'Beginner (N5/A1)', 'Medium': 'Intermediate (N3/B1)', 'Hard': 'Advanced (N1/C1)' };
            const sysPrompt = `Act as a ${role} speaking ${state.lang}. User level: ${levelMap[state.level]}. 
            If user mistakes, JSON format: {"correction": "...", "reason": "..."} first. 
            Use these words if possible: ${missionList.join(', ')}.`;

            state.history = [{ role: 'user', parts: [{ text: sysPrompt + " Start with a short greeting." }] }];
            
            // å‘¼å« API
            apiTurn();
        }

        async function apiTurn() {
            try {
                const text = await callGemini(state.history);
                addBubble('ai', text);
                state.history.push({ role: 'model', parts: [{ text: text }] });
                els.chatStatus.innerText = "ç·šä¸Š";
                els.chatStatus.className = "text-[10px] text-green-500 block -mt-1";
            } catch (e) {
                addBubble('sys', `é€£ç·šéŒ¯èª¤: ${e.message}`);
                els.chatStatus.innerText = "é›¢ç·š";
                els.chatStatus.className = "text-[10px] text-red-500 block -mt-1";
            }
        }

        async function callGemini(contents) {
            if (!state.key) throw new Error("è«‹è‡³è¨­å®šå¡«å¯« Key");
            const urls = [
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${state.key}`,
                `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${state.key}`
            ];
            const headers = { 'Content-Type': 'application/json' };
            if (state.proj) headers['X-Goog-User-Project'] = state.proj;

            for (let url of urls) {
                try {
                    const res = await fetch(url, { method: 'POST', headers, body: JSON.stringify({ contents }) });
                    const data = await res.json();
                    if (res.ok) return data.candidates[0].content.parts[0].text;
                } catch (e) {}
            }
            throw new Error("ç„¡æ³•é€£ç·š Google API");
        }

        function sendUserMessage() {
            const text = els.msgInput.value.trim();
            if (!text) return;
            addBubble('user', text);
            els.msgInput.value = '';
            state.history.push({ role: 'user', parts: [{ text: text }] });
            
            els.chatStatus.innerText = "è¼¸å…¥ä¸­...";
            els.chatStatus.className = "text-[10px] text-blue-500 block -mt-1";
            apiTurn();
        }

        function addBubble(role, text) {
            const div = document.createElement('div');
            if (role === 'user') {
                div.className = 'flex justify-end mb-4 animate-fade-in';
                div.innerHTML = `<div class="bg-blue-600 text-white px-4 py-3 rounded-2xl rounded-tr-none shadow-sm text-sm max-w-[85%] leading-relaxed">${text}</div>`;
            } else if (role === 'sys') {
                div.innerHTML = `<div class="text-center text-xs text-red-400 py-2 bg-red-50 rounded-lg mx-8">${text}</div>`;
            } else {
                let cleanText = text;
                let correctionHtml = '';
                const jsonMatch = text.match(/^\{[\s\S]*?\}/);
                if (jsonMatch) {
                    try {
                        const c = JSON.parse(jsonMatch[0]);
                        if(c.correction) {
                            correctionHtml = `<div class="mb-2 bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-xs"><div class="font-bold text-yellow-700">ğŸ’¡ å»ºè­°ä¿®æ­£</div><div class="text-slate-800 mt-1">${c.correction}</div></div>`;
                            cleanText = text.replace(jsonMatch[0], '').trim();
                        }
                    } catch(e) {}
                }
                div.className = 'flex justify-start mb-4 animate-fade-in';
                div.innerHTML = `<div class="max-w-[90%]">${correctionHtml}<div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm text-sm text-slate-800 selectable border border-gray-100">${marked.parse(cleanText)}</div></div>`;
            }
            els.chatContainer.appendChild(div);
            els.chatContainer.scrollTop = els.chatContainer.scrollHeight;
        }

        // --- 7. å–®å­—åŠŸèƒ½ ---
        function handleSelection(e) {
            const t = window.getSelection().toString().trim();
            const tools = document.getElementById('word-tools');
            if (t && t.length < 50) {
                document.getElementById('sel-text').innerText = t;
                tools.style.display = 'block';
                tools.style.left = Math.min(e.pageX, window.innerWidth - 150) + 'px';
                tools.style.top = (e.pageY - 50) + 'px';
            } else { tools.style.display = 'none'; }
        }

        async function translateAndSave() {
            const w = document.getElementById('sel-text').innerText;
            document.getElementById('word-tools').style.display = 'none';
            try {
                const res = await callGemini([{ role: 'user', parts: [{ text: `Translate "${w}" to Traditional Chinese. Just the word.` }] }]);
                state.vocabs.push({ w: w, t: res.trim(), l: state.lang });
                localStorage.setItem('v26_vocabs', JSON.stringify(state.vocabs));
                alert(`å·²æ”¶è—: ${w}`);
                renderVocabs();
            } catch(e) { alert('ç¿»è­¯å¤±æ•—'); }
        }

        function renderVocabs() {
            const list = document.getElementById('vocab-display-list');
            const data = state.vocabs.filter(v => v.l === state.lang);
            list.innerHTML = data.map(v => `
                <div class="app-card justify-between">
                    <div>
                        <div class="font-bold text-slate-800">${v.w}</div>
                        <div class="text-xs text-slate-500">${v.t}</div>
                    </div>
                    <button onclick="delVocab('${v.w}')" class="text-red-400 px-2 py-1"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('') || '<div class="text-center text-gray-400 py-10 text-xs">å°šç„¡æ”¶è—</div>';
        }

        // ç‚ºäº†è®“ innerHTML ä¸­çš„ onclick èƒ½é‹ä½œï¼Œé€™è£¡éœ€è¦å…¨åŸŸæš´éœ²åˆªé™¤å‡½å¼
        window.delVocab = (w) => {
            state.vocabs = state.vocabs.filter(v => v.w !== w);
            localStorage.setItem('v26_vocabs', JSON.stringify(state.vocabs));
            renderVocabs();
        };

        function startQuiz() {
            const pool = state.vocabs.filter(v => v.l === state.lang);
            if(pool.length===0) return alert("ç„¡å–®å­—");
            const q = pool[Math.floor(Math.random()*pool.length)];
            const a = prompt(`æ¸¬é©—: ${q.t}`);
            if(a && a.toLowerCase()===q.w.toLowerCase()) alert("æ­£ç¢º!"); else alert(`éŒ¯èª¤, æ˜¯ ${q.w}`);
        }

        // --- 8. å‚™ä»½ ---
        function backupData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
            a.download = "lingoflow_backup.json";
            a.click();
        }
        function restoreData(e) {
            const r = new FileReader();
            r.onload = ev => { state = JSON.parse(ev.target.result); alert('é‚„åŸæˆåŠŸ'); location.reload(); };
            r.readAsText(e.target.files[0]);
        }
        
        // èªéŸ³è¼¸å…¥ (ç°¡æ˜“ç‰ˆ)
        const micBtn = document.getElementById('btn-mic');
        if ('webkitSpeechRecognition' in window) {
            const r = new webkitSpeechRecognition();
            r.continuous = false;
            r.onresult = e => els.msgInput.value = e.results[0][0].transcript;
            r.onstart = () => micBtn.classList.add('text-red-500', 'animate-pulse');
            r.onend = () => micBtn.classList.remove('text-red-500', 'animate-pulse');
            window.toggleSpeech = () => r.start();
        } else {
            window.toggleSpeech = () => alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³");
        }
    </script>
</body>
</html>