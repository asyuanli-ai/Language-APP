<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>My Learning 5.0 (Fixed)</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F2F2F7">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: { bg: '#F2F2F7', card: '#FFFFFF', blue: '#007AFF', green: '#34C759', yellow: '#FFCC00', red: '#FF3B30', gray: '#8E8E93' }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* iOS Layout Fixes */
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            background-color: #F2F2F7;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .view-section {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 100px;
        }
        .view-section.active { display: flex; animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 10px; font-size: 16px; line-height: 1.5; word-wrap: break-word; }
        .chat-user { background-color: #007AFF; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .chat-ai { background-color: #E5E5EA; color: black; align-self: flex-start; border-bottom-left-radius: 4px; }
        
        .correction-box { background-color: #FFF9C4; border-left: 4px solid #FBC02D; padding: 8px; margin-bottom: 8px; border-radius: 8px; font-size: 14px; align-self: flex-start; max-width: 85%; }
    </style>
</head>
<body class="text-gray-900">

    <div id="app" class="w-full h-full flex flex-col relative">

        <header class="px-4 py-3 bg-white/90 backdrop-blur-md border-b border-gray-200 z-10 flex justify-between items-center pt-safe-top">
            <h1 class="text-xl font-bold tracking-tight">My Learning</h1>
            <div id="header-status" class="text-[10px] font-mono text-gray-400">Ready</div>
        </header>

        <main class="flex-1 relative overflow-hidden flex flex-col">
            
            <div id="view-home" class="view-section active p-4">
                <div class="bg-gray-200/50 p-1 rounded-xl flex mb-6">
                    <button onclick="setLang('en')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all lang-btn" data-lang="en">English</button>
                    <button onclick="setLang('jp')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all lang-btn" data-lang="jp">æ—¥æœ¬èª</button>
                    <button onclick="setLang('kr')" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all lang-btn" data-lang="kr">í•œêµ­ì–´</button>
                </div>

                <div class="mb-6">
                    <button onclick="startFreeTalk()" class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-5 rounded-2xl shadow-lg shadow-blue-200 flex items-center justify-between active:scale-95 transition-transform">
                        <div class="flex items-center gap-4">
                            <div class="bg-white/20 h-12 w-12 rounded-full flex items-center justify-center text-xl"><i class="fa-solid fa-comments"></i></div>
                            <div class="text-left">
                                <div class="font-bold text-lg">Free Chat (è‡ªç”±å°è©±)</div>
                                <div class="text-xs opacity-90">é»æ“Šç›´æ¥é–‹å§‹</div>
                            </div>
                        </div>
                        <i class="fa-solid fa-chevron-right opacity-60"></i>
                    </button>
                </div>

                <div class="mb-6">
                    <h2 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-wider ml-1">ç›®å‰ç­‰ç´š</h2>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="setLevel('beginner')" class="level-btn bg-white p-3 rounded-xl border border-transparent shadow-sm flex flex-col items-center gap-1 transition-all active:scale-95">
                            <i class="fa-solid fa-seedling text-ios-green mb-1"></i><span class="text-xs font-bold" id="lbl-beg">åˆç´š</span>
                        </button>
                        <button onclick="setLevel('intermediate')" class="level-btn bg-white p-3 rounded-xl border border-transparent shadow-sm flex flex-col items-center gap-1 transition-all active:scale-95">
                            <i class="fa-solid fa-layer-group text-ios-blue mb-1"></i><span class="text-xs font-bold" id="lbl-int">ä¸­ç´š</span>
                        </button>
                        <button onclick="setLevel('advanced')" class="level-btn bg-white p-3 rounded-xl border border-transparent shadow-sm flex flex-col items-center gap-1 transition-all active:scale-95">
                            <i class="fa-solid fa-briefcase text-purple-600 mb-1"></i><span class="text-xs font-bold" id="lbl-adv">é«˜ç´š</span>
                        </button>
                    </div>
                </div>

                <div>
                    <h2 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider ml-1">æƒ…å¢ƒé¸æ“‡ (é»æ“Šç›´æ¥é–‹å§‹)</h2>
                    <div id="scenario-list" class="grid grid-cols-1 gap-3"></div>
                </div>
            </div>

            <div id="view-learn" class="view-section p-4">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-2xl font-bold">ä¸»é¡Œèª²ç¨‹</h2>
                    <span id="course-level-badge" class="px-2 py-1 bg-ios-blue text-white text-[10px] rounded-md font-bold">A1</span>
                </div>
                <div id="course-list" class="space-y-4"></div>
            </div>

            <div id="view-chat" class="view-section relative bg-gray-100 !pb-0 !flex-col !h-full !overflow-hidden">
                <div class="bg-yellow-50 border-b border-yellow-200 px-4 py-2 flex justify-between items-center shadow-sm z-20 shrink-0">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-bullseye text-yellow-600"></i>
                        <span class="text-xs font-bold text-yellow-800">ä»»å‹™ï¼š</span>
                    </div>
                    <div id="mission-words" class="flex gap-2 text-xs font-mono text-yellow-900 font-bold"></div>
                </div>

                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 w-full">
                    <div class="text-center text-gray-400 text-xs mt-4">AI æ­£åœ¨é€£ç·šä¸­...</div>
                </div>

                <div class="bg-white border-t border-gray-200 p-3 pb-safe-bottom w-full shrink-0 z-30 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                    <div id="typing-indicator" class="hidden text-[10px] text-gray-400 mb-2 pl-2 flex items-center gap-1">
                        <span class="animate-pulse">â—</span> AI æ­£åœ¨è¼¸å…¥...
                    </div>
                    <div class="flex items-end gap-2">
                        <button id="mic-btn" class="h-10 w-10 shrink-0 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center active:bg-red-100 active:text-red-500 transition-colors">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                        <div class="flex-1 bg-gray-100 rounded-2xl flex items-center px-3 py-1">
                            <textarea id="chat-input" rows="1" class="w-full bg-transparent border-none focus:ring-0 px-0 py-2 text-base resize-none max-h-24" placeholder="è¼¸å…¥è¨Šæ¯..."></textarea>
                        </div>
                        <button onclick="sendMessage()" class="h-10 w-10 shrink-0 rounded-full bg-ios-blue text-white shadow-md flex items-center justify-center active:scale-95 transition-transform">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="view-vocab" class="view-section p-4">
                <h2 class="text-2xl font-bold mb-4">å–®å­—æœ¬</h2>
                <div id="vocab-list" class="space-y-3"></div>
            </div>

            <div id="view-settings" class="view-section p-4">
                <div class="bg-white rounded-xl p-5 shadow-sm space-y-4">
                    <h3 class="font-bold border-b pb-2">API é€£ç·šè¨­å®š (å¿…å¡«)</h3>
                    <div class="bg-blue-50 p-3 rounded text-xs text-blue-700 font-bold border border-blue-100">
                        <i class="fa-solid fa-check-circle mr-1"></i>
                        å·²å•Ÿç”¨ Project ID é©—è­‰æ¨¡å¼
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">API KEY</label>
                        <input type="password" id="api-key-input" class="w-full bg-gray-100 p-3 rounded mt-1 font-mono text-sm focus:ring-2 focus:ring-ios-blue outline-none" placeholder="AIzaSy...">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">PROJECT ID (å¿…å¡«)</label>
                        <input type="text" id="project-id-input" class="w-full bg-gray-100 p-3 rounded mt-1 font-mono text-sm focus:ring-2 focus:ring-ios-blue outline-none" placeholder="ä¾‹å¦‚: language-app-123456">
                        <p class="text-[10px] text-gray-400 mt-1">è«‹å¡«å¯« Google Cloud Console ä¸Šçš„ Project IDï¼Œéç´”æ•¸å­—ã€‚</p>
                    </div>
                    <button onclick="saveSettings()" class="w-full bg-ios-blue text-white py-3 rounded-lg font-bold shadow-md active:opacity-90">å„²å­˜è¨­å®š</button>
                    <button onclick="clearCache()" class="w-full bg-gray-200 text-gray-600 py-2 rounded-lg font-bold text-sm">æ¸…é™¤æ¨¡å‹å¿«å–</button>
                </div>
            </div>
        </main>

        <nav class="h-[80px] bg-white border-t border-gray-200 flex justify-around items-start pt-2 z-50 shrink-0 pb-safe-bottom">
            <button onclick="switchTab('home')" class="nav-btn active-nav flex flex-col items-center w-16 gap-1" data-target="home">
                <i class="fa-solid fa-house text-xl mb-0.5"></i><span class="text-[10px]">é¦–é </span>
            </button>
            <button onclick="switchTab('learn')" class="nav-btn flex flex-col items-center w-16 gap-1 text-gray-400" data-target="learn">
                <i class="fa-solid fa-graduation-cap text-xl mb-0.5"></i><span class="text-[10px]">èª²ç¨‹</span>
            </button>
            <button onclick="switchTab('vocab')" class="nav-btn flex flex-col items-center w-16 gap-1 text-gray-400" data-target="vocab">
                <i class="fa-solid fa-book text-xl mb-0.5"></i><span class="text-[10px]">å–®å­—</span>
            </button>
            <button onclick="switchTab('settings')" class="nav-btn flex flex-col items-center w-16 gap-1 text-gray-400" data-target="settings">
                <i class="fa-solid fa-gear text-xl mb-0.5"></i><span class="text-[10px]">è¨­å®š</span>
            </button>
        </nav>
    </div>

    <script>
        // --- 1. STATE & DATA ---
        const state = {
            lang: localStorage.getItem('ml_lang') || 'en',
            level: localStorage.getItem('ml_level') || 'beginner',
            // API Key & Project ID stored in localStorage for convenience
            apiKey: localStorage.getItem('ml_api_key') || '',
            projectId: localStorage.getItem('ml_project_id') || '',
            vocab: JSON.parse(localStorage.getItem('ml_vocab') || '[]'),
            missionWords: [],
            currentSystemPrompt: ''
        };

        const levelStandards = {
            en: { beginner: 'A1-A2', intermediate: 'B1-B2', advanced: 'C1-C2' },
            jp: { beginner: 'N4-N5', intermediate: 'N2-N3', advanced: 'N1' },
            kr: { beginner: 'TOPIK 1-2', intermediate: 'TOPIK 3-4', advanced: 'TOPIK 5-6' }
        };

        const scenarios = {
            en: [{ id: 'cafe', title: 'Coffee Shop', userRole: 'Customer', aiRole: 'Barista', icon: 'fa-mug-hot', color: 'bg-orange-100 text-orange-600' }],
            jp: [{ id: 'izakaya', title: 'å±…é…’å±‹', userRole: 'å®¢', aiRole: 'åº—å“¡', icon: 'fa-beer-mug-empty', color: 'bg-yellow-100 text-yellow-700' }],
            kr: [{ id: 'taxi', title: 'è¨ˆç¨‹è»Š', userRole: 'ä¹˜å®¢', aiRole: 'å¸æ©Ÿ', icon: 'fa-taxi', color: 'bg-yellow-100 text-yellow-600' }]
        };

        // --- 2. THE VERIFIED API LOGIC (REPLACED) ---
        let cachedModel = null;

        async function callGemini(contents) {
            // A. Get values from DOM (Ensure inputs exist)
            const apiKeyInput = document.getElementById('api-key-input');
            const projectIdInput = document.getElementById('project-id-input');
            
            // Fallback to state/localStorage if input is empty (for UX)
            const apiKey = apiKeyInput.value.trim() || state.apiKey;
            const projectId = projectIdInput.value.trim() || state.projectId;

            if (!apiKey) throw new Error("è«‹è‡³è¨­å®šé è¼¸å…¥ API Key");
            if (!projectId) throw new Error("è«‹è‡³è¨­å®šé è¼¸å…¥ Project ID");

            // B. Prepare Headers (CRITICAL FIX)
            const headers = {
                'Content-Type': 'application/json',
                'X-Goog-User-Project': projectId // ğŸ‘ˆ çµ•å°ä¸èƒ½å°‘é€™è¡Œ
            };

            // C. Auto-Detect Model
            if (!cachedModel) {
                try {
                    document.getElementById('header-status').innerText = "Detecting Model...";
                    // GET Models with Headers
                    const listResponse = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`, 
                        { method: 'GET', headers: headers } 
                    );

                    if (!listResponse.ok) {
                        const err = await listResponse.json();
                        throw new Error(`é€£ç·šæ ¡é©—å¤±æ•— (${listResponse.status}): ${err.error?.message}`);
                    }

                    const listData = await listResponse.json();
                    // Find first model supporting content generation
                    const model = listData.models?.find(m => m.supportedGenerationMethods?.includes("generateContent"));
                    
                    if (!model) throw new Error("æ­¤ Key ç„¡å¯ç”¨æ¨¡å‹");
                    cachedModel = model.name.replace('models/', '');
                    console.log("è‡ªå‹•åŒ¹é…æ¨¡å‹:", cachedModel);
                    document.getElementById('header-status').innerText = "Model: " + cachedModel;

                } catch (e) {
                    throw new Error(`æ¨¡å‹åµæ¸¬å¤±æ•—: ${e.message} (è«‹æª¢æŸ¥ Project ID)`);
                }
            }

            // D. Send Chat Request
            const chatUrl = `https://generativelanguage.googleapis.com/v1beta/models/${cachedModel}:generateContent?key=${apiKey}`;
            
            // Wrapper for JSON Enforcement (App Requirement)
            const payload = {
                contents: contents,
                generationConfig: { response_mime_type: "application/json" } // Ensure App gets JSON for correction box
            };

            const response = await fetch(chatUrl, {
                method: 'POST',
                headers: headers, // ğŸ‘ˆ Header required here too
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            
            if (!response.ok) {
                // Retry logic for 404
                if (response.status === 404 && cachedModel !== 'gemini-pro') {
                    console.warn("404 ç™¼ç”Ÿï¼Œå˜—è©¦åˆ‡æ›è‡³ gemini-pro...");
                    cachedModel = 'gemini-pro';
                    return callGemini(contents); // Retry
                }
                throw new Error(data.error?.message || `API è«‹æ±‚å¤±æ•— (${response.status})`);
            }

            return data.candidates[0].content.parts[0].text;
        }

        // --- 3. UI LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            // Populate Inputs from LocalStorage
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('project-id-input').value = state.projectId;
            
            if(!state.apiKey) switchTab('settings');
            else {
                updateLevelLabels();
                renderHome();
            }
            
            // Auto-resize textarea
            const tx = document.getElementById('chat-input');
            tx.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; });
        });

        function switchTab(tabId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${tabId}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.dataset.target === tabId;
                btn.classList.toggle('active-nav', isActive);
                btn.classList.toggle('text-ios-blue', isActive);
                btn.classList.toggle('text-gray-400', !isActive);
            });
            if(tabId === 'learn') renderCourses();
        }

        function setLang(lang) { state.lang = lang; localStorage.setItem('ml_lang', lang); updateLevelLabels(); renderHome(); }
        function setLevel(lvl) { state.level = lvl; localStorage.setItem('ml_level', lvl); updateLevelLabels(); }

        function updateLevelLabels() {
            ['beginner', 'intermediate', 'advanced'].forEach(l => {
                const btn = document.querySelector(`.level-btn[onclick="setLevel('${l}')"]`);
                btn.classList.toggle('ring-2', state.level === l);
                btn.classList.toggle('ring-ios-blue', state.level === l);
                btn.classList.toggle('bg-blue-50', state.level === l);
            });
            document.querySelectorAll('.lang-btn').forEach(b => {
                b.classList.toggle('bg-white', b.dataset.lang === state.lang);
                b.classList.toggle('shadow-sm', b.dataset.lang === state.lang);
                b.classList.toggle('text-black', b.dataset.lang === state.lang);
            });
        }

        function renderHome() {
            const list = document.getElementById('scenario-list');
            list.innerHTML = '';
            (scenarios[state.lang] || scenarios['en']).forEach(s => {
                // FIXED: onClick calls startScenarioChat directly (No Modal)
                list.innerHTML += `
                    <div onclick="startScenarioChat('${s.id}')" class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 active:bg-gray-50 transition cursor-pointer">
                        <div class="h-12 w-12 rounded-full ${s.color} flex items-center justify-center text-xl shrink-0"><i class="fa-solid ${s.icon}"></i></div>
                        <div class="flex-1">
                            <h3 class="font-bold text-gray-800">${s.title}</h3>
                            <div class="text-[10px] text-gray-400 mt-1">Role: ${s.userRole} vs ${s.aiRole}</div>
                        </div>
                        <i class="fa-solid fa-chevron-right text-gray-300"></i>
                    </div>`;
            });
        }

        function renderCourses() { document.getElementById('course-list').innerHTML = '<div class="text-gray-400 text-center mt-10">èª²ç¨‹å…§å®¹ç¯„ä¾‹...</div>'; }

        // --- CHAT LOGIC MODIFIED ---

        function startFreeTalk() {
            initChat(`System: Free talk mode. Language: ${state.lang}. Level: ${state.level}.`, "Hello! I'm ready to chat.");
        }

        // NEW: Direct Start Function (Replaces Modal)
        function startScenarioChat(sid) {
            const s = (scenarios[state.lang] || scenarios['en']).find(x => x.id === sid);
            if (!s) return;
            initChat(
                `Roleplay Setup: Scenario: ${s.title}. User Role: ${s.userRole}. AI Role: ${s.aiRole}. Language: ${state.lang}. Level: ${state.level}.`, 
                `(Scene: ${s.title}) ${s.aiRole} is looking at you...`
            );
        }

        function initChat(sys, welcome) {
            switchTab('chat');
            document.getElementById('chat-container').innerHTML = '';
            // Generate simple missions for demo
            document.getElementById('mission-words').innerHTML = ['Hello', 'Please', 'Thanks'].map(w => `<span class="bg-white/50 px-1 rounded">${w}</span>`).join('');
            
            // App Requirement: Prompt for JSON
            state.currentSystemPrompt = sys + `
            IMPORTANT: You are a language tutor.
            OUTPUT FORMAT: JSON ONLY.
            Schema: { "reply": "string (target lang)", "correction": null OR { "original": "string", "fixed": "string", "reason": "string (in Traditional Chinese)" } }
            `;
            addBubble('ai', welcome, null);
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;

            addBubble('user', text);
            input.value = '';
            document.getElementById('typing-indicator').classList.remove('hidden');

            try {
                // Construct contents array for API
                const contents = [{ 
                    role: "user", 
                    parts: [{ text: state.currentSystemPrompt + "\n\nUser input: " + text }] 
                }];

                // CALL THE VERIFIED FUNCTION
                const rawJson = await callGemini(contents);
                
                // Parse the response (because app expects JSON)
                const aiJson = JSON.parse(rawJson);
                
                document.getElementById('typing-indicator').classList.add('hidden');
                addBubble('ai', aiJson.reply, aiJson.correction);
                
                if(window.speechSynthesis) {
                    const u = new SpeechSynthesisUtterance(aiJson.reply);
                    u.lang = state.lang === 'jp' ? 'ja-JP' : state.lang === 'kr' ? 'ko-KR' : 'en-US';
                    window.speechSynthesis.speak(u);
                }

            } catch(e) {
                document.getElementById('typing-indicator').classList.add('hidden');
                addBubble('ai', `âŒ éŒ¯èª¤: ${e.message}`);
                console.error(e);
            }
        }

        function addBubble(role, text, correction) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'}`;
            let html = '';
            if(correction) html += `<div class="correction-box"><div class="font-bold text-yellow-800 text-xs mb-1">ä¿®æ­£</div><div class="line-through text-gray-500 text-xs">${correction.original}</div><div class="text-green-700 font-bold text-sm">${correction.fixed}</div></div>`;
            html += `<div class="chat-bubble chat-${role}">${marked.parseInline(text)}</div>`;
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function saveSettings() {
            const k = document.getElementById('api-key-input').value.trim();
            const p = document.getElementById('project-id-input').value.trim();
            
            state.apiKey = k;
            state.projectId = p;
            
            localStorage.setItem('ml_api_key', k);
            localStorage.setItem('ml_project_id', p);
            
            // Clear cache to force re-check with new settings
            cachedModel = null; 
            
            alert("è¨­å®šå·²å„²å­˜");
        }

        function clearCache() {
            cachedModel = null;
            alert("æ¨¡å‹å¿«å–å·²æ¸…é™¤");
        }
    </script>
</body>
</html>